/*!
 * MintWaterfall v0.8.6
 * D3.js-compatible waterfall chart component
 * (c) 2024 David Duarte
 * Released under the MIT License
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).MintWaterfall={},t.d3)}(this,function(t,e){"use strict";function n(t){var e=Object.create(null);return t&&Object.keys(t).forEach(function(n){if("default"!==n){var a=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,a.get?a:{enumerable:!0,get:function(){return t[n]}})}}),e.default=t,Object.freeze(e)}var a=n(e);function r(){let t=[0,800];function e(e,n={}){const{range:r=t,nice:o=!0,tickFormat:i="auto"}=n,l=a.extent(e),s=a.scaleTime().domain(l).range(r);if(o&&s.nice(),"auto"===i&&l[0]&&l[1]&&l[0]instanceof Date&&l[1]instanceof Date){const t=(l[1].getTime()-l[0].getTime())/864e5;s.tickFormat=t<1?a.timeFormat("%H:%M"):t<30?a.timeFormat("%m/%d"):t<365?a.timeFormat("%b %Y"):a.timeFormat("%Y")}else"string"==typeof i&&(s.tickFormat=a.timeFormat(i));return s}function n(e,n={}){const{padding:r=.1,paddingInner:o=null,paddingOuter:i=null,align:l=.5,range:s=t}=n,c=[...new Set(e.map(String))],u=a.scaleBand().domain(c).range(s).align(l);return null!==o&&u.paddingInner(o),null!==i&&u.paddingOuter(i),null===o&&null===i&&u.padding(r),u}function r(e,n={}){const{range:r=t,nice:o=!0,zero:i=!1,clamp:l=!1}=n;let s=a.extent(e);i&&(s=[Math.min(0,s[0]),Math.max(0,s[1])]);const c=a.scaleLinear().domain(s).range(r);return o&&c.nice(),l&&c.clamp(!0),c}return{createAdaptiveScale:function(o,i="x"){const l=o.map(t=>"x"===i?t.label:t.cumulativeTotal);return l.every(t=>t instanceof Date)?e(l):l.every(t=>"string"==typeof t||isNaN(t))?n(l):l.every(t=>"number"==typeof t)?r(l):a.scaleBand().domain(l.map(String)).range(t)},createTimeScale:e,createOrdinalScale:function(t,e={}){const{range:n=a.schemeCategory10,unknown:r="#ccc"}=e,o=[...new Set(t)];return a.scaleOrdinal().domain(o).range(n).unknown(r)},createBandScale:n,createLinearScale:r,createLogScale:function(e,n={}){if(e.some(t=>t<=0))return r(e,n);const{range:o=t,nice:i=!0,clamp:l=!1}=n,s=a.extent(e),c=a.scaleLog().domain(s).range(o);return i&&c.nice(),l&&c.clamp(!0),c},setDefaultRange:function(e){t=e},getScaleInfo:function(t){const e={type:"unknown",domain:[],range:[]};try{e.domain=t.domain(),e.range=t.range(),"function"==typeof t.bandwidth?(e.type="band",e.bandwidth=t.bandwidth(),"function"==typeof t.step&&(e.step=t.step())):"function"==typeof t.nice?e.domain.length>0&&e.domain[0]instanceof Date?e.type="time":e.type="linear":"function"==typeof t.unknown&&(e.type="ordinal")}catch(t){console.warn("Could not extract complete scale info:",t)}return e},scaleUtils:o()}}function o(){return{formatTickValue:function(t,e){return"function"==typeof t.tickFormat?t.tickFormat()(e):t.tickFormat?t.tickFormat(e):"number"==typeof e?Math.abs(e)>=1e6?`${(e/1e6).toFixed(1)}M`:Math.abs(e)>=1e3?`${(e/1e3).toFixed(1)}K`:e.toFixed(0):String(e)},getTickCount:function(t,e){const n=t.range(),a=Math.abs(n[1]-n[0]),r=Math.max(2,Math.floor(a/75));return Math.min(10,Math.max(2,r))},createColorScale:function(t,e=a.schemeCategory10){return a.scaleOrdinal().domain(t).range([...e])},invertScale:function(t,e){if("function"==typeof t.invert)return t.invert(e);if("function"==typeof t.bandwidth){const n=t.domain(),a=t.bandwidth();t.step();for(let r=0;r<n.length;r++){const o=t(n[r]);if(e>=o&&e<=o+a)return n[r]}const r=n.map(n=>Math.abs(t(n)+a/2-e));return n[r.indexOf(Math.min(...r))]}},detectScaleType:function(t){return t.every(t=>t instanceof Date)?"time":t.every(t=>"string"==typeof t||isNaN(t))?"band":t.every(t=>"number"==typeof t)?"linear":"adaptive"},createAxis:function(t,e="bottom"){let n;switch(e){case"top":n=a.axisTop(t);break;case"bottom":default:n=a.axisBottom(t);break;case"left":n=a.axisLeft(t);break;case"right":n=a.axisRight(t)}return n}}}function i(){const t={enabled:!0,extent:[[0,0],[800,400]],handleSize:6,filter:null,touchable:!0,keyModifiers:!0,selection:{fill:"#007acc",fillOpacity:.3,stroke:"#007acc",strokeWidth:1,strokeDasharray:null},handles:{fill:"#fff",stroke:"#007acc",strokeWidth:1,size:6}};let e=null,n=null,r=null,o=[];const i=a.dispatch("brushstart","brush","brushend","clear");function l(t){const e=u(t.selection);n=e;const a={selection:e,sourceEvent:t.sourceEvent,type:"start"};i.call("brushstart",void 0,a)}function s(t){const e=u(t.selection);n=e;const a={selection:e,sourceEvent:t.sourceEvent,type:"brush"};i.call("brush",void 0,a)}function c(t){const e=u(t.selection);n=e;const a={selection:e,sourceEvent:t.sourceEvent,type:"end"};i.call("brushend",void 0,a)}function u(t){if(!t)return null;const[[e,n],[a,r]]=t;return{x:[Math.min(e,a),Math.max(e,a)],y:[Math.min(n,r),Math.max(n,r)]}}function d(){r&&(r.selectAll(".selection").style("fill",t.selection.fill).style("fill-opacity",t.selection.fillOpacity).style("stroke",t.selection.stroke).style("stroke-width",t.selection.strokeWidth),t.selection.strokeDasharray&&r.selectAll(".selection").style("stroke-dasharray",t.selection.strokeDasharray),r.selectAll(".handle").style("fill",t.handles.fill).style("stroke",t.handles.stroke).style("stroke-width",t.handles.strokeWidth))}const f={enable:function(){return t.enabled=!0,e&&r&&(r.call(e),d()),f},disable:function(){return t.enabled=!1,r&&r.on(".brush",null),f},attach:function(n){if(r=n,t.enabled){const r=e||(e=a.brush().extent(t.extent).handleSize(t.handleSize).touchable(t.touchable).keyModifiers(t.keyModifiers).on("start",l).on("brush",s).on("end",c),t.filter&&e.filter(t.filter),e);n.call(r),d()}return f},detach:function(){return r&&(r.on(".brush",null),r.selectAll(".brush").remove(),r=null),f},clear:function(){return r&&e&&(r.call(e.clear),n=null,i.call("clear",void 0,{selection:null,sourceEvent:null,type:"end"})),f},getSelection:function(){return n},setSelection:function(t){if(r&&e){if(t){const n=function(t){return[[t.x[0],t.y[0]],[t.x[1],t.y[1]]]}(t);r.call(e.move,n)}else r.call(e.clear);n=t}return f},getSelectedData:function(){return n?function(t){if(!t||0===o.length)return[];const[e,n]=t.x,[a,r]=t.y;return o.filter(t=>t.x>=e&&t.x<=n&&t.y>=a&&t.y<=r)}(n):[]},setData:function(t){return o=[...t],f},configure:function(n){const a=t.extent;return Object.assign(t,n),e&&(n.extent&&n.extent!==a&&e.extent(n.extent),void 0!==n.handleSize&&e.handleSize(n.handleSize),void 0!==n.touchable&&e.touchable(n.touchable),void 0!==n.keyModifiers&&e.keyModifiers(n.keyModifiers),void 0!==n.filter&&n.filter&&e.filter(n.filter)),r&&d(),f},setExtent:function(n){return t.extent=n,e&&e.extent(n),f},isEnabled:function(){return t.enabled},on:function(t,e){return i.on(t,e),f},off:function(t,e){return i.on(t,null),f}};return f}function l(){let t=-1,e=[],n=null,r=null;function o(n,r,o){switch(n.key){case"Tab":break;case"ArrowRight":case"ArrowDown":n.preventDefault(),l(1,r,o);break;case"ArrowLeft":case"ArrowUp":n.preventDefault(),l(-1,r,o);break;case"Home":n.preventDefault(),s(0,r,o);break;case"End":n.preventDefault(),s(e.length-1,r,o);break;case"Enter":case" ":n.preventDefault(),t>=0?c(r[t],t,o):function(t,e){const n=e.formatNumber||(t=>t.toString()),a=t.reduce((t,e)=>t+e.stacks.reduce((t,e)=>t+e.value,0),0),r=`Waterfall chart with ${t.length} categories. Total value: ${n(a)}. Use arrow keys to navigate between bars.`;u(r)}(r,o);break;case"Escape":n.preventDefault(),function(){const e=a.select("svg[role='img']");if(!e.empty()){const n=e.node();n&&n.focus(),t=-1}}()}}function i(t,e,n,r,o){switch(t.key){case"Enter":case" ":t.preventDefault(),c(e,n,o),a.select(t.target).dispatch("click");break;case"ArrowRight":case"ArrowDown":t.preventDefault(),l(1,r,o);break;case"ArrowLeft":case"ArrowUp":t.preventDefault(),l(-1,r,o)}}function l(n,a,r){if(0===e.length)return;let o=t+n;o>=e.length?o=0:o<0&&(o=e.length-1),s(o,a,r)}function s(n,a,r){if(n<0||n>=e.length)return;t=n;const o=e[n];o&&o.focus&&o.focus();!function(t,e,n){const a=n.formatNumber||(t=>t.toString()),r=t.stacks.reduce((t,e)=>t+e.value,0),o=`Focused on ${t.label}, value ${a(r)}`;u(o)}(a[n],0,r)}function c(t,e,n){const a=n.formatNumber||(t=>t.toString()),r=t.stacks.reduce((t,e)=>t+e.value,0);let o=`${t.label}: Total value ${a(r)}`;if(t.stacks.length>1){o+=`. Contains ${t.stacks.length} segments: `;o+=t.stacks.map(t=>`${t.label||a(t.value)}`).join(", ")}void 0!==t.cumulative&&(o+=`. Cumulative total: ${a(t.cumulative)}`),u(o)}function u(t){const e=a.select("#waterfall-live-region");e.empty()||e.text(t),n&&n(t)}function d(){if(window.matchMedia){if(window.matchMedia("(forced-colors: active)").matches)return!0;if(window.matchMedia("(prefers-contrast: high)").matches)return!0;if(window.matchMedia("(prefers-contrast: more)").matches)return!0;if(window.matchMedia("(inverted-colors: inverted)").matches)return!0;try{const t=document.createElement("div");t.style.color="rgb(1, 2, 3)",t.style.position="absolute",t.style.visibility="hidden",document.body.appendChild(t);const e=window.getComputedStyle(t).color;return document.body.removeChild(t),"rgb(1, 2, 3)"!==e}catch(t){return!1}}return!1}function f(){return!!window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches}return{createLiveRegion:function(t){return t.append("div").attr("id","waterfall-live-region").attr("aria-live","polite").attr("aria-atomic","true").style("position","absolute").style("left","-10000px").style("width","1px").style("height","1px").style("overflow","hidden")},createChartDescription:function(t,e,n={}){const{title:a="Waterfall Chart",summary:o="Interactive waterfall chart showing data progression",totalItems:i=(Array.isArray(e)?e.length:1),showTotal:l=!1}=n,s="waterfall-description-"+Math.random().toString(36).substr(2,9),c=t.append("div").attr("id",s).attr("class","sr-only").style("position","absolute").style("left","-10000px").style("width","1px").style("height","1px").style("overflow","hidden");let u=0,d=0,f=0;if(Array.isArray(e))u=e.reduce((t,e)=>e.stacks&&Array.isArray(e.stacks)?t+e.stacks.reduce((t,e)=>t+(e.value||0),0):t,0),d=e.filter(t=>t.stacks&&t.stacks.some(t=>(t.value||0)>0)).length,f=e.filter(t=>t.stacks&&t.stacks.some(t=>t.value<0)).length;else if(e&&"object"==typeof e&&e.children){function m(t){return t.children&&Array.isArray(t.children)?t.children.reduce((t,e)=>t+m(e),0):t.value||0}u=m(e),d=1,f=0}return c.html(`\n            <h3>${a}</h3>\n            <p>${o}</p>\n            <p>This chart contains ${i} data categories${l?" plus a total bar":""}.</p>\n            <p>Total value: ${n.formatNumber?n.formatNumber(u):u}</p>\n            <p>${d} categories have positive values, ${f} have negative values.</p>\n            <p>Use Tab to navigate between bars, Enter to hear details, and Arrow keys to move between bars.</p>\n            <p>Press Escape to return focus to the chart container.</p>\n        `),r=s,s},makeAccessible:function(n,l,s={}){const c=n.select("svg");c.attr("role","img").attr("aria-labelledby",r).attr("tabindex","0").attr("aria-describedby",r),c.on("keydown",function(t){o(t,l,s)});const u=c.selectAll(".bar-group");return u.each(function(e,n){const r=a.select(this),o=e;r.attr("role","button").attr("tabindex","-1").attr("aria-label",function(t,e,n={}){const a=t.stacks.reduce((t,e)=>t+e.value,0),r=t.stacks.length,o=n.formatNumber||(t=>t.toString());let i=`${t.label}: ${o(a)}`;r>1&&(i+=`, ${r} segments`);void 0!==t.cumulative&&(i+=`, cumulative total: ${o(t.cumulative)}`);return i+=". Press Enter for details.",i}(o,0,s)).attr("aria-describedby",`bar-description-${n}`).on("keydown",function(t){i(t,o,n,[o],s)}).on("focus",function(){t=n;const e=this;e&&function(t){a.select(t).style("outline","3px solid #4A90E2").style("outline-offset","2px")}(e)}).on("blur",function(){const t=this;t&&function(t){a.select(t).style("outline",null).style("outline-offset",null)}(t)})}),e=u.nodes().filter(t=>null!==t),{bars:u,focusableElements:e.length}},handleChartKeydown:o,handleBarKeydown:i,moveFocus:l,focusElement:s,announce:u,detectHighContrast:d,applyHighContrastStyles:function(t){if(!d())return;const e=t.select("svg");e.selectAll(".bar-group rect").style("stroke","CanvasText").style("stroke-width","2px").style("fill","ButtonFace"),e.selectAll(".x-axis, .y-axis").style("stroke","CanvasText").style("stroke-width","2px"),e.selectAll("text").style("fill","CanvasText").style("font-weight","bold"),e.selectAll(".trend-line").style("stroke","Highlight").style("stroke-width","3px"),e.selectAll(".tooltip").style("background","Canvas").style("border","2px solid CanvasText").style("color","CanvasText")},injectForcedColorsCSS:function(){if("undefined"==typeof document)return;const t="mintwaterfall-forced-colors-css";if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.textContent="\n            @media (forced-colors: active) {\n                .mintwaterfall-chart svg {\n                    forced-color-adjust: none;\n                }\n                \n                .mintwaterfall-chart .bar-group rect {\n                    stroke: CanvasText !important;\n                    stroke-width: 2px !important;\n                }\n                \n                .mintwaterfall-chart .x-axis,\n                .mintwaterfall-chart .y-axis {\n                    stroke: CanvasText !important;\n                    stroke-width: 2px !important;\n                }\n                \n                .mintwaterfall-chart text {\n                    fill: CanvasText !important;\n                    font-weight: bold !important;\n                }\n                \n                .mintwaterfall-chart .trend-line {\n                    stroke: Highlight !important;\n                    stroke-width: 3px !important;\n                }\n                \n                .mintwaterfall-tooltip {\n                    background: Canvas !important;\n                    border: 2px solid CanvasText !important;\n                    color: CanvasText !important;\n                    forced-color-adjust: none;\n                }\n            }\n            \n            @media (prefers-contrast: high) {\n                .mintwaterfall-chart .bar-group rect {\n                    stroke-width: 2px !important;\n                }\n                \n                .mintwaterfall-chart text {\n                    font-weight: bold !important;\n                }\n            }\n        ",document.head.appendChild(e)},respectsReducedMotion:f,getAccessibleAnimationDuration:function(t){return f()?0:t},validateColorContrast:function(t,e){const n=t=>{const e=a.rgb(t);return(.299*e.r+.587*e.g+.114*e.b)/255},r=n(t),o=n(e),i=(Math.max(r,o)+.05)/(Math.min(r,o)+.05);return{ratio:i,passesAA:i>=4.5,passesAAA:i>=7}},setAnnounceFunction(t){return n=t,this},getCurrentFocus:()=>t,getFocusableCount:()=>e.length}}const s=l();function c(){let t=null,e=null,n={className:"mintwaterfall-tooltip",theme:"default",position:"smart",offset:{x:10,y:-10},animation:{duration:200,easing:"ease-out"},collision:{boundary:"viewport",flip:!0,shift:!0},content:{maxWidth:300,padding:12}};function r(e){if(!t)return;const a={default:{background:"rgba(0, 0, 0, 0.9)",color:"#ffffff",border:"none",borderRadius:"6px",fontSize:"13px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.3)",maxWidth:`${n.content.maxWidth}px`,padding:`${n.content.padding}px`},light:{background:"rgba(255, 255, 255, 0.95)",color:"#333333",border:"1px solid rgba(0, 0, 0, 0.1)",borderRadius:"6px",fontSize:"13px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",maxWidth:`${n.content.maxWidth}px`,padding:`${n.content.padding}px`},minimal:{background:"#333333",color:"#ffffff",border:"none",borderRadius:"3px",fontSize:"12px",fontFamily:"monospace",boxShadow:"none",maxWidth:`${n.content.maxWidth}px`,padding:"8px 10px"},corporate:{background:"#2c3e50",color:"#ecf0f1",border:"1px solid #34495e",borderRadius:"4px",fontSize:"13px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.2)",maxWidth:`${n.content.maxWidth}px`,padding:`${n.content.padding}px`}},r=a[e]||a.default;Object.keys(r).forEach(e=>{const n=e.replace(/([A-Z])/g,"-$1").toLowerCase(),a=r[e];t.style(n,a)})}function o(e){if(!t)return;const a=e,r=t.node();if(!r)return;const o=r.getBoundingClientRect(),i=window.innerWidth,l=window.innerHeight;let s=a.pageX+n.offset.x,c=a.pageY+n.offset.y;if("smart"===n.position){const t=function(t,e,a){const r=10;let o=t.x+n.offset.x,i=t.y+n.offset.y,l=1;o+e.width+r>a.width&&(o=t.x-e.width-Math.abs(n.offset.x),l=2);i+e.height+r>a.height&&(i=t.y-e.height-Math.abs(n.offset.y),l=2===l?3:4);o<r&&(o=r);i<r&&(i=r);return{x:o,y:i,quadrant:l}}({x:a.clientX,y:a.clientY},{width:o.width,height:o.height},{width:i,height:l});s=t.x+window.pageXOffset,c=t.y+window.pageYOffset}t.style("left",`${s}px`).style("top",`${c}px`)}const i={show:function(i,l,s=null){t||t||(t=a.select("body").append("div").attr("class",n.className).style("position","absolute").style("visibility","hidden").style("pointer-events","none").style("z-index","9999").style("opacity","0").style("transition",`opacity ${n.animation.duration}ms ${n.animation.easing}`),r(n.theme));const c=function(t,e){if("function"==typeof t)return t(e);if("string"==typeof t)return t;if("object"==typeof t&&t&&"template"in t)return function(t,e,n={}){if(!e)return t;let a=t;return a=a.replace(/\{\{(\w+(?:\.\w+)*)\}\}/g,(t,a)=>{const r=(o=e,a.split(".").reduce((t,e)=>t?.[e],o));var o;const i=n[a];return i&&"function"==typeof i?i(r):null!=r?String(r):""}),a}(t.template,e,t.formatters);if(e)return function(t){const e=n.formatNumber||(t=>t.toLocaleString());let a=`<div class="tooltip-header"><strong>${t.label}</strong></div>`;if(t.stacks&&t.stacks.length>0){const n=t.stacks.reduce((t,e)=>t+e.value,0);a+=`<div class="tooltip-total">Total: ${e(n)}</div>`,t.stacks.length>1&&(a+='<div class="tooltip-stacks">',t.stacks.forEach(t=>{const n=t.color||"#666",r=t.label||e(t.value);a+=`\n                        <div class="tooltip-stack-item">\n                            <span class="tooltip-color-indicator" style="background-color: ${n}"></span>\n                            <span class="tooltip-stack-label">${r}</span>\n                            <span class="tooltip-stack-value">${e(t.value)}</span>\n                        </div>\n                    `}),a+="</div>")}return a}(e);return""}(i,s);return t.html(c).style("visibility","visible"),o(l),t.transition().duration(n.animation.duration).style("opacity","1"),e={content:i,event:l,data:s},t},hide:function(){if(t)return t.transition().duration(n.animation.duration).style("opacity","0").on("end",function(){a.select(this).style("visibility","hidden")}),e=null,t},move:function(n){if(t&&e)return o(n),t},theme:function(e){return n.theme=e,t&&r(e),i},configure:function(e){return n={...n,...e},t&&e.theme&&r(e.theme),i},destroy:function(){t&&(t.remove(),t=null),e=null},isVisible:function(){return null!==t&&"visible"===t.style("visibility")},getCurrentData:function(){return e?.data||null}};return i}function u(){const t={enabled:!0,scaleExtent:[.1,10],translateExtent:null,wheelDelta:null,touchable:!0,filter:null,constrain:{x:!0,y:!0},duration:250,ease:a.easeQuadOut};let e=null,n=a.zoomIdentity,r=null,o={width:800,height:400,margin:{top:60,right:80,bottom:60,left:80}};const i=a.dispatch("zoomstart","zoom","zoomend","reset");function l(){return e||(e=a.zoom().scaleExtent(t.scaleExtent).touchable(t.touchable).filter(t.filter||s).on("start",u).on("zoom",d).on("end",f),null!==t.wheelDelta&&e.wheelDelta(t.wheelDelta),c(),e)}function s(t){return!(t.ctrlKey&&"wheel"!==t.type||t.button)}function c(){if(!e||!o)return;const{width:n,height:a,margin:r}=o,i=n-r.left-r.right,l=a-r.top-r.bottom,s=t.translateExtent||[[2*-i,2*-l],[3*i,3*l]];e.translateExtent(s)}function u(t){const e={transform:t.transform,sourceEvent:t.sourceEvent};i.call("zoomstart",void 0,e)}function d(e){n=e.transform,t.constrain.x||(n=n.translate(-n.x,0)),t.constrain.y||(n=n.translate(0,-n.y)),r&&function(e,n){const r=e.select(".chart-group");r.empty()||r.attr("transform",n.toString());!function(e,n){if(t.constrain.x){const t=e.select(".x-axis");if(!t.empty()){const e=m(t);if(e){const r=n.rescaleX(e);t.call(a.axisBottom(r))}}}if(t.constrain.y){const t=e.select(".y-axis");if(!t.empty()){const e=m(t);if(e){const r=n.rescaleY(e);t.call(a.axisLeft(r))}}}}(e,n)}(r,n);const o={transform:n,sourceEvent:e.sourceEvent};i.call("zoom",void 0,o)}function f(t){const e={transform:t.transform,sourceEvent:t.sourceEvent};i.call("zoomend",void 0,e)}function m(t){try{const e=t.node();if(e&&e.__scale__)return e.__scale__}catch(t){}return null}function h(n,a,r=0){return e||l(),r>0?n.transition().duration(r).ease(t.ease).call(e.transform,a):n.call(e.transform,a),p}const p={enable:function(){return t.enabled=!0,e&&r&&r.call(e),p},disable:function(){return t.enabled=!1,r&&r.on(".zoom",null),p},attach:function(e){if(r=e,t.enabled){const t=l();e.call(t)}return p},detach:function(){return r&&(r.on(".zoom",null),r=null),p},transform:h,reset:function(e=t.duration){return r&&(h(r,a.zoomIdentity,e),i.call("reset",void 0,{transform:a.zoomIdentity,sourceEvent:null})),p},zoomTo:function(e,n=t.duration){if(!r||!o)return p;const{width:i,height:l,margin:s}=o,c=i-s.left-s.right,u=l-s.top-s.bottom,[d,f]=e.x,[m,g]=e.y,y=Math.min(c/(f-d),u/(g-m)),b=c/2-y*(d+f)/2,v=u/2-y*(m+g)/2,w=a.zoomIdentity.translate(b,v).scale(y);return h(r,w,n),p},setDimensions:function(t){return o=t,c(),p},configure:function(n){return Object.assign(t,n),e&&(n.scaleExtent&&e.scaleExtent(n.scaleExtent),void 0!==n.touchable&&e.touchable(n.touchable),void 0!==n.filter&&e.filter(n.filter||s),void 0!==n.wheelDelta&&n.wheelDelta&&e.wheelDelta(n.wheelDelta)),c(),p},getCurrentTransform:function(){return n},isEnabled:function(){return t.enabled},on:function(t,e){return i.on(t,e),p},off:function(t,e){return i.on(t,null),p}};return p}function d(){let t={renderTime:0,dataProcessingTime:0,memoryUsage:0,visibleElements:0,totalElements:0,fps:0,lastFrameTime:0,averageFrameTime:0,peakMemoryUsage:0,renderCalls:0},e={enabled:!1,chunkSize:1e3,renderThreshold:1e4,bufferSize:200,preloadCount:3,recycleNodes:!0},n={memoryPooling:!0},a={elements:new Map,maxSize:1e3,currentSize:0,hitCount:0,missCount:0},r=new Map,o=null,i=0,l=performance.now();function s(){if("memory"in performance){const e=performance.memory;t.memoryUsage=e.usedJSHeapSize,t.peakMemoryUsage=Math.max(t.peakMemoryUsage,e.usedJSHeapSize)}return{...t}}function c(){if(!o)return;const t=s(),n=(t.memoryUsage/1024/1024).toFixed(2),r=(t.peakMemoryUsage/1024/1024).toFixed(2);o.innerHTML=`\n            <div><strong>MintWaterfall Performance</strong></div>\n            <div>FPS: ${t.fps}</div>\n            <div>Render Time: ${t.renderTime.toFixed(2)}ms</div>\n            <div>Memory: ${n}MB (Peak: ${r}MB)</div>\n            <div>Visible Elements: ${t.visibleElements}/${t.totalElements}</div>\n            <div>Render Calls: ${t.renderCalls}</div>\n            <div>Virtualization: ${e.enabled?"ON":"OFF"}</div>\n            <div>Pool Hit Rate: ${a.hitCount+a.missCount>0?(a.hitCount/(a.hitCount+a.missCount)*100).toFixed(1):0}%</div>\n        `}const u={enableVirtualization:function(t={}){return Object.assign(e,t),e.enabled=!0,console.log("MintWaterfall: Virtualization enabled with config:",e),u},disableVirtualization:function(){return e.enabled=!1,console.log("MintWaterfall: Virtualization disabled"),u},optimizeRendering:function(n,a){const r=performance.now();t.totalElements=a.length,e.enabled&&a.length>e.renderThreshold?function(n,a){const r=n.node();if(!r)return;const o=r.clientHeight,i=r.scrollTop||0,l=30,[s,c]=function(t,n,a){const r=Math.floor(t/a),o=r+Math.ceil(n/a);return[Math.max(0,r-e.bufferSize),o+e.bufferSize]}(i,o,l),u=a.slice(s,Math.min(c,a.length));u.map((t,e)=>e+s),t.visibleElements=u.length;const d=n.selectAll(".virtual-item").data(u,(t,e)=>`item-${e+s}`);d.exit().remove();const f=d.enter().append("g").attr("class","virtual-item");d.merge(f).attr("transform",(t,e)=>`translate(0, ${(e+s)*l})`)}(n,a):function(e,n){t.visibleElements=n.length;const a=e.selectAll(".chart-element").data(n);a.exit().remove();const r=a.enter().append("g").attr("class","chart-element");a.merge(r)}(n,a);const o=performance.now();return t.renderTime=o-r,t.renderCalls++,function(){i++;const e=performance.now();e-l>=1e3&&(t.fps=Math.round(1e3*i/(e-l)),t.averageFrameTime=(e-l)/i,i=0,l=e);t.lastFrameTime=e}(),u},profileOperation:function(t,e){const n=performance.now(),a=e(),o=performance.now()-n;r.has(t)||r.set(t,{startTime:0,endTime:0,samples:[],averageTime:0,minTime:1/0,maxTime:0});const i=r.get(t);return i.samples.push(o),i.minTime=Math.min(i.minTime,o),i.maxTime=Math.max(i.maxTime,o),i.averageTime=i.samples.reduce((t,e)=>t+e,0)/i.samples.length,i.samples.length>100&&i.samples.shift(),a},getMetrics:s,resetMetrics:function(){return t={renderTime:0,dataProcessingTime:0,memoryUsage:0,visibleElements:0,totalElements:0,fps:0,lastFrameTime:0,averageFrameTime:0,peakMemoryUsage:0,renderCalls:0},r.clear(),i=0,l=performance.now(),u},enableMemoryPooling:function(t={}){return Object.assign(a,t),n.memoryPooling=!0,console.log("MintWaterfall: Memory pooling enabled"),u},createRenderBatch:function(){return{operations:[],priority:1,timestamp:performance.now(),elementCount:0}},flushRenderBatch:function(e){const n=performance.now();e.operations.sort((t,e)=>{const n=["remove","create","update","style","attribute"];return n.indexOf(t.type)-n.indexOf(e.type)}),e.operations.forEach(t=>{!function(t){const{type:e,element:n,properties:a}=t;switch(e){case"create":case"update":break;case"remove":n&&n.remove&&n.remove();break;case"style":n&&a&&Object.keys(a).forEach(t=>{n.style(t,a[t])});break;case"attribute":n&&a&&Object.keys(a).forEach(t=>{n.attr(t,a[t])})}}(t)});const a=performance.now();return t.renderTime+=a-n,u},setUpdateStrategy:function(t){return console.log(`MintWaterfall: Update strategy set to ${t}`),u},getDashboard:function(){return o},enableDashboard:function(t){o||(o=function(){const t=document.createElement("div");return t.className="mintwaterfall-performance-dashboard",t.style.cssText="\n            position: fixed;\n            top: 10px;\n            right: 10px;\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 10px;\n            border-radius: 5px;\n            font-family: monospace;\n            font-size: 12px;\n            z-index: 10000;\n            max-width: 300px;\n        ",t}());const e=t||document.body;return e&&!e.contains(o)&&e.appendChild(o),setInterval(c,500),u},disableDashboard:function(){return o&&o.parentNode&&(o.parentNode.removeChild(o),o=null),u},optimizeMemory:function(){return window.gc&&window.gc(),a.elements.forEach((t,e)=>{t.length>50&&t.splice(25)}),r.forEach(t=>{t.samples.length>50&&t.samples.splice(0,t.samples.length-50)}),console.log("MintWaterfall: Memory optimization completed"),u},getRecommendations:function(){const t=[],r=s();return r.totalElements>5e3&&!e.enabled&&t.push("Enable virtualization for improved performance with large datasets"),r.fps<30&&t.push("Consider reducing visual complexity or enabling performance optimizations"),r.memoryUsage>104857600&&t.push("Memory usage is high - consider enabling memory pooling or reducing data size"),r.renderTime>100&&t.push("Render time is slow - consider batching updates or optimizing render operations"),a.hitCount/(a.hitCount+a.missCount||1)<.5&&n.memoryPooling&&t.push("Memory pool efficiency is low - consider adjusting pool size or strategy"),t}};return u}function f(t,e,n){if(t.bandwidth){const e=t.bandwidth();return console.log("Using band scale bandwidth:",e),e}{const t=n*(1-.1)/e;return console.log("Calculated width for continuous scale:",t),t}}function m(t,e,n){return t.bandwidth?t(e):t(e)-n/2}function h(){let t=800,e=400,n={top:60,right:80,bottom:60,left:80},o=!1,l="Total",s="#95A5A6",h=!0,p=.05,g=750,y=a.easeQuadInOut,b=a.format(".0f"),v=null,w=!1,x={},k=!1,M=100,A="auto",T=!1,S="#e74c3c",E=2,C="solid",$=.8,D="linear",z=3,O=2,F=!0,I=!1,j={},L=!0,R={},P=!1,W={},B=null,U=new Map,N=null,V=null;const q=r();i();const Q=c();u();const Y=d();let H=!1,G=!1,_=1e4;const X=a.dispatch("barClick","barMouseover","barMouseout","chartUpdate","brushSelection");function K(r){r.each(function(r){if(!r||!Array.isArray(r))return void console.warn("MintWaterfall: Invalid data provided. Expected an array.");if(0===r.length)return void console.warn("MintWaterfall: Empty data array provided.");if(!r.every(t=>t&&"string"==typeof t.label&&Array.isArray(t.stacks)&&t.stacks.every(t=>"number"==typeof t.value&&"string"==typeof t.color)))return void console.error("MintWaterfall: Invalid data structure. Each item must have a 'label' string and 'stacks' array with 'value' numbers and 'color' strings.");const i=a.select(this),l=i.node();if(l){const n=l.getAttribute("width"),a=l.getAttribute("height");n&&(t=parseInt(n,10)),a&&(e=parseInt(a,10))}console.log("Chart dimensions:",{width:t,height:e});const s=i.selectAll(".waterfall-container").data([r]),c=i,d=s.enter().append("g").attr("class","waterfall-container").merge(s);let v=d.select(".chart-group");v.empty()&&(v=d.append("g").attr("class","chart-group"));const w=`chart-clip-${Date.now()}`;i.select(`#${w}`).remove();const x=i.append("defs").append("clipPath").attr("id",w).append("rect");v.attr("clip-path",`url(#${w})`);try{r.length>=_&&H&&Y.enableVirtualization({chunkSize:Math.min(1e3,Math.floor(r.length/10)),renderThreshold:_});const l=JSON.stringify(r).slice(0,100)+`_showTotal:${o}`;let s;l===N&&V?(s=V,console.log("MintWaterfall: Using cached processed data")):(r.length>5e4?(console.warn("MintWaterfall: Large dataset detected, using synchronous processing"),s=J(r)):s=J(r),N=l,V=s),console.log("🔧 processedData in chart:",s.map(t=>({label:t.label,barTotal:t.barTotal,cumulativeTotal:t.cumulativeTotal,stackCount:t.stacks?.length})));const w=function(t,n){const r=t.flatMap(t=>[t.cumulativeTotal,t.prevCumulativeTotal||0]),o=a.max(r)||0,i=a.min(r)||0,l=16,s=8,c=l+s,u=20,d=i<0,f=Math.max(n.top,80);let m;const h=[e-n.bottom,f];if(d){const t=.05*(o-i);m=a.scaleLinear().domain([i-t,o+t]).range(h)}else{const t=1.02*o;m=a.scaleLinear().domain([0,t]).range(h).nice()}const p=t.map(t=>m(t.cumulativeTotal)-s),g=Math.min(...p),y=Math.max(f-g+c,c+u),v=Math.max(0,y-f);let w=0;if(d){const a=t.filter(t=>t.cumulativeTotal<0);if(a.length>0){const t=Math.max(...a.map(t=>m(t.cumulativeTotal)+l+s));t>e-n.bottom&&(w=t-(e-n.bottom))}}const x=Math.max(...t.map(t=>b(t.cumulativeTotal).length)),k=9*x,M=Math.max(n.right,k/2+15),A={top:f+v+u,right:M,bottom:n.bottom+w+(d?u:10),left:n.left};return console.log("🔧 Intelligent margins calculated:",{original:n,calculated:A,highestLabelPosition:g,spaceNeededFromTop:y,extraTopMarginNeeded:v}),A}(s,n);let L;if("auto"===A)L=q.createAdaptiveScale(s,"x"),L.padding&&L.padding(p);else if("time"===A){const t=s.map(t=>new Date(t.label));L=q.createTimeScale(t)}else L="ordinal"===A?q.createOrdinalScale(s.map(t=>t.label)):a.scaleBand().domain(s.map(t=>t.label)).padding(p);L.range([w.left,t-w.right]),q.setDefaultRange([w.left,t-w.right]);const R=30;x.attr("x",w.left).attr("y",Math.max(0,w.top-R)).attr("width",t-w.left-w.right).attr("height",e-w.top-w.bottom+R),console.log("🔧 Clipping path set:",{x:w.left,y:Math.max(0,w.top-R),width:t-w.left-w.right,height:e-w.top-w.bottom+R}),console.log("Scale setup:",{domain:L.domain(),range:L.range(),intelligentMargins:w,bandwidth:L.bandwidth?L.bandwidth():"N/A"});const W=s.map(t=>t.cumulativeTotal),[B,U]=a.extent(W);let G;if(B<0){const t=.05*(U-B);G=a.scaleLinear().domain([B-t,U+t]).range([e-w.bottom,w.top])}else G=q.createLinearScale(W,{range:[e-w.bottom,w.top],nice:!0});!function(e,n,a){const r=e.selectAll(".grid-group").data([0]),o=r.enter().append("g").attr("class","grid-group").merge(r),i=n.ticks(),l=o.selectAll(".grid-line").data(i),s=l.enter().append("line").attr("class","grid-line").attr("x1",a.left).attr("x2",t-a.right).attr("stroke","rgba(224, 224, 224, 0.5)").attr("stroke-width",1).style("opacity",0);s.merge(l).transition().duration(g).ease(y).attr("y1",t=>n(t)).attr("y2",t=>n(t)).attr("x1",a.left).attr("x2",t-a.right).style("opacity",1),l.exit().transition().duration(g).ease(y).style("opacity",0).remove()}(d,G,w),function(t,n,r,o){const i=t.selectAll(".y-axis").data([0]),l=i.enter().append("g").attr("class","y-axis").attr("transform",`translate(${o.left},0)`);l.merge(i).transition().duration(g).ease(y).call(a.axisLeft(r).tickFormat(t=>b(t)));const s=t.selectAll(".x-axis").data([0]),c=s.enter().append("g").attr("class","x-axis").attr("transform",`translate(0,${e-o.bottom})`);c.merge(s).transition().duration(g).ease(y).call(a.axisBottom(n))}(d,L,G,w),function(e,n,r,o,i){const l=e.selectAll(".bars-group").data([0]),s=l.enter().append("g").attr("class","bars-group"),c=s.merge(l).selectAll(".bar-group").data(n,t=>t.label),u=c.enter().append("g").attr("class","bar-group").attr("transform",e=>{if(r.bandwidth)return`translate(${r(e.label)}, 0)`;{const a=f(r,n.length,t-i.left-i.right);return`translate(${m(r,e.label,a)}, 0)`}}),d=u.merge(c).transition().duration(g).ease(y).attr("transform",e=>{if(r.bandwidth)return`translate(${r(e.label)}, 0)`;{const a=f(r,n.length,t-i.left-i.right);return`translate(${m(r,e.label,a)}, 0)`}});h?function(e,n,r,o){e.each(function(i){const l=a.select(this),s=i.stacks.map((t,e)=>({...t,stackIndex:e,parent:i}));let c=i.prevCumulativeTotal||0;s.forEach(t=>{t.startY=c,t.endY=c+t.value,t.y=r(Math.max(t.startY,t.endY)),t.height=Math.abs(r(t.startY)-r(t.endY)),c+=t.value});const u=l.selectAll(".stack").data(s),d=n.bandwidth?n.bandwidth():f(n,e.size(),t-o.left-o.right);u.enter().append("rect").attr("class","stack").attr("x",0).attr("width",d).attr("y",r(0)).attr("height",0).attr("fill",t=>t.color).merge(u).transition().duration(g).ease(y).attr("y",t=>t.y).attr("height",t=>t.height).attr("fill",t=>t.color).attr("width",d),u.exit().transition().duration(g).ease(y).attr("height",0).attr("y",r(0)).remove();const m=l.selectAll(".stack-label").data(s.filter(t=>t.label));m.enter().append("text").attr("class","stack-label").attr("text-anchor","middle").attr("x",d/2).attr("y",r(0)).style("opacity",0).merge(m).transition().duration(g).ease(y).attr("y",t=>t.y+t.height/2+4).attr("x",d/2).style("opacity",1).text(t=>t.label),m.exit().transition().duration(g).ease(y).style("opacity",0).remove()})}(d,r,o,i):function(e,n,r,o){e.each(function(i){const l=a.select(this),s=n.bandwidth?n.bandwidth():f(n,e.size(),t-o.left-o.right),c=[{value:i.barTotal,color:1===i.stacks.length?i.stacks[0].color:"#3498db",y:i.isTotal?Math.min(r(0),r(i.cumulativeTotal)):r(Math.max(i.prevCumulativeTotal,i.cumulativeTotal)),height:i.isTotal?Math.abs(r(0)-r(i.cumulativeTotal)):Math.abs(r(i.prevCumulativeTotal||0)-r(i.cumulativeTotal)),parent:i}],u=l.selectAll(".waterfall-bar").data(c);u.enter().append("rect").attr("class","waterfall-bar").attr("x",0).attr("width",s).attr("y",r(0)).attr("height",0).attr("fill",t=>t.color).merge(u).transition().duration(g).ease(y).attr("y",t=>t.y).attr("height",t=>t.height).attr("fill",t=>t.color).attr("width",s),u.exit().transition().duration(g).ease(y).attr("height",0).attr("y",r(0)).remove()})}(d,r,o,i);(function(e,n,r,o){console.log("🏷️ Drawing value labels, barGroups size:",e.size()),e.each(function(i){const l=a.select(this),s=f(n,e.size(),t-o.left-o.right);console.log("🏷️ Processing label for:",i.label,"barTotal:",i.barTotal,"cumulativeTotal:",i.cumulativeTotal);const c=[{value:i.barTotal,formattedValue:b(i.barTotal),parent:i}],u=l.selectAll(".total-label").data(c);u.enter().append("text").attr("class","total-label").attr("text-anchor","middle").attr("x",s/2).attr("y",r(0)).style("opacity",0).style("font-family","Arial, sans-serif").merge(u).transition().duration(g).ease(y).attr("y",t=>{const e=r(t.parent.cumulativeTotal),n=e-8;return console.log("🏷️ Label positioning:",{label:t.parent.label,cumulativeTotal:t.parent.cumulativeTotal,barTop:e,finalY:n,formattedValue:t.formattedValue}),n}).attr("x",s/2).style("opacity",1).style("fill","#333").style("font-weight","bold").style("font-size","14px").style("pointer-events","none").style("visibility","visible").style("display","block").attr("clip-path","none").text(t=>t.formattedValue).each(function(t){const e=a.select(this);console.log("🏷️ Label element created:",{text:t.formattedValue,x:e.attr("x"),y:e.attr("y"),opacity:e.style("opacity"),fill:e.style("fill"),fontSize:e.style("font-size"),element:this})}),u.exit().transition().duration(g).ease(y).style("opacity",0).remove()})})(d,r,o,i),c.exit().transition().duration(g).ease(y).style("opacity",0).remove()}(v,s,L,G,w),function(e,a,r,o){if(h||a.length<2)return;const i=e.selectAll(".connectors-group").data([0]),l=i.enter().append("g").attr("class","connectors-group").merge(i),s=[];for(let e=0;e<a.length-1;e++){const i=a[e],l=a[e+1],c=f(r,a.length,t-n.left-n.right),u=m(r,i.label,c),d=m(r,l.label,c);s.push({x1:u+c,x2:d,y:o(i.cumulativeTotal),id:`${i.label}-${l.label}`})}const c=l.selectAll(".connector").data(s,t=>t.id);c.enter().append("line").attr("class","connector").attr("stroke","#bdc3c7").attr("stroke-width",1).attr("stroke-dasharray","3,3").style("opacity",0).attr("x1",t=>t.x1).attr("x2",t=>t.x1).attr("y1",t=>t.y).attr("y2",t=>t.y).merge(c).transition().duration(g).ease(y).delay((t,e)=>k?e*M:0).attr("x1",t=>t.x1).attr("x2",t=>t.x2).attr("y1",t=>t.y).attr("y2",t=>t.y).style("opacity",.6),c.exit().transition().duration(g).ease(y).style("opacity",0).remove()}(v,s,L,G),function(e,r,o,i){if(!T||r.length<2)return void e.selectAll(".trend-group").remove();const l=e.selectAll(".trend-group").data([0]),s=l.enter().append("g").attr("class","trend-group").merge(l),c=[],u=[];for(let e=0;e<r.length;e++){const a=r[e],l=f(o,r.length,t-n.left-n.right),s=m(o,a.label,l)+l/2,c=i(a.cumulativeTotal);u.push({x:s,y:c,value:a.cumulativeTotal})}if("linear"===D){const t=u.length,e=u.reduce((t,e,n)=>t+n,0),n=u.reduce((t,e)=>t+e.value,0),a=(t*u.reduce((t,e,n)=>t+n*e.value,0)-e*n)/(t*u.reduce((t,e,n)=>t+n*n,0)-e*e),r=(n-a*e)/t;u.forEach((t,e)=>{const n=a*e+r;c.push({x:t.x,y:i(n)})})}else if("moving-average"===D){const t=z;for(let e=0;e<u.length;e++){const n=Math.max(0,e-Math.floor(t/2)),a=Math.min(u.length,n+t),r=u.slice(n,a),o=r.reduce((t,e)=>t+e.value,0)/r.length;c.push({x:u[e].x,y:i(o)})}}else if("polynomial"===D){const t=u.length;if(t>=3){const e=O/10;for(let n=0;n<t;n++){const a=u[n];let r=a.value;if(t>2){const o=n/(t-1),i=Math.sin(o*Math.PI)*e,l=u.reduce((t,e)=>t+e.value,0)/t;r=a.value+(a.value-l)*i*.5}c.push({x:a.x,y:i(r)})}}else u.forEach(t=>{c.push({x:t.x,y:t.y})})}else u.forEach(t=>{c.push({x:t.x,y:t.y})});const d=a.line().x(t=>t.x).y(t=>t.y).curve("polynomial"===D?a.curveCardinal:"moving-average"===D?a.curveMonotoneX:a.curveLinear),h=s.selectAll(".trend-line").data([c]),p=h.enter().append("path").attr("class","trend-line").attr("fill","none").attr("stroke",S).attr("stroke-width",E).attr("stroke-opacity",$).style("opacity",0);function b(t){"dashed"===C?t.attr("stroke-dasharray","5,5"):"dotted"===C?t.attr("stroke-dasharray","2,3"):t.attr("stroke-dasharray",null)}b(p);const v=p.merge(h);b(v),v.transition().duration(g).ease(y).attr("d",d).attr("stroke",S).attr("stroke-width",E).attr("stroke-opacity",$).style("opacity",1),h.exit().transition().duration(g).ease(y).style("opacity",0).remove()}(v,s,L,G),setTimeout(()=>{F&&function(t,e){if(!F)return;t.attr("role","img").attr("aria-label",`Waterfall chart with ${e.length} data points`);const n=t.selectAll("title").data([0]);n.enter().append("title").merge(n).text(`Waterfall chart showing ${h?"stacked":"sequential"} data visualization`);const r=t.selectAll("desc").data([0]);function o(t,e){t.classed("focused",!1);const n=a.select(t.nodes()[e]);n.classed("focused",!0);const r=n.datum();i(`${r.parent?.label||r.label}: ${b(r.value||r.barTotal)}`)}function i(t){const e=a.select("body").selectAll(".sr-announcement").data([0]);e.enter().append("div").attr("class","sr-announcement").attr("aria-live","polite").attr("aria-atomic","true").style("position","absolute").style("left","-10000px").style("width","1px").style("height","1px").style("overflow","hidden").merge(e).text(t)}r.enter().append("desc").merge(r).text(()=>{const t=e[e.length-1]?.cumulativeTotal||0;return`Chart contains ${e.length} data points. Final cumulative value: ${b(t)}. Data ranges from ${e[0]?.label} to ${e[e.length-1]?.label}.`}),t.attr("tabindex","0").on("keydown",function(e){const n=t.select(".focused"),a=t.selectAll(".waterfall-bar, .stack"),r=a.nodes().indexOf(n.node());switch(e.key){case"ArrowRight":case"ArrowDown":e.preventDefault();const t=Math.min(r+1,a.size()-1);o(a,t);break;case"ArrowLeft":case"ArrowUp":e.preventDefault();o(a,Math.max(r-1,0));break;case"Home":e.preventDefault(),o(a,0);break;case"End":e.preventDefault(),o(a,a.size()-1)}});const l=t.selectAll("style.accessibility-styles").data([0]);l.enter().append("style").attr("class","accessibility-styles").merge(l).text("\n                .focused {\n                    stroke: #0066cc !important;\n                    stroke-width: 3px !important;\n                    filter: brightness(1.1);\n                }\n                .waterfall-bar:focus,\n                .stack:focus {\n                    outline: 2px solid #0066cc;\n                    outline-offset: 2px;\n                }\n            ")}(i,s),I&&function(t){if(!I)return;const e=Q;e.configure(j),t.selectAll(".waterfall-bar, .stack").on("mouseover",function(t,n){const r=a.select(this),o=n.parent||n,i=`\n                    <div style="font-weight: bold; margin-bottom: 8px;">${o.label}</div>\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">\n                        <span>Value:</span>\n                        <span style="font-weight: bold;">${b(n.value||o.barTotal)}</span>\n                    </div>\n                    ${void 0!==o.cumulativeTotal?`\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">\n                        <span>Cumulative:</span>\n                        <span style="font-weight: bold;">${b(o.cumulativeTotal)}</span>\n                    </div>\n                    `:""}\n                    ${n.label&&n.label!==o.label?`\n                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">\n                        <div style="font-size: 11px; opacity: 0.8;">${n.label}</div>\n                    </div>\n                    `:""}\n                `;e.show(i,t,{label:o.label,value:n.value||o.barTotal,cumulative:o.cumulativeTotal,color:n.color||(o.stacks&&o.stacks[0]?o.stacks[0].color:"#3498db"),x:parseFloat(r.attr("x")||"0"),y:parseFloat(r.attr("y")||"0"),quadrant:1}),r.style("opacity",.8)}).on("mousemove",function(t){e.move(t)}).on("mouseout",function(){e.hide(),a.select(this).style("opacity",null)}),t.selectAll(".total-label").on("mouseover",function(t,n){const a=n.parent,r=`\n                    <div style="font-weight: bold; margin-bottom: 8px;">${a.label}</div>\n                    <div style="display: flex; justify-content: space-between;">\n                        <span>Total Value:</span>\n                        <span style="font-weight: bold;">${b(a.barTotal)}</span>\n                    </div>\n                `;e.show(r,t,{label:a.label,value:a.barTotal,cumulative:a.cumulativeTotal,color:"#333",x:0,y:0,quadrant:1})}).on("mousemove",function(t){e.move(t)}).on("mouseout",function(){e.hide()})}(i),P?(K.zoomSystemInstance||(K.zoomSystemInstance=u()),K.zoomSystemInstance.attach(c),K.zoomSystemInstance.setDimensions({width:t,height:e,margin:w}),K.zoomSystemInstance.enable()):K.zoomSystemInstance&&(K.zoomSystemInstance.disable(),K.zoomSystemInstance.detach())},50)}catch(n){console.error("MintWaterfall rendering error:",n),console.error("Stack trace:",n.stack),d.selectAll("*").remove(),d.append("text").attr("x",t/2).attr("y",e/2).attr("text-anchor","middle").style("font-size","14px").style("fill","#ff6b6b").text(`Chart Error: ${n.message}`)}})}function J(t){let e=[...t];B&&B.enabled&&(e=function(t){return t}(e));let n=0,a=0;const r=e.map((t,e)=>{const r=t.stacks.reduce((t,e)=>t+e.value,0);a=n,n+=r;let o=t.stacks;U.size>0&&(o=t.stacks);return{...t,stacks:o,barTotal:r,cumulativeTotal:n,prevCumulativeTotal:0===e?0:a}});if(o&&r.length>0){const t=n;r.push({label:l,stacks:[{value:t,color:s}],barTotal:t,cumulativeTotal:t,prevCumulativeTotal:0})}return r}return K.width=function(e){return arguments.length?(t=e,K):t},K.height=function(t){return arguments.length?(e=t,K):e},K.margin=function(t){return arguments.length?(n=t,K):n},K.stacked=function(t){return arguments.length?(h=t,K):h},K.showTotal=function(t){return arguments.length?(o=t,K):o},K.totalLabel=function(t){return arguments.length?(l=t,K):l},K.totalColor=function(t){return arguments.length?(s=t,K):s},K.barPadding=function(t){return arguments.length?(p=t,K):p},K.duration=function(t){return arguments.length?(g=t,K):g},K.ease=function(t){return arguments.length?(y=t,K):y},K.formatNumber=function(t){return arguments.length?(b=t,K):b},K.theme=function(t){return arguments.length?(v=t,K):v},K.enableBrush=function(t){return arguments.length?(w=t,K):w},K.brushOptions=function(t){return arguments.length?(x={...x,...t},K):x},K.staggeredAnimations=function(t){return arguments.length?(k=t,K):k},K.staggerDelay=function(t){return arguments.length?(M=t,K):M},K.scaleType=function(t){return arguments.length?(A=t,K):A},K.showTrendLine=function(t){return arguments.length?(T=t,K):T},K.trendLineColor=function(t){return arguments.length?(S=t,K):S},K.trendLineWidth=function(t){return arguments.length?(E=t,K):E},K.trendLineStyle=function(t){return arguments.length?(C=t,K):C},K.trendLineOpacity=function(t){return arguments.length?($=t,K):$},K.trendLineType=function(t){return arguments.length?(D=t,K):D},K.trendLineWindow=function(t){return arguments.length?(z=t,K):z},K.trendLineDegree=function(t){return arguments.length?(O=t,K):O},K.enableAccessibility=function(t){return arguments.length?(F=t,K):F},K.enableTooltips=function(t){return arguments.length?(I=t,K):I},K.tooltipConfig=function(t){return arguments.length?(j={...j,...t},K):j},K.enableExport=function(t){return arguments.length?(L=t,K):L},K.exportConfig=function(t){return arguments.length?(R={...R,...t},K):R},K.enableZoom=function(t){return arguments.length?(P=t,K):P},K.zoomConfig=function(t){return arguments.length?(W={...W,...t},K):W},K.breakdownConfig=function(t){return arguments.length?(B=t,K):B},K.enablePerformanceOptimization=function(t){return arguments.length?(H=t,K):H},K.performanceDashboard=function(t){return arguments.length?(G=t,K):G},K.virtualizationThreshold=function(t){return arguments.length?(_=t,K):_},K.data=function(t){return K},K.on=function(){const t=X.on.apply(X,Array.from(arguments));return t===X?K:t},K}function p(t,e={}){const{valueColumn:n="value",labelColumn:a="label",colorColumn:r="color",defaultColor:o="#3498db",parseNumbers:i=!0}=e;if(!Array.isArray(t))throw new Error("Data must be an array");return t.map((t,e)=>{if(t.label&&Array.isArray(t.stacks))return t;const l=t[a]||`Item ${e+1}`;let s=t[n];i&&"string"==typeof s?s=parseFloat(s.replace(/[,$]/g,""))||0:"number"!=typeof s&&(s=0);const c=t[r]||o;return{label:String(l),stacks:[{value:s,color:c,label:t.stackLabel||`${s>=0?"+":""}${s}`}]}})}function g(){function t(t){if(!t||!Array.isArray(t))throw new Error("Data must be an array");if(0===t.length)throw new Error("Data array cannot be empty");return t.every((t,e)=>{if(!t||"object"!=typeof t)throw new Error(`Item at index ${e} must be an object`);if("string"!=typeof t.label)throw new Error(`Item at index ${e} must have a string 'label' property`);if(!Array.isArray(t.stacks))throw new Error(`Item at index ${e} must have an array 'stacks' property`);if(0===t.stacks.length)throw new Error(`Item at index ${e} must have at least one stack`);return t.stacks.forEach((t,n)=>{if("number"!=typeof t.value||isNaN(t.value))throw new Error(`Stack ${n} in item ${e} must have a numeric 'value'`);if("string"!=typeof t.color)throw new Error(`Stack ${n} in item ${e} must have a string 'color'`)}),!0})}return{validateData:t,loadData:async function(t,e={}){return await async function(t,e={}){try{let n;if("string"==typeof t)if(t.endsWith(".csv"))n=await a.csv(t);else if(t.endsWith(".json"))n=await a.json(t);else if(t.endsWith(".tsv"))n=await a.tsv(t);else{if(!t.startsWith("http"))throw new Error(`Unsupported file format: ${t}`);{const e=await fetch(t),r=e.headers.get("content-type");if(r?.includes("application/json"))n=await e.json();else if(r?.includes("text/csv")){const t=await e.text();n=a.csvParse(t)}else n=await e.json()}}else{if(!Array.isArray(t))throw new Error("Source must be a URL, file path, or data array");n=t}return p(n,e)}catch(t){throw console.error("Error loading data:",t),t}}(t,e)},transformToWaterfallFormat:function(t,e={}){return p(t,e)},aggregateData:function(e,n="sum"){return t(e),e.map(t=>{let e;switch(n){case"sum":default:e=t.stacks.reduce((t,e)=>t+e.value,0);break;case"average":e=t.stacks.reduce((t,e)=>t+e.value,0)/t.stacks.length;break;case"max":e=Math.max(...t.stacks.map(t=>t.value));break;case"min":e=Math.min(...t.stacks.map(t=>t.value))}return{...t,aggregatedValue:e,originalStacks:t.stacks}})},sortData:function(e,n="label",a="ascending"){return t(e),[...e].sort((t,e)=>{let r,o,i;switch(n){case"label":default:r=t.label.toLowerCase(),o=e.label.toLowerCase();break;case"total":const n=t.stacks.reduce((t,e)=>t+e.value,0),a=e.stacks.reduce((t,e)=>t+e.value,0);r=Math.abs(n),o=Math.abs(a);break;case"maxStack":r=Math.max(...t.stacks.map(t=>t.value)),o=Math.max(...e.stacks.map(t=>t.value));break;case"minStack":r=Math.min(...t.stacks.map(t=>t.value)),o=Math.min(...e.stacks.map(t=>t.value))}return i="string"==typeof r&&"string"==typeof o?r.localeCompare(o):r-o,"ascending"===a?i:-i})},filterData:function(e,n){return t(e),e.filter(n)},getDataSummary:function(e){t(e);const n=[],a=[];let r=0;e.forEach(t=>{t.stacks.forEach(t=>{n.push(t.value),a.push(t.color),r++})});const o={min:Math.min(...n),max:Math.max(...n)},i=n.reduce((t,e)=>t+e,0),l=[...new Set(a)],s=e.map(t=>t.label);return{totalItems:e.length,totalStacks:r,valueRange:o,cumulativeTotal:i,stackColors:l,labels:s}},transformData:function(e,n){return t(e),e.map(n)},groupData:function(e,n){t(e);const a=new Map;return e.forEach(t=>{const e="function"==typeof n?n(t):t.label;a.has(e)||a.set(e,[]),a.get(e).push(t)}),a},transformStacks:function(t,e){if("function"!=typeof e)throw new Error("Transformer must be a function");return t.map(t=>({...t,stacks:t.stacks.map(e)}))},normalizeValues:function(t,e){let n=0;if(t.forEach(t=>{t.stacks.forEach(t=>{n=Math.max(n,Math.abs(t.value))})}),0===n)return t;const a=e/n;return t.map(t=>({...t,stacks:t.stacks.map(t=>({...t,originalValue:t.value,value:t.value*a}))}))},groupByCategory:function(t,e){if("function"!=typeof e)throw new Error("Category function must be a function");const n={};return t.forEach(t=>{const a=e(t);n[a]||(n[a]=[]),n[a].push(t)}),n},calculatePercentages:function(t){return t.map(t=>{const e=t.stacks.reduce((t,e)=>t+Math.abs(e.value),0);return{...t,stacks:t.stacks.map(t=>({...t,percentage:0===e?0:Math.abs(t.value)/e*100}))}})},interpolateData:function(t,e,n){if(t.length!==e.length)throw new Error("Data arrays must have the same length");return t.map((t,a)=>{const r=e[a],o=Math.min(t.stacks.length,r.stacks.length);return{label:t.label,stacks:Array.from({length:o},(e,a)=>({value:t.stacks[a].value+(r.stacks[a].value-t.stacks[a].value)*n,color:t.stacks[a].color,label:t.stacks[a].label}))}})},generateSampleData:function(t,e,n=[10,100]){const[a,r]=n,o=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];return Array.from({length:t},(t,n)=>({label:`Item ${n+1}`,stacks:Array.from({length:e},(t,e)=>({value:Math.random()*(r-a)+a,color:o[e%o.length],label:`Stack ${e+1}`}))}))},groupBy:function(t,...e){if(!Array.isArray(t))throw new Error("Data must be an array");if(0===e.length)throw new Error("At least one grouping key must be provided");if(1===e.length)return a.group(t,e[0]);if(2===e.length)return a.group(t,e[0],e[1]);if(3===e.length)return a.group(t,e[0],e[1],e[2]);throw new Error("Maximum 3 levels of grouping supported")},rollupBy:function(t,e,...n){if(!Array.isArray(t))throw new Error("Data must be an array");if("function"!=typeof e)throw new Error("Reducer must be a function");if(0===n.length)throw new Error("At least one grouping key must be provided");if(1===n.length)return a.rollup(t,e,n[0]);if(2===n.length)return a.rollup(t,e,n[0],n[1]);if(3===n.length)return a.rollup(t,e,n[0],n[1],n[2]);throw new Error("Maximum 3 levels of rollup supported")},flatRollupBy:function(t,e,...n){if(!Array.isArray(t))throw new Error("Data must be an array");if("function"!=typeof e)throw new Error("Reducer must be a function");if(0===n.length)throw new Error("At least one grouping key must be provided");return a.flatRollup(t,e,...n)},crossTabulate:function(t,e,n){if(!Array.isArray(t)||!Array.isArray(e))throw new Error("Both data arrays must be arrays");return n?a.cross(t,e,(t,e)=>({row:t,col:e,value:n(t,e)})):a.cross(t,e,(t,e)=>({row:t,col:e,value:void 0}))},indexBy:function(t,...e){if(!Array.isArray(t))throw new Error("Data must be an array");if(0===e.length)throw new Error("At least one indexing key must be provided");if(1===e.length)return a.index(t,e[0]);if(2===e.length)return a.index(t,e[0],e[1]);throw new Error("Maximum 2 levels of indexing supported")},aggregateByTime:function(t,e){const{timeAccessor:n,valueAccessor:r,interval:o,aggregation:i="sum"}=e;if(!Array.isArray(t))throw new Error("Data must be an array");if("function"!=typeof n||"function"!=typeof r)throw new Error("Time and value accessors must be functions");const l=a.rollup(t,t=>{switch(i){case"sum":default:return a.sum(t,r);case"average":return a.mean(t,r)||0;case"max":return a.max(t,r)||0;case"min":return a.min(t,r)||0}},t=>o(n(t)));return Array.from(l.entries()).map(([t,e])=>({label:a.timeFormat("%Y-%m-%d")(t),stacks:[{value:e,color:e>=0?"#2ecc71":"#e74c3c",label:`${e>=0?"+":""}${a.format(".2f")(e)}`}]}))},createMultiDimensionalWaterfall:function(t,e,n){if(!Array.isArray(t)||!Array.isArray(e))throw new Error("Data and groupKeys must be arrays");if(0===e.length)throw new Error("At least one group key must be provided");const r=e.map(t=>e=>e[t]);return a.flatRollup(t,t=>a.sum(t,t=>t[n]||0),...r).map(t=>{const e=t.slice(0,-1),n=t[t.length-1],r=["#3498db","#2ecc71","#f39c12","#e74c3c","#9b59b6"];return{label:e.join(" → "),stacks:[{value:n,color:r[Math.abs(e.join("").split("").reduce((t,e)=>t+e.charCodeAt(0),0))%r.length],label:`${n>=0?"+":""}${a.format(".2f")(n)}`}]}})},aggregateWaterfallByPeriod:function(e,n,r){t(e);const o=a.rollup(e,t=>{const e=[];t.forEach(t=>e.push(...t.stacks));const n=a.rollup(e,t=>({value:a.sum(t,t=>t.value),label:t[0].label,color:t[0].color}),t=>t.color);return Array.from(n.values())},t=>{const e=t[n]||t.label,a=new Date(e);return isNaN(a.getTime())?new Date:r(a)});return Array.from(o.entries()).map(([t,e])=>({label:a.timeFormat("%Y-%m-%d")(t),stacks:e}))},createBreakdownWaterfall:function(t,e,n,r){if(!Array.isArray(t))throw new Error("Data must be an array");const o=a.rollup(t,t=>a.sum(t,t=>t[r]||0),t=>t[e],t=>t[n]);return Array.from(o.entries()).map(([t,e])=>{const n=Array.from(e.entries()).map(([t,e],n)=>{const r=["#3498db","#2ecc71","#f39c12","#e74c3c","#9b59b6","#1abc9c","#34495e"];return{value:e,color:r[n%r.length],label:`${t}: ${e>=0?"+":""}${a.format(".2f")(e)}`}});return{label:String(t),stacks:n}})}}}"undefined"!=typeof document&&s.injectForcedColorsCSS();const y=g();const b={sum:t=>a.sum(t,t=>t.value||0),average:t=>a.mean(t,t=>t.value||0)||0,weightedAverage:(t,e="weight")=>{const n=a.sum(t,t=>t[e]||0);return 0===n?0:a.sum(t,t=>(t.value||0)*(t[e]||0))/n},variance:t=>{const e=a.mean(t,t=>t.value||0)||0;return a.mean(t,t=>Math.pow((t.value||0)-e,2))||0},percentile:t=>e=>{const n=e.map(t=>t.value||0).sort(a.ascending);return a.quantile(n,t/100)||0}},v={group:a.group,rollup:a.rollup,flatRollup:a.flatRollup,cross:a.cross,index:a.index,sum:a.sum,mean:a.mean,median:a.median,quantile:a.quantile,min:a.min,max:a.max,extent:a.extent,ascending:a.ascending,descending:a.descending};const w={default:{name:"Default",background:"#ffffff",gridColor:"#e0e0e0",axisColor:"#666666",textColor:"#333333",totalColor:"#95A5A6",colors:["#3498db","#2ecc71","#e74c3c","#f39c12","#9b59b6","#1abc9c","#e67e22","#f1c40f"]},dark:{name:"Dark",background:"#2c3e50",gridColor:"#34495e",axisColor:"#bdc3c7",textColor:"#ecf0f1",totalColor:"#95a5a6",colors:["#3498db","#2ecc71","#e74c3c","#f39c12","#9b59b6","#1abc9c","#e67e22","#f1c40f"]},corporate:{name:"Corporate",background:"#ffffff",gridColor:"#e8e8e8",axisColor:"#555555",textColor:"#333333",totalColor:"#7f8c8d",colors:["#2c3e50","#34495e","#7f8c8d","#95a5a6","#bdc3c7","#ecf0f1"]},accessible:{name:"Accessible",background:"#ffffff",gridColor:"#cccccc",axisColor:"#000000",textColor:"#000000",totalColor:"#666666",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f"]},colorful:{name:"Colorful",background:"#ffffff",gridColor:"#f0f0f0",axisColor:"#666666",textColor:"#333333",totalColor:"#34495e",colors:["#ff6b6b","#4ecdc4","#45b7d1","#f9ca24","#f0932b","#eb4d4b","#6c5ce7","#a29bfe"]}};"undefined"!=typeof window&&window.d3&&(window.d3.waterfallChart=h),t.applyTheme=function(t,e="default"){const n=w[e]||w.default;return t.totalColor(n.totalColor),n},t.createAccessibilitySystem=l,t.createAnimationSystem=function(){const t={staggerDelay:100,defaultDuration:750,defaultEase:"easeOutQuad"},e={linear:t=>t,easeInQuad:t=>t*t,easeOutQuad:t=>t*(2-t),easeInOutQuad:t=>t<.5?2*t*t:(4-2*t)*t-1,easeInCubic:t=>t*t*t,easeOutCubic:t=>--t*t*t+1,easeInOutCubic:t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,easeInSine:t=>1-Math.cos(t*Math.PI/2),easeOutSine:t=>Math.sin(t*Math.PI/2),easeInOutSine:t=>-(Math.cos(Math.PI*t)-1)/2,easeInElastic:t=>{const e=2*Math.PI/3;return 0===t?0:1===t?1:-Math.pow(2,10*t-10)*Math.sin((10*t-10.75)*e)},easeOutElastic:t=>{const e=2*Math.PI/3;return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin((10*t-.75)*e)+1},easeOutBounce:t=>{const e=7.5625,n=2.75;return t<1/n?e*t*t:t<2/n?e*(t-=1.5/n)*t+.75:t<2.5/n?e*(t-=2.25/n)*t+.9375:e*(t-=2.625/n)*t+.984375}};function n(t,n,a,r="easeOutQuad",o,i){const l=performance.now(),s=n-t,c=e[r]||e.easeOutQuad;requestAnimationFrame(function e(n){const r=n-l,u=Math.min(r/a,1),d=c(u);o&&o(t+s*d,u),u<1?requestAnimationFrame(e):i&&i()})}function a(t,e,a,r=500,o="easeOutQuad"){return new Promise(i=>{n(e,a,r,o,e=>{t&&t.style?t.style.opacity=e.toString():t&&t.attr&&t.attr("opacity",e)},()=>i())})}function r(t,e,a,r=500,o="easeOutQuad"){return new Promise(i=>{n(e,a,r,o,e=>{t&&t.style?t.style.transform=`translateX(${e}px)`:t&&t.attr&&t.attr("transform",`translate(${e}, 0)`)},()=>i())})}function o(t,e,a,r=500,o="easeOutQuad"){return new Promise(i=>{n(e,a,r,o,e=>{t&&t.style?t.style.transform=`scale(${e})`:t&&t.attr&&t.attr("transform",`scale(${e})`)},()=>i())})}function i(){const t=[];let e=!1;const n={add:function(e,a=0){return t.push({fn:e,delay:a}),n},parallel:function(...e){return t.push({fn:()=>Promise.all(e.map(t=>t())),delay:0}),n},play:async function(){if(e)throw new Error("Sequence is already running");e=!0;try{for(const e of t)e.delay>0&&await new Promise(t=>setTimeout(t,e.delay)),await e.fn()}finally{e=!1}},stop:function(){e=!1},get isRunning(){return e}};return n}const l={slideInLeft:(t,e=500)=>r(t,-100,0,e,"easeOutQuad"),slideInRight:(t,e=500)=>r(t,100,0,e,"easeOutQuad"),fadeIn:(t,e=500)=>a(t,0,1,e,"easeOutQuad"),fadeOut:(t,e=500)=>a(t,1,0,e,"easeOutQuad"),scaleIn:(t,e=500)=>o(t,0,1,e,"easeOutElastic"),scaleOut:(t,e=500)=>o(t,1,0,e,"easeInQuad"),pulse:(t,e=300)=>i().add(()=>o(t,1,1.1,e/2,"easeOutQuad")).add(()=>o(t,1.1,1,e/2,"easeInQuad")).play(),bounce:(t,e=600)=>o(t,0,1,e,"easeOutBounce")};return{easingFunctions:e,animateValue:n,staggeredAnimation:function(t,e,n=100,a=1e3){if(!Array.isArray(t))throw new Error("Items must be an array");t.forEach((t,r)=>{const o=r*n,i=a-o;setTimeout(()=>{i>0&&e(t,r,i)},o)})},morphShape:function(t,n,a=1e3,r="easeInOutQuad",o,i){if("string"!=typeof t||"string"!=typeof n)throw new Error("Path values must be strings");const l=performance.now(),s=e[r]||e.easeInOutQuad;requestAnimationFrame(function e(r){const c=r-l,u=Math.min(c/a,1),d=s(u);o&&o(u<.5?t:n,d),u<1?requestAnimationFrame(e):i&&i()})},fadeTransition:a,slideTransition:r,scaleTransition:o,createTransitionSequence:i,createSpringAnimation:function(t=300,e=20){return{animate:function(n,a,r,o){let i=n,l=0,s=performance.now();requestAnimationFrame(function n(c){const u=(c-s)/1e3;s=c;const d=i-a;l+=(-t*d+-e*l)*u,i+=l*u,r&&r(i),Math.abs(d)<.01&&Math.abs(l)<.01?o&&o():requestAnimationFrame(n)})}}},createStaggeredTransition:function(e,n,a={}){const{delay:r=t.staggerDelay,duration:o=t.defaultDuration,ease:i=t.defaultEase,reverse:l=!1}=a,s=Array.isArray(e)?e:Array.from(e),c=l?[...s].reverse():s;return Promise.all(c.map((t,e)=>new Promise(a=>{setTimeout(()=>{n(t,o,i).then(a)},e*r)})))},createCustomTween:function(t,e,n){return function(a){return"function"==typeof n?n(t,e,a):t+(e-t)*a}},createTransitionWithEvents:function(e,n){const{duration:a=t.defaultDuration,onStart:r,onEnd:o,onInterrupt:i}=n;let l=!1;return{start(){return r&&r(),this},interrupt(){return l=!0,i&&i(),this},then(t){return!l&&o&&setTimeout(()=>{o(),t&&t()},a),this}}},transitionConfig:t,presets:l}},t.createBrushSystem=function(){const t={createBrush:function(t={}){const{type:e="xy"}=t;switch(e){case"x":return a.brushX();case"y":return a.brushY();default:return a.brush()}},filterDataByBrush:function(t,e,n){if(!e||!n)return t;const[a,r]=e;return t.filter(t=>{const e=n(t.x||t.label||t.value);return e>=a&&e<=r})},getSelectedIndices:function(t,e,n){if(!e||!n)return[];const[a,r]=e,o=[];return t.forEach((t,e)=>{const i=n(t.x||t.label||t.value);i>=a&&i<=r&&o.push(e)}),o},selectionUtils:{createSelectionSummary(t){if(!t||0===t.length)return{count:0,sum:0,average:0,min:0,max:0};const e=t.map(t=>t.cumulativeTotal||t.value||t.y||0),n=e.reduce((t,e)=>t+e,0),a=Math.min(...e),r=Math.max(...e);return{count:t.length,sum:n,average:n/t.length,min:a,max:r,extent:[a,r]}}},onStart:e=>t,onMove:e=>t,onEnd:e=>t};return t},t.createComparisonWaterfall=function(t,e,n,r){const o=a.index(e,n);return t.map(t=>{const e=n(t),i=r(t),l=o.get(e),s=i-(l?r(l):0);return{label:e,stacks:[{value:s,color:s>=0?"#2ecc71":"#e74c3c",label:`Change: ${s>=0?"+":""}${a.format(".2f")(s)}`}]}})},t.createDataProcessor=g,t.createExportSystem=function(){let t={filename:"waterfall-chart",quality:1,scale:1,background:"#ffffff",padding:20,includeStyles:!0,includeData:!0};function e(e,n={}){const a={...t,...n};try{const t=e.select("svg");if(t.empty())throw new Error("No SVG element found in chart container");const n=t.node(),o=new XMLSerializer,i=n.cloneNode(!0);a.includeStyles&&function(t){try{const e=Array.from(document.styleSheets);let n="";if(e.forEach(t=>{try{Array.from(t.cssRules||t.rules).forEach(t=>{if(t.type===CSSRule.STYLE_RULE){const e=t;e.selectorText&&(e.selectorText.includes(".mintwaterfall")||e.selectorText.includes("svg")||e.selectorText.includes("chart"))&&(n+=e.cssText)}})}catch(t){console.warn("Could not access stylesheet:",t)}}),n){const e=document.createElementNS("http://www.w3.org/2000/svg","style");e.textContent=n,t.insertBefore(e,t.firstChild)}}catch(t){console.warn("Failed to add inline styles:",t)}}(i),a.background&&"transparent"!==a.background&&function(t,e){const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("fill",e),t.insertBefore(n,t.firstChild)}(i,a.background);const l=o.serializeToString(i),s=new Blob([l],{type:"image/svg+xml;charset=utf-8"});return{blob:s,url:URL.createObjectURL(s),data:l,download:()=>r(s,`${a.filename}.svg`)}}catch(t){throw console.error("SVG export failed:",t),t}}function n(n,a={}){const o={...t,scale:2,quality:.95,...a};return new Promise((t,a)=>{try{const i=n.select("svg");if(i.empty())return void a(new Error("No SVG element found in chart container"));const l=i.node().getBBox(),s=(l.width+2*o.padding)*o.scale,c=(l.height+2*o.padding)*o.scale,u=document.createElement("canvas");u.width=s,u.height=c;const d=u.getContext("2d");if(!d)return void a(new Error("Failed to get canvas context"));d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",o.background&&"transparent"!==o.background&&(d.fillStyle=o.background,d.fillRect(0,0,s,c));const f=e(n,{...o,includeStyles:!0,background:"transparent"}),m=new Image;m.onload=()=>{try{d.drawImage(m,o.padding*o.scale,o.padding*o.scale),u.toBlob(e=>{e?(URL.revokeObjectURL(f.url),t({blob:e,url:URL.createObjectURL(e),data:f.data,download:()=>r(e,`${o.filename}.png`)})):a(new Error("Failed to create PNG blob"))},"image/png",o.quality)}catch(t){a(new Error(`PNG rendering failed: ${t}`))}},m.onerror=()=>{a(new Error("Failed to load SVG image for PNG conversion"))},m.src=`data:image/svg+xml;base64,${btoa(f.data)}`}catch(t){a(new Error(`PNG export failed: ${t}`))}})}function a(t,e=","){if(!t||0===t.length)return"";const n=Object.keys(t[0]);return[n.join(e),...t.map(t=>n.map(n=>{const a=t[n],r=null!=a?String(a):"";return r.includes(e)||r.includes('"')||r.includes("\n")?`"${r.replace(/"/g,'""')}"`:r}).join(e))].join("\n")}function r(t,e){const n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}const o={exportSVG:e,exportPNG:n,exportPDF:function(e,a={}){const o={...t,orientation:"landscape",pageFormat:"a4",...a};return new Promise((t,a)=>{if("undefined"!=typeof window&&window.jsPDF)try{n(e,{...o,scale:2,quality:.95}).then(e=>{const n=new(0,window.jsPDF)({orientation:o.orientation,unit:"mm",format:o.pageFormat}),i=n.internal.pageSize.getWidth(),l=n.internal.pageSize.getHeight(),s=new FileReader;s.onload=()=>{try{const a=s.result,c=new Image;c.onload=()=>{const s=c.width/c.height;let u=i-20,d=u/s;d>l-20&&(d=l-20,u=d*s);const f=(i-u)/2,m=(l-d)/2;n.addImage(a,"PNG",f,m,u,d);const h=n.output("blob");URL.revokeObjectURL(e.url),t({blob:h,url:URL.createObjectURL(h),data:h,download:()=>r(h,`${o.filename}.pdf`)})},c.src=a}catch(t){a(new Error(`PDF generation failed: ${t}`))}},s.onerror=()=>{a(new Error("Failed to read PNG data for PDF conversion"))},s.readAsDataURL(e.blob)}).catch(a)}catch(t){a(new Error(`PDF export failed: ${t}`))}else a(new Error('jsPDF library is required for PDF export. Please include it: <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>'))})},exportData:function(e,n={}){const o={...t,dataFormat:"json",includeMetadata:!0,delimiter:",",...n};try{let t,n,i;switch(o.dataFormat){case"json":const r=o.includeMetadata?{data:e,metadata:{exportDate:(new Date).toISOString(),count:e.length}}:e;t=JSON.stringify(r,null,2),n="application/json",i="json";break;case"csv":t=a(e,o.delimiter||","),n="text/csv",i="csv";break;case"tsv":t=a(e,"\t"),n="text/tab-separated-values",i="tsv";break;default:throw new Error(`Unsupported data export format: ${o.dataFormat}`)}const l=new Blob([t],{type:`${n};charset=utf-8`});return{blob:l,url:URL.createObjectURL(l),data:t,download:()=>r(l,`${o.filename}.${i}`)}}catch(t){throw console.error("Data export failed:",t),t}},configure:function(e){return t={...t,...e},o},downloadFile:function(t,e,n="text/plain"){r(t instanceof Blob?t:new Blob([t],{type:n}),e)}};return o},t.createHierarchicalLayout=function(){let t=[800,400],e=0,n=!1,r="treemap",o=0,i=0,l=0,s=0,c=0,u=0,d=1.618033988749895,f={orientation:"horizontal"},m={nodeSize:null,separation:null};function h(r){const d=a.treemap().size(t).round(n).padding(e);return void 0!==o&&d.paddingInner(o),void 0!==i&&d.paddingOuter(i),void 0!==l&&d.paddingTop(l),void 0!==s&&d.paddingRight(s),void 0!==c&&d.paddingBottom(c),void 0!==u&&d.paddingLeft(u),d(r)}const p=function(o){if(!o)throw console.error("MintWaterfall: No hierarchical data provided to layout"),new Error("No hierarchical data provided");const i=o;switch(r){case"treemap":return h(i);case"partition":return function(r){const o=a.partition().size(t).round(n).padding(e)(r);"vertical"===f.orientation&&o.each(t=>{if(void 0!==t.x0&&void 0!==t.y0&&void 0!==t.x1&&void 0!==t.y1){const e=t.x0;t.x0=t.y0,t.y0=e;const n=t.x1;t.x1=t.y1,t.y1=n}});return o}(i);case"pack":return function(n){return a.pack().size(t).padding(e)(n)}(i);case"cluster":return function(e){const n=a.cluster().size(t);m.nodeSize&&n.nodeSize(m.nodeSize);m.separation&&n.separation(m.separation);return n(e)}(i);case"tree":return function(e){const n=a.tree().size(t);m.nodeSize&&n.nodeSize(m.nodeSize);m.separation&&n.separation(m.separation);return n(e)}(i);default:return console.warn(`MintWaterfall: Unknown layout type '${r}', falling back to treemap`),h(i)}};return p.size=function(e){return arguments.length?(t=e,p):t},p.padding=function(t){return arguments.length?(e=t,p):e},p.paddingInner=function(t){return arguments.length?(o=t,p):o},p.paddingOuter=function(t){return arguments.length?(i=t,p):i},p.paddingTop=function(t){return arguments.length?(l=t,p):l},p.paddingRight=function(t){return arguments.length?(s=t,p):s},p.paddingBottom=function(t){return arguments.length?(c=t,p):c},p.paddingLeft=function(t){return arguments.length?(u=t,p):u},p.round=function(t){return arguments.length?(n=t,p):n},p.ratio=function(t){return arguments.length?(d=t,p):d},p.type=function(t){return arguments.length?(r=t,p):r},p.partitionOrientation=function(t){return arguments.length?(f.orientation=t,p):f.orientation},p.nodeSize=function(t){return arguments.length?(m.nodeSize=t,p):m.nodeSize},p.separation=function(t){return arguments.length?(m.separation=t,p):m.separation},p},t.createPerformanceManager=d,t.createRevenueWaterfall=function(t,e,n="revenue"){return y.createMultiDimensionalWaterfall(t,e,n)},t.createScaleSystem=r,t.createTemporalWaterfall=function(t,e,n,r="month"){const o={day:a.timeDay,week:a.timeWeek,month:a.timeMonth,quarter:a.timeMonth.every(3),year:a.timeYear};return y.aggregateByTime(t,{timeAccessor:t=>new Date(t[e]),valueAccessor:t=>t[n]||0,interval:o[r],aggregation:"sum"})},t.createTooltipSystem=c,t.createVarianceWaterfall=function(t,e,n="actual",r="budget"){return t.map(t=>{const o=(t[n]||0)-(t[r]||0);return{label:t[e],stacks:[{value:o,color:o>=0?"#2ecc71":"#e74c3c",label:`Variance: ${o>=0?"+":""}${a.format(".2f")(o)}`}]}})},t.createZoomSystem=u,t.d3DataUtils=v,t.dataProcessor=y,t.default=h,t.financialReducers=b,t.groupWaterfallData=function(t,e,n,r){const o=y.flatRollupBy(t,t=>a.sum(t,n),...e),i=["#3498db","#2ecc71","#f39c12","#e74c3c","#9b59b6","#1abc9c","#34495e","#95a5a6"];return o.map((e,n)=>{const o=e.slice(0,-1),l=e[e.length-1];return{label:r&&t[0]?o.map((e,n)=>`${Object.keys(t[0])[n]}: ${e}`).join(" | "):o.join(" → "),stacks:[{value:l,color:i[n%i.length],label:`${l>=0?"+":""}${a.format(".2f")(l)}`}]}})},t.themes=w,t.transformTransactionData=function(t,e,n,r="amount",o){if(n)return y.createBreakdownWaterfall(t,e,n,r);{const n=y.rollupBy(t,t=>a.sum(t,t=>t[r]||0),t=>t[e]),o=["#3498db","#2ecc71","#f39c12","#e74c3c","#9b59b6"];let i=0;return Array.from(n.entries()).map(([t,e])=>({label:String(t),stacks:[{value:e,color:o[i++%o.length],label:`${e>=0?"+":""}${a.format(".2f")(e)}`}]}))}},t.version="0.8.6",t.waterfallChart=h,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=mintwaterfall.min.js.map
