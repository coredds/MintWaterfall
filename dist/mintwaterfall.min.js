/*!
 * MintWaterfall v0.8.6
 * D3.js-compatible waterfall chart component
 * (c) 2024 David Duarte
 * Released under the MIT License
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MintWaterfall={},e.d3)}(this,function(e,t){"use strict";function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var a=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,a.get?a:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var a=n(t);function r(){let e=[0,800];function t(t,n={}){const{range:r=e,nice:o=!0,tickFormat:i="auto"}=n,l=a.extent(t),s=a.scaleTime().domain(l).range(r);if(o&&s.nice(),"auto"===i&&l[0]&&l[1]&&l[0]instanceof Date&&l[1]instanceof Date){const e=(l[1].getTime()-l[0].getTime())/864e5;s.tickFormat=e<1?a.timeFormat("%H:%M"):e<30?a.timeFormat("%m/%d"):e<365?a.timeFormat("%b %Y"):a.timeFormat("%Y")}else"string"==typeof i&&(s.tickFormat=a.timeFormat(i));return s}function n(t,n={}){const{padding:r=.1,paddingInner:o=null,paddingOuter:i=null,align:l=.5,range:s=e}=n,c=[...new Set(t.map(String))],u=a.scaleBand().domain(c).range(s).align(l);return null!==o&&u.paddingInner(o),null!==i&&u.paddingOuter(i),null===o&&null===i&&u.padding(r),u}function r(t,n={}){const{range:r=e,nice:o=!0,zero:i=!1,clamp:l=!1}=n;let s=a.extent(t);i&&(s=[Math.min(0,s[0]),Math.max(0,s[1])]);const c=a.scaleLinear().domain(s).range(r);return o&&c.nice(),l&&c.clamp(!0),c}return{createAdaptiveScale:function(o,i="x"){const l=o.map(e=>"x"===i?e.label:e.cumulativeTotal);return l.every(e=>e instanceof Date)?t(l):l.every(e=>"string"==typeof e||isNaN(e))?n(l):l.every(e=>"number"==typeof e)?r(l):a.scaleBand().domain(l.map(String)).range(e)},createTimeScale:t,createOrdinalScale:function(e,t={}){const{range:n=a.schemeCategory10,unknown:r="#ccc"}=t,o=[...new Set(e)];return a.scaleOrdinal().domain(o).range(n).unknown(r)},createBandScale:n,createLinearScale:r,createLogScale:function(t,n={}){if(t.some(e=>e<=0))return r(t,n);const{range:o=e,nice:i=!0,clamp:l=!1}=n,s=a.extent(t),c=a.scaleLog().domain(s).range(o);return i&&c.nice(),l&&c.clamp(!0),c},setDefaultRange:function(t){e=t},getScaleInfo:function(e){const t={type:"unknown",domain:[],range:[]};try{t.domain=e.domain(),t.range=e.range(),"function"==typeof e.bandwidth?(t.type="band",t.bandwidth=e.bandwidth(),"function"==typeof e.step&&(t.step=e.step())):"function"==typeof e.nice?t.domain.length>0&&t.domain[0]instanceof Date?t.type="time":t.type="linear":"function"==typeof e.unknown&&(t.type="ordinal")}catch(e){console.warn("Could not extract complete scale info:",e)}return t},scaleUtils:o()}}function o(){return{formatTickValue:function(e,t){return"function"==typeof e.tickFormat?e.tickFormat()(t):e.tickFormat?e.tickFormat(t):"number"==typeof t?Math.abs(t)>=1e6?`${(t/1e6).toFixed(1)}M`:Math.abs(t)>=1e3?`${(t/1e3).toFixed(1)}K`:t.toFixed(0):String(t)},getTickCount:function(e,t){const n=e.range(),a=Math.abs(n[1]-n[0]),r=Math.max(2,Math.floor(a/75));return Math.min(10,Math.max(2,r))},createColorScale:function(e,t=a.schemeCategory10){return a.scaleOrdinal().domain(e).range([...t])},invertScale:function(e,t){if("function"==typeof e.invert)return e.invert(t);if("function"==typeof e.bandwidth){const n=e.domain(),a=e.bandwidth();e.step();for(let r=0;r<n.length;r++){const o=e(n[r]);if(t>=o&&t<=o+a)return n[r]}const r=n.map(n=>Math.abs(e(n)+a/2-t));return n[r.indexOf(Math.min(...r))]}},detectScaleType:function(e){return e.every(e=>e instanceof Date)?"time":e.every(e=>"string"==typeof e||isNaN(e))?"band":e.every(e=>"number"==typeof e)?"linear":"adaptive"},createAxis:function(e,t="bottom"){let n;switch(t){case"top":n=a.axisTop(e);break;case"bottom":default:n=a.axisBottom(e);break;case"left":n=a.axisLeft(e);break;case"right":n=a.axisRight(e)}return n}}}function i(){const e={enabled:!0,extent:[[0,0],[800,400]],handleSize:6,filter:null,touchable:!0,keyModifiers:!0,selection:{fill:"#007acc",fillOpacity:.3,stroke:"#007acc",strokeWidth:1,strokeDasharray:null},handles:{fill:"#fff",stroke:"#007acc",strokeWidth:1,size:6}};let t=null,n=null,r=null,o=[];const i=a.dispatch("brushstart","brush","brushend","clear");function l(e){const t=u(e.selection);n=t;const a={selection:t,sourceEvent:e.sourceEvent,type:"start"};i.call("brushstart",void 0,a)}function s(e){const t=u(e.selection);n=t;const a={selection:t,sourceEvent:e.sourceEvent,type:"brush"};i.call("brush",void 0,a)}function c(e){const t=u(e.selection);n=t;const a={selection:t,sourceEvent:e.sourceEvent,type:"end"};i.call("brushend",void 0,a)}function u(e){if(!e)return null;const[[t,n],[a,r]]=e;return{x:[Math.min(t,a),Math.max(t,a)],y:[Math.min(n,r),Math.max(n,r)]}}function d(){r&&(r.selectAll(".selection").style("fill",e.selection.fill).style("fill-opacity",e.selection.fillOpacity).style("stroke",e.selection.stroke).style("stroke-width",e.selection.strokeWidth),e.selection.strokeDasharray&&r.selectAll(".selection").style("stroke-dasharray",e.selection.strokeDasharray),r.selectAll(".handle").style("fill",e.handles.fill).style("stroke",e.handles.stroke).style("stroke-width",e.handles.strokeWidth))}const f={enable:function(){return e.enabled=!0,t&&r&&(r.call(t),d()),f},disable:function(){return e.enabled=!1,r&&r.on(".brush",null),f},attach:function(n){if(r=n,e.enabled){const r=t||(t=a.brush().extent(e.extent).handleSize(e.handleSize).touchable(e.touchable).keyModifiers(e.keyModifiers).on("start",l).on("brush",s).on("end",c),e.filter&&t.filter(e.filter),t);n.call(r),d()}return f},detach:function(){return r&&(r.on(".brush",null),r.selectAll(".brush").remove(),r=null),f},clear:function(){return r&&t&&(r.call(t.clear),n=null,i.call("clear",void 0,{selection:null,sourceEvent:null,type:"end"})),f},getSelection:function(){return n},setSelection:function(e){if(r&&t){if(e){const n=function(e){return[[e.x[0],e.y[0]],[e.x[1],e.y[1]]]}(e);r.call(t.move,n)}else r.call(t.clear);n=e}return f},getSelectedData:function(){return n?function(e){if(!e||0===o.length)return[];const[t,n]=e.x,[a,r]=e.y;return o.filter(e=>e.x>=t&&e.x<=n&&e.y>=a&&e.y<=r)}(n):[]},setData:function(e){return o=[...e],f},configure:function(n){const a=e.extent;return Object.assign(e,n),t&&(n.extent&&n.extent!==a&&t.extent(n.extent),void 0!==n.handleSize&&t.handleSize(n.handleSize),void 0!==n.touchable&&t.touchable(n.touchable),void 0!==n.keyModifiers&&t.keyModifiers(n.keyModifiers),void 0!==n.filter&&n.filter&&t.filter(n.filter)),r&&d(),f},setExtent:function(n){return e.extent=n,t&&t.extent(n),f},isEnabled:function(){return e.enabled},on:function(e,t){return i.on(e,t),f},off:function(e,t){return i.on(e,null),f}};return f}function l(){let e=-1,t=[],n=null,r=null;function o(n,r,o){switch(n.key){case"Tab":break;case"ArrowRight":case"ArrowDown":n.preventDefault(),l(1,r,o);break;case"ArrowLeft":case"ArrowUp":n.preventDefault(),l(-1,r,o);break;case"Home":n.preventDefault(),s(0,r,o);break;case"End":n.preventDefault(),s(t.length-1,r,o);break;case"Enter":case" ":n.preventDefault(),e>=0?c(r[e],e,o):function(e,t){const n=t.formatNumber||(e=>e.toString()),a=e.reduce((e,t)=>e+t.stacks.reduce((e,t)=>e+t.value,0),0),r=`Waterfall chart with ${e.length} categories. Total value: ${n(a)}. Use arrow keys to navigate between bars.`;u(r)}(r,o);break;case"Escape":n.preventDefault(),function(){const t=a.select("svg[role='img']");if(!t.empty()){const n=t.node();n&&n.focus(),e=-1}}()}}function i(e,t,n,r,o){switch(e.key){case"Enter":case" ":e.preventDefault(),c(t,n,o),a.select(e.target).dispatch("click");break;case"ArrowRight":case"ArrowDown":e.preventDefault(),l(1,r,o);break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),l(-1,r,o)}}function l(n,a,r){if(0===t.length)return;let o=e+n;o>=t.length?o=0:o<0&&(o=t.length-1),s(o,a,r)}function s(n,a,r){if(n<0||n>=t.length)return;e=n;const o=t[n];o&&o.focus&&o.focus();!function(e,t,n){const a=n.formatNumber||(e=>e.toString()),r=e.stacks.reduce((e,t)=>e+t.value,0),o=`Focused on ${e.label}, value ${a(r)}`;u(o)}(a[n],0,r)}function c(e,t,n){const a=n.formatNumber||(e=>e.toString()),r=e.stacks.reduce((e,t)=>e+t.value,0);let o=`${e.label}: Total value ${a(r)}`;if(e.stacks.length>1){o+=`. Contains ${e.stacks.length} segments: `;o+=e.stacks.map(e=>`${e.label||a(e.value)}`).join(", ")}void 0!==e.cumulative&&(o+=`. Cumulative total: ${a(e.cumulative)}`),u(o)}function u(e){const t=a.select("#waterfall-live-region");t.empty()||t.text(e),n&&n(e)}function d(){if(window.matchMedia){if(window.matchMedia("(forced-colors: active)").matches)return!0;if(window.matchMedia("(prefers-contrast: high)").matches)return!0;if(window.matchMedia("(prefers-contrast: more)").matches)return!0;if(window.matchMedia("(inverted-colors: inverted)").matches)return!0;try{const e=document.createElement("div");e.style.color="rgb(1, 2, 3)",e.style.position="absolute",e.style.visibility="hidden",document.body.appendChild(e);const t=window.getComputedStyle(e).color;return document.body.removeChild(e),"rgb(1, 2, 3)"!==t}catch(e){return!1}}return!1}function f(){return!!window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches}return{createLiveRegion:function(e){return e.append("div").attr("id","waterfall-live-region").attr("aria-live","polite").attr("aria-atomic","true").style("position","absolute").style("left","-10000px").style("width","1px").style("height","1px").style("overflow","hidden")},createChartDescription:function(e,t,n={}){const{title:a="Waterfall Chart",summary:o="Interactive waterfall chart showing data progression",totalItems:i=(Array.isArray(t)?t.length:1),showTotal:l=!1}=n,s="waterfall-description-"+Math.random().toString(36).substr(2,9),c=e.append("div").attr("id",s).attr("class","sr-only").style("position","absolute").style("left","-10000px").style("width","1px").style("height","1px").style("overflow","hidden");let u=0,d=0,f=0;if(Array.isArray(t))u=t.reduce((e,t)=>t.stacks&&Array.isArray(t.stacks)?e+t.stacks.reduce((e,t)=>e+(t.value||0),0):e,0),d=t.filter(e=>e.stacks&&e.stacks.some(e=>(e.value||0)>0)).length,f=t.filter(e=>e.stacks&&e.stacks.some(e=>e.value<0)).length;else if(t&&"object"==typeof t&&t.children){function m(e){return e.children&&Array.isArray(e.children)?e.children.reduce((e,t)=>e+m(t),0):e.value||0}u=m(t),d=1,f=0}return c.html(`\n            <h3>${a}</h3>\n            <p>${o}</p>\n            <p>This chart contains ${i} data categories${l?" plus a total bar":""}.</p>\n            <p>Total value: ${n.formatNumber?n.formatNumber(u):u}</p>\n            <p>${d} categories have positive values, ${f} have negative values.</p>\n            <p>Use Tab to navigate between bars, Enter to hear details, and Arrow keys to move between bars.</p>\n            <p>Press Escape to return focus to the chart container.</p>\n        `),r=s,s},makeAccessible:function(n,l,s={}){const c=n.select("svg");c.attr("role","img").attr("aria-labelledby",r).attr("tabindex","0").attr("aria-describedby",r),c.on("keydown",function(e){o(e,l,s)});const u=c.selectAll(".bar-group");return u.each(function(t,n){const r=a.select(this),o=t;r.attr("role","button").attr("tabindex","-1").attr("aria-label",function(e,t,n={}){const a=e.stacks.reduce((e,t)=>e+t.value,0),r=e.stacks.length,o=n.formatNumber||(e=>e.toString());let i=`${e.label}: ${o(a)}`;r>1&&(i+=`, ${r} segments`);void 0!==e.cumulative&&(i+=`, cumulative total: ${o(e.cumulative)}`);return i+=". Press Enter for details.",i}(o,0,s)).attr("aria-describedby",`bar-description-${n}`).on("keydown",function(e){i(e,o,n,[o],s)}).on("focus",function(){e=n;const t=this;t&&function(e){a.select(e).style("outline","3px solid #4A90E2").style("outline-offset","2px")}(t)}).on("blur",function(){const e=this;e&&function(e){a.select(e).style("outline",null).style("outline-offset",null)}(e)})}),t=u.nodes().filter(e=>null!==e),{bars:u,focusableElements:t.length}},handleChartKeydown:o,handleBarKeydown:i,moveFocus:l,focusElement:s,announce:u,detectHighContrast:d,applyHighContrastStyles:function(e){if(!d())return;const t=e.select("svg");t.selectAll(".bar-group rect").style("stroke","CanvasText").style("stroke-width","2px").style("fill","ButtonFace"),t.selectAll(".x-axis, .y-axis").style("stroke","CanvasText").style("stroke-width","2px"),t.selectAll("text").style("fill","CanvasText").style("font-weight","bold"),t.selectAll(".trend-line").style("stroke","Highlight").style("stroke-width","3px"),t.selectAll(".tooltip").style("background","Canvas").style("border","2px solid CanvasText").style("color","CanvasText")},injectForcedColorsCSS:function(){if("undefined"==typeof document)return;const e="mintwaterfall-forced-colors-css";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent="\n            @media (forced-colors: active) {\n                .mintwaterfall-chart svg {\n                    forced-color-adjust: none;\n                }\n                \n                .mintwaterfall-chart .bar-group rect {\n                    stroke: CanvasText !important;\n                    stroke-width: 2px !important;\n                }\n                \n                .mintwaterfall-chart .x-axis,\n                .mintwaterfall-chart .y-axis {\n                    stroke: CanvasText !important;\n                    stroke-width: 2px !important;\n                }\n                \n                .mintwaterfall-chart text {\n                    fill: CanvasText !important;\n                    font-weight: bold !important;\n                }\n                \n                .mintwaterfall-chart .trend-line {\n                    stroke: Highlight !important;\n                    stroke-width: 3px !important;\n                }\n                \n                .mintwaterfall-tooltip {\n                    background: Canvas !important;\n                    border: 2px solid CanvasText !important;\n                    color: CanvasText !important;\n                    forced-color-adjust: none;\n                }\n            }\n            \n            @media (prefers-contrast: high) {\n                .mintwaterfall-chart .bar-group rect {\n                    stroke-width: 2px !important;\n                }\n                \n                .mintwaterfall-chart text {\n                    font-weight: bold !important;\n                }\n            }\n        ",document.head.appendChild(t)},respectsReducedMotion:f,getAccessibleAnimationDuration:function(e){return f()?0:e},validateColorContrast:function(e,t){const n=e=>{const t=a.rgb(e);return(.299*t.r+.587*t.g+.114*t.b)/255},r=n(e),o=n(t),i=(Math.max(r,o)+.05)/(Math.min(r,o)+.05);return{ratio:i,passesAA:i>=4.5,passesAAA:i>=7}},setAnnounceFunction(e){return n=e,this},getCurrentFocus:()=>e,getFocusableCount:()=>t.length}}const s=l();function c(){let e=null,t=null,n={className:"mintwaterfall-tooltip",theme:"default",position:"smart",offset:{x:10,y:-10},animation:{duration:200,easing:"ease-out"},collision:{boundary:"viewport",flip:!0,shift:!0},content:{maxWidth:300,padding:12}};function r(t){if(!e)return;const a={default:{background:"rgba(0, 0, 0, 0.9)",color:"#ffffff",border:"none",borderRadius:"6px",fontSize:"13px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.3)",maxWidth:`${n.content.maxWidth}px`,padding:`${n.content.padding}px`},light:{background:"rgba(255, 255, 255, 0.95)",color:"#333333",border:"1px solid rgba(0, 0, 0, 0.1)",borderRadius:"6px",fontSize:"13px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",maxWidth:`${n.content.maxWidth}px`,padding:`${n.content.padding}px`},minimal:{background:"#333333",color:"#ffffff",border:"none",borderRadius:"3px",fontSize:"12px",fontFamily:"monospace",boxShadow:"none",maxWidth:`${n.content.maxWidth}px`,padding:"8px 10px"},corporate:{background:"#2c3e50",color:"#ecf0f1",border:"1px solid #34495e",borderRadius:"4px",fontSize:"13px",fontFamily:"system-ui, -apple-system, sans-serif",boxShadow:"0 2px 8px rgba(0, 0, 0, 0.2)",maxWidth:`${n.content.maxWidth}px`,padding:`${n.content.padding}px`}},r=a[t]||a.default;Object.keys(r).forEach(t=>{const n=t.replace(/([A-Z])/g,"-$1").toLowerCase(),a=r[t];e.style(n,a)})}function o(t){if(!e)return;const a=t,r=e.node();if(!r)return;const o=r.getBoundingClientRect(),i=window.innerWidth,l=window.innerHeight;let s=a.pageX+n.offset.x,c=a.pageY+n.offset.y;if("smart"===n.position){const e=function(e,t,a){const r=10;let o=e.x+n.offset.x,i=e.y+n.offset.y,l=1;o+t.width+r>a.width&&(o=e.x-t.width-Math.abs(n.offset.x),l=2);i+t.height+r>a.height&&(i=e.y-t.height-Math.abs(n.offset.y),l=2===l?3:4);o<r&&(o=r);i<r&&(i=r);return{x:o,y:i,quadrant:l}}({x:a.clientX,y:a.clientY},{width:o.width,height:o.height},{width:i,height:l});s=e.x+window.pageXOffset,c=e.y+window.pageYOffset}e.style("left",`${s}px`).style("top",`${c}px`)}const i={show:function(i,l,s=null){e||e||(e=a.select("body").append("div").attr("class",n.className).style("position","absolute").style("visibility","hidden").style("pointer-events","none").style("z-index","9999").style("opacity","0").style("transition",`opacity ${n.animation.duration}ms ${n.animation.easing}`),r(n.theme));const c=function(e,t){if("function"==typeof e)return e(t);if("string"==typeof e)return e;if("object"==typeof e&&e&&"template"in e)return function(e,t,n={}){if(!t)return e;let a=e;return a=a.replace(/\{\{(\w+(?:\.\w+)*)\}\}/g,(e,a)=>{const r=(o=t,a.split(".").reduce((e,t)=>e?.[t],o));var o;const i=n[a];return i&&"function"==typeof i?i(r):null!=r?String(r):""}),a}(e.template,t,e.formatters);if(t)return function(e){const t=n.formatNumber||(e=>e.toLocaleString());let a=`<div class="tooltip-header"><strong>${e.label}</strong></div>`;if(e.stacks&&e.stacks.length>0){const n=e.stacks.reduce((e,t)=>e+t.value,0);a+=`<div class="tooltip-total">Total: ${t(n)}</div>`,e.stacks.length>1&&(a+='<div class="tooltip-stacks">',e.stacks.forEach(e=>{const n=e.color||"#666",r=e.label||t(e.value);a+=`\n                        <div class="tooltip-stack-item">\n                            <span class="tooltip-color-indicator" style="background-color: ${n}"></span>\n                            <span class="tooltip-stack-label">${r}</span>\n                            <span class="tooltip-stack-value">${t(e.value)}</span>\n                        </div>\n                    `}),a+="</div>")}return a}(t);return""}(i,s);return e.html(c).style("visibility","visible"),o(l),e.transition().duration(n.animation.duration).style("opacity","1"),t={content:i,event:l,data:s},e},hide:function(){if(e)return e.transition().duration(n.animation.duration).style("opacity","0").on("end",function(){a.select(this).style("visibility","hidden")}),t=null,e},move:function(n){if(e&&t)return o(n),e},theme:function(t){return n.theme=t,e&&r(t),i},configure:function(t){return n={...n,...t},e&&t.theme&&r(t.theme),i},destroy:function(){e&&(e.remove(),e=null),t=null},isVisible:function(){return null!==e&&"visible"===e.style("visibility")},getCurrentData:function(){return t?.data||null}};return i}function u(){const e={enabled:!0,scaleExtent:[.1,10],translateExtent:null,wheelDelta:null,touchable:!0,filter:null,constrain:{x:!0,y:!0},duration:250,ease:a.easeQuadOut};let t=null,n=a.zoomIdentity,r=null,o={width:800,height:400,margin:{top:60,right:80,bottom:60,left:80}};const i=a.dispatch("zoomstart","zoom","zoomend","reset");function l(){return t||(t=a.zoom().scaleExtent(e.scaleExtent).touchable(e.touchable).filter(e.filter||s).on("start",u).on("zoom",d).on("end",f),null!==e.wheelDelta&&t.wheelDelta(e.wheelDelta),c(),t)}function s(e){return!(e.ctrlKey&&"wheel"!==e.type||e.button)}function c(){if(!t||!o)return;const{width:n,height:a,margin:r}=o,i=n-r.left-r.right,l=a-r.top-r.bottom,s=e.translateExtent||[[2*-i,2*-l],[3*i,3*l]];t.translateExtent(s)}function u(e){const t={transform:e.transform,sourceEvent:e.sourceEvent};i.call("zoomstart",void 0,t)}function d(t){n=t.transform,e.constrain.x||(n=n.translate(-n.x,0)),e.constrain.y||(n=n.translate(0,-n.y)),r&&function(t,n){const r=t.select(".chart-group");r.empty()||r.attr("transform",n.toString());!function(t,n){if(e.constrain.x){const e=t.select(".x-axis");if(!e.empty()){const t=m(e);if(t){const r=n.rescaleX(t);e.call(a.axisBottom(r))}}}if(e.constrain.y){const e=t.select(".y-axis");if(!e.empty()){const t=m(e);if(t){const r=n.rescaleY(t);e.call(a.axisLeft(r))}}}}(t,n)}(r,n);const o={transform:n,sourceEvent:t.sourceEvent};i.call("zoom",void 0,o)}function f(e){const t={transform:e.transform,sourceEvent:e.sourceEvent};i.call("zoomend",void 0,t)}function m(e){try{const t=e.node();if(t&&t.__scale__)return t.__scale__}catch(e){}return null}function h(n,a,r=0){return t||l(),r>0?n.transition().duration(r).ease(e.ease).call(t.transform,a):n.call(t.transform,a),p}const p={enable:function(){return e.enabled=!0,t&&r&&r.call(t),p},disable:function(){return e.enabled=!1,r&&r.on(".zoom",null),p},attach:function(t){if(r=t,e.enabled){const e=l();t.call(e)}return p},detach:function(){return r&&(r.on(".zoom",null),r=null),p},transform:h,reset:function(t=e.duration){return r&&(h(r,a.zoomIdentity,t),i.call("reset",void 0,{transform:a.zoomIdentity,sourceEvent:null})),p},zoomTo:function(t,n=e.duration){if(!r||!o)return p;const{width:i,height:l,margin:s}=o,c=i-s.left-s.right,u=l-s.top-s.bottom,[d,f]=t.x,[m,g]=t.y,y=Math.min(c/(f-d),u/(g-m)),b=c/2-y*(d+f)/2,v=u/2-y*(m+g)/2,w=a.zoomIdentity.translate(b,v).scale(y);return h(r,w,n),p},setDimensions:function(e){return o=e,c(),p},configure:function(n){return Object.assign(e,n),t&&(n.scaleExtent&&t.scaleExtent(n.scaleExtent),void 0!==n.touchable&&t.touchable(n.touchable),void 0!==n.filter&&t.filter(n.filter||s),void 0!==n.wheelDelta&&n.wheelDelta&&t.wheelDelta(n.wheelDelta)),c(),p},getCurrentTransform:function(){return n},isEnabled:function(){return e.enabled},on:function(e,t){return i.on(e,t),p},off:function(e,t){return i.on(e,null),p}};return p}function d(){let e={renderTime:0,dataProcessingTime:0,memoryUsage:0,visibleElements:0,totalElements:0,fps:0,lastFrameTime:0,averageFrameTime:0,peakMemoryUsage:0,renderCalls:0},t={enabled:!1,chunkSize:1e3,renderThreshold:1e4,bufferSize:200,preloadCount:3,recycleNodes:!0},n={memoryPooling:!0},a={elements:new Map,maxSize:1e3,currentSize:0,hitCount:0,missCount:0},r=new Map,o=null,i=0,l=performance.now();function s(){if("memory"in performance){const t=performance.memory;e.memoryUsage=t.usedJSHeapSize,e.peakMemoryUsage=Math.max(e.peakMemoryUsage,t.usedJSHeapSize)}return{...e}}function c(){if(!o)return;const e=s(),n=(e.memoryUsage/1024/1024).toFixed(2),r=(e.peakMemoryUsage/1024/1024).toFixed(2);o.innerHTML=`\n            <div><strong>MintWaterfall Performance</strong></div>\n            <div>FPS: ${e.fps}</div>\n            <div>Render Time: ${e.renderTime.toFixed(2)}ms</div>\n            <div>Memory: ${n}MB (Peak: ${r}MB)</div>\n            <div>Visible Elements: ${e.visibleElements}/${e.totalElements}</div>\n            <div>Render Calls: ${e.renderCalls}</div>\n            <div>Virtualization: ${t.enabled?"ON":"OFF"}</div>\n            <div>Pool Hit Rate: ${a.hitCount+a.missCount>0?(a.hitCount/(a.hitCount+a.missCount)*100).toFixed(1):0}%</div>\n        `}const u={enableVirtualization:function(e={}){return Object.assign(t,e),t.enabled=!0,console.log("MintWaterfall: Virtualization enabled with config:",t),u},disableVirtualization:function(){return t.enabled=!1,console.log("MintWaterfall: Virtualization disabled"),u},optimizeRendering:function(n,a){const r=performance.now();e.totalElements=a.length,t.enabled&&a.length>t.renderThreshold?function(n,a){const r=n.node();if(!r)return;const o=r.clientHeight,i=r.scrollTop||0,l=30,[s,c]=function(e,n,a){const r=Math.floor(e/a),o=r+Math.ceil(n/a);return[Math.max(0,r-t.bufferSize),o+t.bufferSize]}(i,o,l),u=a.slice(s,Math.min(c,a.length));u.map((e,t)=>t+s),e.visibleElements=u.length;const d=n.selectAll(".virtual-item").data(u,(e,t)=>`item-${t+s}`);d.exit().remove();const f=d.enter().append("g").attr("class","virtual-item");d.merge(f).attr("transform",(e,t)=>`translate(0, ${(t+s)*l})`)}(n,a):function(t,n){e.visibleElements=n.length;const a=t.selectAll(".chart-element").data(n);a.exit().remove();const r=a.enter().append("g").attr("class","chart-element");a.merge(r)}(n,a);const o=performance.now();return e.renderTime=o-r,e.renderCalls++,function(){i++;const t=performance.now();t-l>=1e3&&(e.fps=Math.round(1e3*i/(t-l)),e.averageFrameTime=(t-l)/i,i=0,l=t);e.lastFrameTime=t}(),u},profileOperation:function(e,t){const n=performance.now(),a=t(),o=performance.now()-n;r.has(e)||r.set(e,{startTime:0,endTime:0,samples:[],averageTime:0,minTime:1/0,maxTime:0});const i=r.get(e);return i.samples.push(o),i.minTime=Math.min(i.minTime,o),i.maxTime=Math.max(i.maxTime,o),i.averageTime=i.samples.reduce((e,t)=>e+t,0)/i.samples.length,i.samples.length>100&&i.samples.shift(),a},getMetrics:s,resetMetrics:function(){return e={renderTime:0,dataProcessingTime:0,memoryUsage:0,visibleElements:0,totalElements:0,fps:0,lastFrameTime:0,averageFrameTime:0,peakMemoryUsage:0,renderCalls:0},r.clear(),i=0,l=performance.now(),u},enableMemoryPooling:function(e={}){return Object.assign(a,e),n.memoryPooling=!0,console.log("MintWaterfall: Memory pooling enabled"),u},createRenderBatch:function(){return{operations:[],priority:1,timestamp:performance.now(),elementCount:0}},flushRenderBatch:function(t){const n=performance.now();t.operations.sort((e,t)=>{const n=["remove","create","update","style","attribute"];return n.indexOf(e.type)-n.indexOf(t.type)}),t.operations.forEach(e=>{!function(e){const{type:t,element:n,properties:a}=e;switch(t){case"create":case"update":break;case"remove":n&&n.remove&&n.remove();break;case"style":n&&a&&Object.keys(a).forEach(e=>{n.style(e,a[e])});break;case"attribute":n&&a&&Object.keys(a).forEach(e=>{n.attr(e,a[e])})}}(e)});const a=performance.now();return e.renderTime+=a-n,u},setUpdateStrategy:function(e){return console.log(`MintWaterfall: Update strategy set to ${e}`),u},getDashboard:function(){return o},enableDashboard:function(e){o||(o=function(){const e=document.createElement("div");return e.className="mintwaterfall-performance-dashboard",e.style.cssText="\n            position: fixed;\n            top: 10px;\n            right: 10px;\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 10px;\n            border-radius: 5px;\n            font-family: monospace;\n            font-size: 12px;\n            z-index: 10000;\n            max-width: 300px;\n        ",e}());const t=e||document.body;return t&&!t.contains(o)&&t.appendChild(o),setInterval(c,500),u},disableDashboard:function(){return o&&o.parentNode&&(o.parentNode.removeChild(o),o=null),u},optimizeMemory:function(){return window.gc&&window.gc(),a.elements.forEach((e,t)=>{e.length>50&&e.splice(25)}),r.forEach(e=>{e.samples.length>50&&e.samples.splice(0,e.samples.length-50)}),console.log("MintWaterfall: Memory optimization completed"),u},getRecommendations:function(){const e=[],r=s();return r.totalElements>5e3&&!t.enabled&&e.push("Enable virtualization for improved performance with large datasets"),r.fps<30&&e.push("Consider reducing visual complexity or enabling performance optimizations"),r.memoryUsage>104857600&&e.push("Memory usage is high - consider enabling memory pooling or reducing data size"),r.renderTime>100&&e.push("Render time is slow - consider batching updates or optimizing render operations"),a.hitCount/(a.hitCount+a.missCount||1)<.5&&n.memoryPooling&&e.push("Memory pool efficiency is low - consider adjusting pool size or strategy"),e}};return u}"undefined"!=typeof document&&s.injectForcedColorsCSS();const f={default:{name:"Default",background:"#ffffff",gridColor:"#e0e0e0",axisColor:"#666666",textColor:"#333333",totalColor:"#95A5A6",colors:["#3498db","#2ecc71","#e74c3c","#f39c12","#9b59b6","#1abc9c","#e67e22","#f1c40f"],sequentialScale:{type:"sequential",interpolator:a.interpolateBlues},divergingScale:{type:"diverging",interpolator:a.interpolateRdYlBu},conditionalFormatting:{positive:"#2ecc71",negative:"#e74c3c",neutral:"#95a5a6"}},dark:{name:"Dark",background:"#2c3e50",gridColor:"#34495e",axisColor:"#bdc3c7",textColor:"#ecf0f1",totalColor:"#95a5a6",colors:["#3498db","#2ecc71","#e74c3c","#f39c12","#9b59b6","#1abc9c","#e67e22","#f1c40f"],sequentialScale:{type:"sequential",interpolator:a.interpolateViridis},divergingScale:{type:"diverging",interpolator:a.interpolatePiYG},conditionalFormatting:{positive:"#2ecc71",negative:"#e74c3c",neutral:"#95a5a6"}},corporate:{name:"Corporate",background:"#ffffff",gridColor:"#e8e8e8",axisColor:"#555555",textColor:"#333333",totalColor:"#7f8c8d",colors:["#2c3e50","#34495e","#7f8c8d","#95a5a6","#bdc3c7","#ecf0f1"],sequentialScale:{type:"sequential",interpolator:a.interpolateGreys},divergingScale:{type:"diverging",interpolator:a.interpolateRdBu},conditionalFormatting:{positive:"#27ae60",negative:"#c0392b",neutral:"#7f8c8d"}},accessible:{name:"Accessible",background:"#ffffff",gridColor:"#cccccc",axisColor:"#000000",textColor:"#000000",totalColor:"#666666",colors:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f"],sequentialScale:{type:"sequential",interpolator:e=>a.interpolateHsl("#ffffff","#000000")(e)},divergingScale:{type:"diverging",interpolator:a.interpolateRdBu},conditionalFormatting:{positive:"#1f77b4",negative:"#d62728",neutral:"#666666"}},colorful:{name:"Colorful",background:"#ffffff",gridColor:"#f0f0f0",axisColor:"#666666",textColor:"#333333",totalColor:"#34495e",colors:["#ff6b6b","#4ecdc4","#45b7d1","#f9ca24","#f0932b","#eb4d4b","#6c5ce7","#a29bfe"],sequentialScale:{type:"sequential",interpolator:a.interpolateRainbow},divergingScale:{type:"diverging",interpolator:a.interpolateSpectral},conditionalFormatting:{positive:"#4ecdc4",negative:"#ff6b6b",neutral:"#f9ca24"}}};function m(e,t="default"){const n=f[t]||f.default,r=n.sequentialScale?.interpolator||a.interpolateBlues;return a.scaleSequential(r).domain(e)}function h(e,t="default"){const n=f[t]||f.default,r=n.divergingScale?.interpolator||a.interpolateRdYlBu;return a.scaleDiverging(r).domain(e)}function p(e,t="default",n=0){const a=(f[t]||f.default).conditionalFormatting||{positive:"#2ecc71",negative:"#e74c3c",neutral:"#95a5a6"};return Math.abs(e)<=Math.abs(n)?a.neutral:e>n?a.positive:a.negative}function g(e,t="default",n="auto"){const r=e.map(e=>e.value),o=a.extent(r),i=o[0]<0&&o[1]>0;if("auto"===n&&(n=i?"diverging":"sequential"),"diverging"===n&&i){const e=Math.max(Math.abs(o[0]),Math.abs(o[1]));return h([-e,0,e],t)}return m(o,t)}function y(){const e={linear:a.curveLinear,basis:a.curveBasis,cardinal:a.curveCardinal,catmullRom:a.curveCatmullRom,monotoneX:a.curveMonotoneX,monotoneY:a.curveMonotoneY,natural:a.curveNatural,step:a.curveStep,stepBefore:a.curveStepBefore,stepAfter:a.curveStepAfter,bumpX:a.curveBumpX,bumpY:a.curveBumpY},t={circle:a.symbolCircle,square:a.symbolSquare,triangle:a.symbolTriangle,diamond:a.symbolDiamond,star:a.symbolStar,cross:a.symbolCross,wye:a.symbolWye};function n(e,t={}){const{curve:n=a.curveMonotoneX,strokeColor:r="#e74c3c",strokeWidth:o=2,opacity:i=.8}=t;return a.line().x(e=>e.x).y(e=>e.y).curve(n)(e)||""}return{createConfidenceBand:function(e,t={}){const{curve:n=a.curveMonotoneX,opacity:r=.3,fillColor:o="#95a5a6"}=t;return a.area().x(e=>e.x).y0(e=>e.yLower).y1(e=>e.yUpper).curve(n)(e)||""},createEnvelopeArea:function(e,t={}){const{curve:n=a.curveMonotoneX}=t;return a.area().x(e=>e.x).y0(e=>e.y0).y1(e=>e.y1).curve(n)(e)||""},createDataPointMarkers:function(e,n={}){const{size:r=64,fillColor:o="#3498db",strokeColor:i="#ffffff",strokeWidth:l=2}=n;return e.map(e=>{const s=t[e.type]||a.symbolCircle,c=e.size||r;return{path:a.symbol().type(s).size(c)()||"",transform:`translate(${e.x}, ${e.y})`,config:{...n,fillColor:e.color||o,strokeColor:i,strokeWidth:l}}})},createCustomSymbol:function(e,n=64){const r=t[e]||a.symbolCircle;return a.symbol().type(r).size(n)()||""},createSmoothTrendLine:n,createMultipleTrendLines:function(e){return e.map(e=>n(e.data,e.config))},getCurveTypes:function(){return{...e}},getSymbolTypes:function(){return{...t}}}}function b(e,t,n,r){const o=y();let i=0,l=0,s=0;const c=e.map((e,a)=>{i+=e.value,l+=t.optimistic[a]?.value||e.value,s+=t.pessimistic[a]?.value||e.value;return{x:(n(e.label)||0)+n.bandwidth()/2,y:r(i),yUpper:r(l),yLower:r(s),label:e.label}}),u=c.map(e=>({x:e.x,y:e.yUpper})),d=c.map(e=>({x:e.x,y:e.yLower}));return{confidencePath:o.createConfidenceBand(c,{fillColor:"rgba(52, 152, 219, 0.2)",curve:a.curveMonotoneX}),optimisticPath:o.createSmoothTrendLine(u,{strokeColor:"#27ae60",strokeWidth:2,strokeDasharray:"5,5",curve:a.curveMonotoneX}),pessimisticPath:o.createSmoothTrendLine(d,{strokeColor:"#e74c3c",strokeWidth:2,strokeDasharray:"5,5",curve:a.curveMonotoneX})}}function v(e,t,n){const a=y(),r=e.map(e=>{const a={target:{type:"star",color:"#f39c12",size:100},threshold:{type:"diamond",color:"#9b59b6",size:80},alert:{type:"triangle",color:"#e74c3c",size:90},achievement:{type:"circle",color:"#27ae60",size:85}},r=a[e.type]||a.target;return{x:(t(e.label)||0)+t.bandwidth()/2,y:n(e.value),type:r.type,size:r.size,color:r.color,label:e.description||e.label}});return a.createDataPointMarkers(r,{strokeColor:"#ffffff",strokeWidth:2})}function w(e,t,n){if(e.bandwidth){return e.bandwidth()}return n*(1-.1)/t}function x(e,t,n){return e.bandwidth?e(t):e(t)-n/2}function k(){let e=800,t=400,n={top:60,right:80,bottom:60,left:80},o=!1,l="Total",s="#95A5A6",f=!1,m=.05,h=750,y=a.easeQuadInOut,k=a.format(".0f"),M=null,S=!1,A={},C=!1,T=100,E="auto",$={enabled:!1,scaleType:"auto",themeName:"default",neutralThreshold:0},z={enabled:!1,opacity:.3,showTrendLines:!0},D={enabled:!1,milestones:[]},F=!1,P="#e74c3c",R=2,O="solid",I=.8,L="linear",W=3,q=2,B=!0,N=!1,j={},U=!0,V={},H=!1,Y={},Q=null,G=new Map,X=null,_=null;const K=r();i();const J=c();u();const Z=d();let ee=!1,te=!1,ne=1e4;const ae=a.dispatch("barClick","barMouseover","barMouseout","chartUpdate","brushSelection");function re(r){r.each(function(r){if(!r||!Array.isArray(r))return void console.warn("MintWaterfall: Invalid data provided. Expected an array.");if(0===r.length)return void console.warn("MintWaterfall: Empty data array provided.");if(!r.every(e=>e&&"string"==typeof e.label&&Array.isArray(e.stacks)&&e.stacks.every(e=>"number"==typeof e.value&&"string"==typeof e.color)))return void console.error("MintWaterfall: Invalid data structure. Each item must have a 'label' string and 'stacks' array with 'value' numbers and 'color' strings.");const i=a.select(this);let l;if("svg"===this.tagName)l=i;else{l=i.selectAll("svg").data([0]);const n=l.enter().append("svg");l=n.merge(l),l.attr("width",e).attr("height",t)}const s=l.node();if(s){const n=s.getAttribute("width"),a=s.getAttribute("height");n&&(e=parseInt(n,10)),a&&(t=parseInt(a,10))}const c=l.selectAll(".waterfall-container").data([r]),d=l,M=c.enter().append("g").attr("class","waterfall-container").merge(c);let S=M.select(".chart-group");S.empty()&&(S=M.append("g").attr("class","chart-group"));const A=`chart-clip-${Date.now()}`;l.select(`#${A}`).remove();const U=l.append("defs").append("clipPath").attr("id",A).append("rect");S.attr("clip-path",`url(#${A})`);try{r.length>=ne&&ee&&Z.enableVirtualization({chunkSize:Math.min(1e3,Math.floor(r.length/10)),renderThreshold:ne});const i=JSON.stringify(r).slice(0,100)+`_showTotal:${o}`;let s;i===X&&_?s=_:(r.length>5e4?(console.warn("MintWaterfall: Large dataset detected, using synchronous processing"),s=oe(r)):s=oe(r),X=i,_=s);const c=function(e,n){const r=e.flatMap(e=>[e.cumulativeTotal,e.prevCumulativeTotal||0]),o=a.max(r)||0,i=a.min(r)||0,l=16,s=8,c=l+s,u=20,d=i<0,f=Math.max(n.top,80);let m;const h=[t-n.bottom,f];if(d){const e=.05*(o-i);m=a.scaleLinear().domain([i-e,o+e]).range(h)}else{const e=1.02*o;m=a.scaleLinear().domain([0,e]).range(h).nice()}const p=e.map(e=>m(e.cumulativeTotal)-s),g=Math.min(...p),y=Math.max(f-g+c,c+u),b=Math.max(0,y-f);let v=0;if(d){const a=e.filter(e=>e.cumulativeTotal<0);if(a.length>0){const e=Math.max(...a.map(e=>m(e.cumulativeTotal)+l+s));e>t-n.bottom&&(v=e-(t-n.bottom))}}const w=Math.max(...e.map(e=>k(e.cumulativeTotal).length)),x=9*w,M=Math.max(n.right,x/2+15),S={top:f+b+u,right:M,bottom:n.bottom+v+(d?u:10),left:n.left};return S}(s,n);let A;if("auto"===E)A=K.createAdaptiveScale(s,"x"),A.padding&&A.padding(m);else if("time"===E){const e=s.map(e=>new Date(e.label));A=K.createTimeScale(e)}else A="ordinal"===E?K.createOrdinalScale(s.map(e=>e.label)):a.scaleBand().domain(s.map(e=>e.label)).padding(m);A.range([c.left,e-c.right]),K.setDefaultRange([c.left,e-c.right]);const V=30;U.attr("x",c.left).attr("y",Math.max(0,c.top-V)).attr("width",e-c.left-c.right).attr("height",t-c.top-c.bottom+V);const Y=s.map(e=>e.cumulativeTotal),[Q,G]=a.extent(Y);let te;if(Q<0){const e=.05*(G-Q);te=a.scaleLinear().domain([Q-e,G+e]).range([t-c.bottom,c.top])}else te=K.createLinearScale(Y,{range:[t-c.bottom,c.top],nice:!0});!function(t,n,a){const r=t.selectAll(".grid-group").data([0]),o=r.enter().append("g").attr("class","grid-group").merge(r),i=n.ticks(),l=o.selectAll(".grid-line").data(i),s=l.enter().append("line").attr("class","grid-line").attr("x1",a.left).attr("x2",e-a.right).attr("stroke","rgba(224, 224, 224, 0.5)").attr("stroke-width",1).style("opacity",0);s.merge(l).transition().duration(h).ease(y).attr("y1",e=>n(e)).attr("y2",e=>n(e)).attr("x1",a.left).attr("x2",e-a.right).style("opacity",1),l.exit().transition().duration(h).ease(y).style("opacity",0).remove()}(M,te,c),function(e,n,r,o){const i=e.selectAll(".y-axis").data([0]),l=i.enter().append("g").attr("class","y-axis").attr("transform",`translate(${o.left},0)`);l.merge(i).transition().duration(h).ease(y).call(a.axisLeft(r).tickFormat(e=>k(e)));const s=e.selectAll(".x-axis").data([0]),c=s.enter().append("g").attr("class","x-axis").attr("transform",`translate(0,${t-o.bottom})`);c.merge(s).transition().duration(h).ease(y).call(a.axisBottom(n))}(M,A,te,c),function(t,n,r,o,i){const l=t.selectAll(".bars-group").data([0]),s=l.enter().append("g").attr("class","bars-group"),c=s.merge(l).selectAll(".bar-group").data(n,e=>e.label),u=c.enter().append("g").attr("class","bar-group").attr("transform",t=>{if(r.bandwidth)return`translate(${r(t.label)}, 0)`;{const a=w(r,n.length,e-i.left-i.right);return`translate(${x(r,t.label,a)}, 0)`}}),d=u.merge(c).transition().duration(h).ease(y).attr("transform",t=>{if(r.bandwidth)return`translate(${r(t.label)}, 0)`;{const a=w(r,n.length,e-i.left-i.right);return`translate(${x(r,t.label,a)}, 0)`}});f?function(t,n,r,o){t.each(function(i){const l=a.select(this),s=i.stacks.map((e,t)=>({...e,stackIndex:t,parent:i}));let c=i.prevCumulativeTotal||0;s.forEach(e=>{e.startY=c,e.endY=c+e.value,e.y=r(Math.max(e.startY,e.endY)),e.height=Math.abs(r(e.startY)-r(e.endY)),c+=e.value});const u=l.selectAll(".stack").data(s),d=n.bandwidth?n.bandwidth():w(n,t.size(),e-o.left-o.right);u.enter().append("rect").attr("class","stack").attr("x",0).attr("width",d).attr("y",r(0)).attr("height",0).attr("fill",e=>e.color).merge(u).transition().duration(h).ease(y).attr("y",e=>e.y).attr("height",e=>e.height).attr("fill",e=>e.color).attr("width",d),u.exit().transition().duration(h).ease(y).attr("height",0).attr("y",r(0)).remove();const f=l.selectAll(".stack-label").data(s.filter(e=>e.label));f.enter().append("text").attr("class","stack-label").attr("text-anchor","middle").attr("x",d/2).attr("y",r(0)).style("opacity",0).merge(f).transition().duration(h).ease(y).attr("y",e=>e.y+e.height/2+4).attr("x",d/2).style("opacity",1).text(e=>e.label),f.exit().transition().duration(h).ease(y).style("opacity",0).remove()})}(d,r,o,i):function(t,n,r,o,i=[]){t.each(function(l){const s=a.select(this),c=n.bandwidth?n.bandwidth():w(n,t.size(),e-o.left-o.right),u=1===l.stacks.length?l.stacks[0].color:"#3498db",d=function(e,t,n){if(!$.enabled)return t;const a=$.themeName||"default";switch($.scaleType){case"conditional":return p(e,a,$.neutralThreshold);case"sequential":case"diverging":case"auto":return $.customColorScale?$.customColorScale(e):g(n.map(e=>({value:e.barTotal})),a,$.scaleType)(e);default:return t}}(l.barTotal,u,i),f=[{value:l.barTotal,color:d,y:l.isTotal?Math.min(r(0),r(l.cumulativeTotal)):r(Math.max(l.prevCumulativeTotal,l.cumulativeTotal)),height:l.isTotal?Math.abs(r(0)-r(l.cumulativeTotal)):Math.abs(r(l.prevCumulativeTotal||0)-r(l.cumulativeTotal)),parent:l}],m=s.selectAll(".waterfall-bar").data(f);m.enter().append("rect").attr("class","waterfall-bar").attr("x",0).attr("width",c).attr("y",r(0)).attr("height",0).attr("fill",e=>e.color).merge(m).transition().duration(h).ease(y).attr("y",e=>e.y).attr("height",e=>e.height).attr("fill",e=>e.color).attr("width",c),m.exit().transition().duration(h).ease(y).attr("height",0).attr("y",r(0)).remove()})}(d,r,o,i,n);(function(t,n,r,o){t.each(function(i){const l=a.select(this),s=w(n,t.size(),e-o.left-o.right),c=[{value:i.barTotal,formattedValue:k(i.barTotal),parent:i}],u=l.selectAll(".total-label").data(c);u.enter().append("text").attr("class","total-label").attr("text-anchor","middle").attr("x",s/2).attr("y",r(0)).style("opacity",0).style("font-family","Arial, sans-serif").merge(u).transition().duration(h).ease(y).attr("y",e=>r(e.parent.cumulativeTotal)-8).attr("x",s/2).style("opacity",1).style("fill","#333").style("font-weight","bold").style("font-size","14px").style("pointer-events","none").style("visibility","visible").style("display","block").attr("clip-path","none").text(e=>e.formattedValue).each(function(e){}),u.exit().transition().duration(h).ease(y).style("opacity",0).remove()})})(d,r,o,i),c.exit().transition().duration(h).ease(y).style("opacity",0).remove()}(S,s,A,te,c),function(t,a,r,o){if(f||a.length<2)return;const i=t.selectAll(".connectors-group").data([0]),l=i.enter().append("g").attr("class","connectors-group").merge(i),s=[];for(let t=0;t<a.length-1;t++){const i=a[t],l=a[t+1],c=w(r,a.length,e-n.left-n.right),u=x(r,i.label,c),d=x(r,l.label,c);s.push({x1:u+c,x2:d,y:o(i.cumulativeTotal),id:`${i.label}-${l.label}`})}const c=l.selectAll(".connector").data(s,e=>e.id);c.enter().append("line").attr("class","connector").attr("stroke","#bdc3c7").attr("stroke-width",1).attr("stroke-dasharray","3,3").style("opacity",0).attr("x1",e=>e.x1).attr("x2",e=>e.x1).attr("y1",e=>e.y).attr("y2",e=>e.y).merge(c).transition().duration(h).ease(y).delay((e,t)=>C?t*T:0).attr("x1",e=>e.x1).attr("x2",e=>e.x2).attr("y1",e=>e.y).attr("y2",e=>e.y).style("opacity",.6),c.exit().transition().duration(h).ease(y).style("opacity",0).remove()}(S,s,A,te),function(t,r,o,i){if(!F||r.length<2)return void t.selectAll(".trend-group").remove();const l=t.selectAll(".trend-group").data([0]),s=l.enter().append("g").attr("class","trend-group").merge(l),c=[],u=[];for(let t=0;t<r.length;t++){const a=r[t],l=w(o,r.length,e-n.left-n.right),s=x(o,a.label,l)+l/2,c=i(a.cumulativeTotal);u.push({x:s,y:c,value:a.cumulativeTotal})}if("linear"===L){const e=u.length,t=u.reduce((e,t,n)=>e+n,0),n=u.reduce((e,t)=>e+t.value,0),a=(e*u.reduce((e,t,n)=>e+n*t.value,0)-t*n)/(e*u.reduce((e,t,n)=>e+n*n,0)-t*t),r=(n-a*t)/e;u.forEach((e,t)=>{const n=a*t+r;c.push({x:e.x,y:i(n)})})}else if("moving-average"===L){const e=W;for(let t=0;t<u.length;t++){const n=Math.max(0,t-Math.floor(e/2)),a=Math.min(u.length,n+e),r=u.slice(n,a),o=r.reduce((e,t)=>e+t.value,0)/r.length;c.push({x:u[t].x,y:i(o)})}}else if("polynomial"===L){const e=u.length;if(e>=3){const t=q/10;for(let n=0;n<e;n++){const a=u[n];let r=a.value;if(e>2){const o=n/(e-1),i=Math.sin(o*Math.PI)*t,l=u.reduce((e,t)=>e+t.value,0)/e;r=a.value+(a.value-l)*i*.5}c.push({x:a.x,y:i(r)})}}else u.forEach(e=>{c.push({x:e.x,y:e.y})})}else u.forEach(e=>{c.push({x:e.x,y:e.y})});const d=a.line().x(e=>e.x).y(e=>e.y).curve("polynomial"===L?a.curveCardinal:"moving-average"===L?a.curveMonotoneX:a.curveLinear),f=s.selectAll(".trend-line").data([c]),m=f.enter().append("path").attr("class","trend-line").attr("fill","none").attr("stroke",P).attr("stroke-width",R).attr("stroke-opacity",I).style("opacity",0);function p(e){"dashed"===O?e.attr("stroke-dasharray","5,5"):"dotted"===O?e.attr("stroke-dasharray","2,3"):e.attr("stroke-dasharray",null)}p(m);const g=m.merge(f);p(g),g.transition().duration(h).ease(y).attr("d",d).attr("stroke",P).attr("stroke-width",R).attr("stroke-opacity",I).style("opacity",1),f.exit().transition().duration(h).ease(y).style("opacity",0).remove()}(S,s,A,te),function(e,t,n,a){if(!z.enabled||!z.scenarios)return;const r=e.selectAll(".confidence-bands-group").data([0]),o=r.enter().append("g").attr("class","confidence-bands-group").merge(r),i=b(t.map(e=>({label:e.label,value:e.barTotal})),z.scenarios,n,a),l=o.selectAll(".confidence-band").data([i.confidencePath]);if(l.enter().append("path").attr("class","confidence-band").attr("fill",`rgba(52, 152, 219, ${z.opacity||.3})`).attr("stroke","none").style("opacity",0).merge(l).transition().duration(h).ease(y).attr("d",i.confidencePath).style("opacity",1),z.showTrendLines){const e=o.selectAll(".optimistic-trend").data([i.optimisticPath]);e.enter().append("path").attr("class","optimistic-trend").attr("fill","none").attr("stroke","#27ae60").attr("stroke-width",2).attr("stroke-dasharray","5,5").style("opacity",0).merge(e).transition().duration(h).ease(y).attr("d",i.optimisticPath).style("opacity",.8);const t=o.selectAll(".pessimistic-trend").data([i.pessimisticPath]);t.enter().append("path").attr("class","pessimistic-trend").attr("fill","none").attr("stroke","#e74c3c").attr("stroke-width",2).attr("stroke-dasharray","5,5").style("opacity",0).merge(t).transition().duration(h).ease(y).attr("d",i.pessimisticPath).style("opacity",.8)}l.exit().transition().duration(h).style("opacity",0).remove()}(S,s,A,te),function(e,t,n,a){if(!D.enabled||0===D.milestones.length)return;const r=e.selectAll(".milestones-group").data([0]),o=r.enter().append("g").attr("class","milestones-group").merge(r),i=v(D.milestones,n,a),l=o.selectAll(".milestone-marker").data(i);l.enter().append("path").attr("class","milestone-marker").attr("transform",e=>e.transform).attr("d",e=>e.path).attr("fill",e=>e.config.fillColor||"#f39c12").attr("stroke",e=>e.config.strokeColor||"#ffffff").attr("stroke-width",e=>e.config.strokeWidth||2).style("opacity",0).merge(l).transition().duration(h).ease(y).attr("transform",e=>e.transform).attr("d",e=>e.path).attr("fill",e=>e.config.fillColor||"#f39c12").style("opacity",1),l.exit().transition().duration(h).style("opacity",0).remove()}(S,0,A,te),setTimeout(()=>{B&&function(e,t){if(!B)return;e.attr("role","img").attr("aria-label",`Waterfall chart with ${t.length} data points`);const n=e.selectAll("title").data([0]);n.enter().append("title").merge(n).text(`Waterfall chart showing ${f?"stacked":"sequential"} data visualization`);const r=e.selectAll("desc").data([0]);function o(e,t){e.classed("focused",!1);const n=a.select(e.nodes()[t]);n.classed("focused",!0);const r=n.datum();i(`${r.parent?.label||r.label}: ${k(r.value||r.barTotal)}`)}function i(e){const t=a.select("body").selectAll(".sr-announcement").data([0]);t.enter().append("div").attr("class","sr-announcement").attr("aria-live","polite").attr("aria-atomic","true").style("position","absolute").style("left","-10000px").style("width","1px").style("height","1px").style("overflow","hidden").merge(t).text(e)}r.enter().append("desc").merge(r).text(()=>{const e=t[t.length-1]?.cumulativeTotal||0;return`Chart contains ${t.length} data points. Final cumulative value: ${k(e)}. Data ranges from ${t[0]?.label} to ${t[t.length-1]?.label}.`}),e.attr("tabindex","0").on("keydown",function(t){const n=e.select(".focused"),a=e.selectAll(".waterfall-bar, .stack"),r=a.nodes().indexOf(n.node());switch(t.key){case"ArrowRight":case"ArrowDown":t.preventDefault();const e=Math.min(r+1,a.size()-1);o(a,e);break;case"ArrowLeft":case"ArrowUp":t.preventDefault();o(a,Math.max(r-1,0));break;case"Home":t.preventDefault(),o(a,0);break;case"End":t.preventDefault(),o(a,a.size()-1)}});const l=e.selectAll("style.accessibility-styles").data([0]);l.enter().append("style").attr("class","accessibility-styles").merge(l).text("\n                .focused {\n                    stroke: #0066cc !important;\n                    stroke-width: 3px !important;\n                    filter: brightness(1.1);\n                }\n                .waterfall-bar:focus,\n                .stack:focus {\n                    outline: 2px solid #0066cc;\n                    outline-offset: 2px;\n                }\n            ")}(l,s),N&&function(e){if(!N)return;const t=J;t.configure(j),e.selectAll(".waterfall-bar, .stack").on("mouseover",function(e,n){const r=a.select(this),o=n.parent||n,i=`\n                    <div style="font-weight: bold; margin-bottom: 8px;">${o.label}</div>\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">\n                        <span>Value:</span>\n                        <span style="font-weight: bold;">${k(n.value||o.barTotal)}</span>\n                    </div>\n                    ${void 0!==o.cumulativeTotal?`\n                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">\n                        <span>Cumulative:</span>\n                        <span style="font-weight: bold;">${k(o.cumulativeTotal)}</span>\n                    </div>\n                    `:""}\n                    ${n.label&&n.label!==o.label?`\n                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">\n                        <div style="font-size: 11px; opacity: 0.8;">${n.label}</div>\n                    </div>\n                    `:""}\n                `;t.show(i,e,{label:o.label,value:n.value||o.barTotal,cumulative:o.cumulativeTotal,color:n.color||(o.stacks&&o.stacks[0]?o.stacks[0].color:"#3498db"),x:parseFloat(r.attr("x")||"0"),y:parseFloat(r.attr("y")||"0"),quadrant:1}),r.style("opacity",.8)}).on("mousemove",function(e){t.move(e)}).on("mouseout",function(){t.hide(),a.select(this).style("opacity",null)}),e.selectAll(".total-label").on("mouseover",function(e,n){const a=n.parent,r=`\n                    <div style="font-weight: bold; margin-bottom: 8px;">${a.label}</div>\n                    <div style="display: flex; justify-content: space-between;">\n                        <span>Total Value:</span>\n                        <span style="font-weight: bold;">${k(a.barTotal)}</span>\n                    </div>\n                `;t.show(r,e,{label:a.label,value:a.barTotal,cumulative:a.cumulativeTotal,color:"#333",x:0,y:0,quadrant:1})}).on("mousemove",function(e){t.move(e)}).on("mouseout",function(){t.hide()})}(l),H?(re.zoomSystemInstance||(re.zoomSystemInstance=u()),re.zoomSystemInstance.attach(d),re.zoomSystemInstance.setDimensions({width:e,height:t,margin:c}),re.zoomSystemInstance.enable()):re.zoomSystemInstance&&(re.zoomSystemInstance.disable(),re.zoomSystemInstance.detach())},50)}catch(n){console.error("MintWaterfall rendering error:",n),console.error("Stack trace:",n.stack),M.selectAll("*").remove(),M.append("text").attr("x",e/2).attr("y",t/2).attr("text-anchor","middle").style("font-size","14px").style("fill","#ff6b6b").text(`Chart Error: ${n.message}`)}})}function oe(e){let t=[...e];Q&&Q.enabled&&(t=function(e){return e}(t));let n=0,a=0;const r=t.map((e,t)=>{const r=e.stacks.reduce((e,t)=>e+t.value,0);a=n,n+=r;let o=e.stacks;G.size>0&&(o=e.stacks);return{...e,stacks:o,barTotal:r,cumulativeTotal:n,prevCumulativeTotal:0===t?0:a}});if(o&&r.length>0){const e=n;r.push({label:l,stacks:[{value:e,color:s}],barTotal:e,cumulativeTotal:e,prevCumulativeTotal:0})}return r}return re.width=function(t){return arguments.length?(e=t,re):e},re.height=function(e){return arguments.length?(t=e,re):t},re.margin=function(e){return arguments.length?(n=e,re):n},re.stacked=function(e){return arguments.length?(f=e,re):f},re.showTotal=function(e){return arguments.length?(o=e,re):o},re.totalLabel=function(e){return arguments.length?(l=e,re):l},re.totalColor=function(e){return arguments.length?(s=e,re):s},re.barPadding=function(e){return arguments.length?(m=e,re):m},re.duration=function(e){return arguments.length?(h=e,re):h},re.ease=function(e){return arguments.length?(y=e,re):y},re.formatNumber=function(e){return arguments.length?(k=e,re):k},re.theme=function(e){return arguments.length?(M=e,re):M},re.enableBrush=function(e){return arguments.length?(S=e,re):S},re.brushOptions=function(e){return arguments.length?(A={...A,...e},re):A},re.staggeredAnimations=function(e){return arguments.length?(C=e,re):C},re.staggerDelay=function(e){return arguments.length?(T=e,re):T},re.scaleType=function(e){return arguments.length?(E=e,re):E},re.showTrendLine=function(e){return arguments.length?(F=e,re):F},re.trendLineColor=function(e){return arguments.length?(P=e,re):P},re.trendLineWidth=function(e){return arguments.length?(R=e,re):R},re.trendLineStyle=function(e){return arguments.length?(O=e,re):O},re.trendLineOpacity=function(e){return arguments.length?(I=e,re):I},re.trendLineType=function(e){return arguments.length?(L=e,re):L},re.trendLineWindow=function(e){return arguments.length?(W=e,re):W},re.trendLineDegree=function(e){return arguments.length?(q=e,re):q},re.enableAccessibility=function(e){return arguments.length?(B=e,re):B},re.enableTooltips=function(e){return arguments.length?(N=e,re):N},re.tooltipConfig=function(e){return arguments.length?(j={...j,...e},re):j},re.enableExport=function(e){return arguments.length?(U=e,re):U},re.exportConfig=function(e){return arguments.length?(V={...V,...e},re):V},re.enableZoom=function(e){return arguments.length?(H=e,re):H},re.zoomConfig=function(e){return arguments.length?(Y={...Y,...e},re):Y},re.breakdownConfig=function(e){return arguments.length?(Q=e,re):Q},re.enablePerformanceOptimization=function(e){return arguments.length?(ee=e,re):ee},re.performanceDashboard=function(e){return arguments.length?(te=e,re):te},re.virtualizationThreshold=function(e){return arguments.length?(ne=e,re):ne},re.data=function(e){return re},re.advancedColors=function(e){return arguments.length?($={...$,...e},re):$},re.enableAdvancedColors=function(e){return arguments.length?($.enabled=e,re):$.enabled},re.colorScaleType=function(e){return arguments.length?($.scaleType=e,re):$.scaleType},re.confidenceBands=function(e){return arguments.length?(z={...z,...e},re):z},re.enableConfidenceBands=function(e){return arguments.length?(z.enabled=e,re):z.enabled},re.milestones=function(e){return arguments.length?(D={...D,...e},re):D},re.enableMilestones=function(e){return arguments.length?(D.enabled=e,re):D.enabled},re.addMilestone=function(e){return D.milestones.push(e),re},re.on=function(){const e=ae.on.apply(ae,Array.from(arguments));return e===ae?re:e},re}function M(e,t={}){const{valueColumn:n="value",labelColumn:a="label",colorColumn:r="color",defaultColor:o="#3498db",parseNumbers:i=!0}=t;if(!Array.isArray(e))throw new Error("Data must be an array");return e.map((e,t)=>{if(e.label&&Array.isArray(e.stacks))return e;const l=e[a]||`Item ${t+1}`;let s=e[n];i&&"string"==typeof s?s=parseFloat(s.replace(/[,$]/g,""))||0:"number"!=typeof s&&(s=0);const c=e[r]||o;return{label:String(l),stacks:[{value:s,color:c,label:e.stackLabel||`${s>=0?"+":""}${s}`}]}})}function S(){function e(e){if(!e||!Array.isArray(e))throw new Error("Data must be an array");if(0===e.length)throw new Error("Data array cannot be empty");return e.every((e,t)=>{if(!e||"object"!=typeof e)throw new Error(`Item at index ${t} must be an object`);if("string"!=typeof e.label)throw new Error(`Item at index ${t} must have a string 'label' property`);if(!Array.isArray(e.stacks))throw new Error(`Item at index ${t} must have an array 'stacks' property`);if(0===e.stacks.length)throw new Error(`Item at index ${t} must have at least one stack`);return e.stacks.forEach((e,n)=>{if("number"!=typeof e.value||isNaN(e.value))throw new Error(`Stack ${n} in item ${t} must have a numeric 'value'`);if("string"!=typeof e.color)throw new Error(`Stack ${n} in item ${t} must have a string 'color'`)}),!0})}return{validateData:e,loadData:async function(e,t={}){return await async function(e,t={}){try{let n;if("string"==typeof e)if(e.endsWith(".csv"))n=await a.csv(e);else if(e.endsWith(".json"))n=await a.json(e);else if(e.endsWith(".tsv"))n=await a.tsv(e);else{if(!e.startsWith("http"))throw new Error(`Unsupported file format: ${e}`);{const t=await fetch(e),r=t.headers.get("content-type");if(r?.includes("application/json"))n=await t.json();else if(r?.includes("text/csv")){const e=await t.text();n=a.csvParse(e)}else n=await t.json()}}else{if(!Array.isArray(e))throw new Error("Source must be a URL, file path, or data array");n=e}return M(n,t)}catch(e){throw console.error("Error loading data:",e),e}}(e,t)},transformToWaterfallFormat:function(e,t={}){return M(e,t)},aggregateData:function(t,n="sum"){return e(t),t.map(e=>{let t;switch(n){case"sum":default:t=e.stacks.reduce((e,t)=>e+t.value,0);break;case"average":t=e.stacks.reduce((e,t)=>e+t.value,0)/e.stacks.length;break;case"max":t=Math.max(...e.stacks.map(e=>e.value));break;case"min":t=Math.min(...e.stacks.map(e=>e.value))}return{...e,aggregatedValue:t,originalStacks:e.stacks}})},sortData:function(t,n="label",a="ascending"){return e(t),[...t].sort((e,t)=>{let r,o,i;switch(n){case"label":default:r=e.label.toLowerCase(),o=t.label.toLowerCase();break;case"total":const n=e.stacks.reduce((e,t)=>e+t.value,0),a=t.stacks.reduce((e,t)=>e+t.value,0);r=Math.abs(n),o=Math.abs(a);break;case"maxStack":r=Math.max(...e.stacks.map(e=>e.value)),o=Math.max(...t.stacks.map(e=>e.value));break;case"minStack":r=Math.min(...e.stacks.map(e=>e.value)),o=Math.min(...t.stacks.map(e=>e.value))}return i="string"==typeof r&&"string"==typeof o?r.localeCompare(o):r-o,"ascending"===a?i:-i})},filterData:function(t,n){return e(t),t.filter(n)},getDataSummary:function(t){e(t);const n=[],a=[];let r=0;t.forEach(e=>{e.stacks.forEach(e=>{n.push(e.value),a.push(e.color),r++})});const o={min:Math.min(...n),max:Math.max(...n)},i=n.reduce((e,t)=>e+t,0),l=[...new Set(a)],s=t.map(e=>e.label);return{totalItems:t.length,totalStacks:r,valueRange:o,cumulativeTotal:i,stackColors:l,labels:s}},transformData:function(t,n){return e(t),t.map(n)},groupData:function(t,n){e(t);const a=new Map;return t.forEach(e=>{const t="function"==typeof n?n(e):e.label;a.has(t)||a.set(t,[]),a.get(t).push(e)}),a},transformStacks:function(e,t){if("function"!=typeof t)throw new Error("Transformer must be a function");return e.map(e=>({...e,stacks:e.stacks.map(t)}))},normalizeValues:function(e,t){let n=0;if(e.forEach(e=>{e.stacks.forEach(e=>{n=Math.max(n,Math.abs(e.value))})}),0===n)return e;const a=t/n;return e.map(e=>({...e,stacks:e.stacks.map(e=>({...e,originalValue:e.value,value:e.value*a}))}))},groupByCategory:function(e,t){if("function"!=typeof t)throw new Error("Category function must be a function");const n={};return e.forEach(e=>{const a=t(e);n[a]||(n[a]=[]),n[a].push(e)}),n},calculatePercentages:function(e){return e.map(e=>{const t=e.stacks.reduce((e,t)=>e+Math.abs(t.value),0);return{...e,stacks:e.stacks.map(e=>({...e,percentage:0===t?0:Math.abs(e.value)/t*100}))}})},interpolateData:function(e,t,n){if(e.length!==t.length)throw new Error("Data arrays must have the same length");return e.map((e,a)=>{const r=t[a],o=Math.min(e.stacks.length,r.stacks.length);return{label:e.label,stacks:Array.from({length:o},(t,a)=>({value:e.stacks[a].value+(r.stacks[a].value-e.stacks[a].value)*n,color:e.stacks[a].color,label:e.stacks[a].label}))}})},generateSampleData:function(e,t,n=[10,100]){const[a,r]=n,o=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];return Array.from({length:e},(e,n)=>({label:`Item ${n+1}`,stacks:Array.from({length:t},(e,t)=>({value:Math.random()*(r-a)+a,color:o[t%o.length],label:`Stack ${t+1}`}))}))},groupBy:function(e,...t){if(!Array.isArray(e))throw new Error("Data must be an array");if(0===t.length)throw new Error("At least one grouping key must be provided");if(1===t.length)return a.group(e,t[0]);if(2===t.length)return a.group(e,t[0],t[1]);if(3===t.length)return a.group(e,t[0],t[1],t[2]);throw new Error("Maximum 3 levels of grouping supported")},rollupBy:function(e,t,...n){if(!Array.isArray(e))throw new Error("Data must be an array");if("function"!=typeof t)throw new Error("Reducer must be a function");if(0===n.length)throw new Error("At least one grouping key must be provided");if(1===n.length)return a.rollup(e,t,n[0]);if(2===n.length)return a.rollup(e,t,n[0],n[1]);if(3===n.length)return a.rollup(e,t,n[0],n[1],n[2]);throw new Error("Maximum 3 levels of rollup supported")},flatRollupBy:function(e,t,...n){if(!Array.isArray(e))throw new Error("Data must be an array");if("function"!=typeof t)throw new Error("Reducer must be a function");if(0===n.length)throw new Error("At least one grouping key must be provided");return a.flatRollup(e,t,...n)},crossTabulate:function(e,t,n){if(!Array.isArray(e)||!Array.isArray(t))throw new Error("Both data arrays must be arrays");return n?a.cross(e,t,(e,t)=>({row:e,col:t,value:n(e,t)})):a.cross(e,t,(e,t)=>({row:e,col:t,value:void 0}))},indexBy:function(e,...t){if(!Array.isArray(e))throw new Error("Data must be an array");if(0===t.length)throw new Error("At least one indexing key must be provided");if(1===t.length)return a.index(e,t[0]);if(2===t.length)return a.index(e,t[0],t[1]);throw new Error("Maximum 2 levels of indexing supported")},aggregateByTime:function(e,t){const{timeAccessor:n,valueAccessor:r,interval:o,aggregation:i="sum"}=t;if(!Array.isArray(e))throw new Error("Data must be an array");if("function"!=typeof n||"function"!=typeof r)throw new Error("Time and value accessors must be functions");const l=a.rollup(e,e=>{switch(i){case"sum":default:return a.sum(e,r);case"average":return a.mean(e,r)||0;case"max":return a.max(e,r)||0;case"min":return a.min(e,r)||0}},e=>o(n(e)));return Array.from(l.entries()).map(([e,t])=>({label:a.timeFormat("%Y-%m-%d")(e),stacks:[{value:t,color:t>=0?"#2ecc71":"#e74c3c",label:`${t>=0?"+":""}${a.format(".2f")(t)}`}]}))},createMultiDimensionalWaterfall:function(e,t,n){if(!Array.isArray(e)||!Array.isArray(t))throw new Error("Data and groupKeys must be arrays");if(0===t.length)throw new Error("At least one group key must be provided");const r=t.map(e=>t=>t[e]);return a.flatRollup(e,e=>a.sum(e,e=>e[n]||0),...r).map(e=>{const t=e.slice(0,-1),n=e[e.length-1],r=["#3498db","#2ecc71","#f39c12","#e74c3c","#9b59b6"];return{label:t.join("  "),stacks:[{value:n,color:r[Math.abs(t.join("").split("").reduce((e,t)=>e+t.charCodeAt(0),0))%r.length],label:`${n>=0?"+":""}${a.format(".2f")(n)}`}]}})},aggregateWaterfallByPeriod:function(t,n,r){e(t);const o=a.rollup(t,e=>{const t=[];e.forEach(e=>t.push(...e.stacks));const n=a.rollup(t,e=>({value:a.sum(e,e=>e.value),label:e[0].label,color:e[0].color}),e=>e.color);return Array.from(n.values())},e=>{const t=e[n]||e.label,a=new Date(t);return isNaN(a.getTime())?new Date:r(a)});return Array.from(o.entries()).map(([e,t])=>({label:a.timeFormat("%Y-%m-%d")(e),stacks:t}))},createBreakdownWaterfall:function(e,t,n,r){if(!Array.isArray(e))throw new Error("Data must be an array");const o=a.rollup(e,e=>a.sum(e,e=>e[r]||0),e=>e[t],e=>e[n]);return Array.from(o.entries()).map(([e,t])=>{const n=Array.from(t.entries()).map(([e,t],n)=>{const r=["#3498db","#2ecc71","#f39c12","#e74c3c","#9b59b6","#1abc9c","#34495e"];return{value:t,color:r[n%r.length],label:`${e}: ${t>=0?"+":""}${a.format(".2f")(t)}`}});return{label:String(e),stacks:n}})}}}const A=S();const C={sum:e=>a.sum(e,e=>e.value||0),average:e=>a.mean(e,e=>e.value||0)||0,weightedAverage:(e,t="weight")=>{const n=a.sum(e,e=>e[t]||0);return 0===n?0:a.sum(e,e=>(e.value||0)*(e[t]||0))/n},variance:e=>{const t=a.mean(e,e=>e.value||0)||0;return a.mean(e,e=>Math.pow((e.value||0)-t,2))||0},percentile:e=>t=>{const n=t.map(e=>e.value||0).sort(a.ascending);return a.quantile(n,e/100)||0}},T={group:a.group,rollup:a.rollup,flatRollup:a.flatRollup,cross:a.cross,index:a.index,sum:a.sum,mean:a.mean,median:a.median,quantile:a.quantile,min:a.min,max:a.max,extent:a.extent,ascending:a.ascending,descending:a.descending};function E(){function e(e){const t=e.filter(e=>null!=e&&!isNaN(e)).sort(a.ascending);if(0===t.length)throw new Error("No valid data points for statistical analysis");const n=t.length,r=a.sum(t),o=a.mean(t)||0,i=a.median(t)||0,l=a.variance(t)||0,s=a.deviation(t)||0,c=a.min(t)||0,u=a.max(t)||0,d=u-c,f=a.quantile(t,.25)||0,m=i,h=a.quantile(t,.75)||0;return{count:n,sum:r,mean:o,median:i,variance:l,standardDeviation:s,min:c,max:u,range:d,quartiles:{q1:f,q2:m,q3:h,iqr:h-f},percentiles:{p5:a.quantile(t,.05)||0,p10:a.quantile(t,.1)||0,p25:f,p75:h,p90:a.quantile(t,.9)||0,p95:a.quantile(t,.95)||0}}}function t(t,n=[]){const a=e(t),{q1:r,q3:o,iqr:i}=a.quartiles,l=r-1.5*i,s=o+1.5*i,c=r-3*i,u=o+3*i,d=[],f=[];t.forEach((e,t)=>{if(null==e||isNaN(e))return;const a=e<c||e>u;e<l||e>s?d.push({value:e,index:t,label:n[t],severity:a?"extreme":"mild",type:e<l?"lower":"upper"}):f.push({value:e,index:t,label:n[t]})});const m=d.filter(e=>"mild"===e.severity).length,h=d.filter(e=>"extreme"===e.severity).length;return{outliers:d,cleanData:f,summary:{totalOutliers:d.length,mildOutliers:m,extremeOutliers:h,outlierPercentage:d.length/t.length*100}}}function n(e){return a.bisector(e)}return{calculateSummary:e,detectOutliers:t,assessDataQuality:function(e,n={}){const{expectedRange:r,allowedTypes:o=["number"],nullTolerance:i=.05,duplicateTolerance:l=.1}=n,s=e.length;let c=0,u=0,d=0;const f=new Set,m=new Set;e.forEach(e=>{if(null==e)return void c++;const t=typeof e;o.includes(t)&&u++,"number"==typeof e&&r?e>=r[0]&&e<=r[1]&&d++:r||d++;const n=JSON.stringify(e);m.has(n)?f.add(n):m.add(n)});const h=(s-c)/s*100,p=u/s*100,g=d/s*100,y=e.filter(e=>"number"==typeof e&&!isNaN(e)),b=y.length>0?(a.deviation(y)||0)/(a.mean(y)||1):0,v=Math.max(0,100-100*b),w=y.length>0?t(y):{outliers:[],cleanData:[],summary:{totalOutliers:0,mildOutliers:0,extremeOutliers:0,outlierPercentage:0}},x=[];return h<100*(1-i)&&x.push(`Improve data completeness: ${c} missing values detected`),p<95&&x.push(`Validate data types: ${s-u} invalid types found`),g<90&&r&&x.push(`Check data accuracy: ${s-d} values outside expected range`),f.size>l*s&&x.push(`Remove duplicates: ${f.size} duplicate values detected`),w.summary.outlierPercentage>5&&x.push(`Investigate outliers: ${w.summary.totalOutliers} outliers detected (${w.summary.outlierPercentage.toFixed(1)}%)`),{completeness:h,consistency:v,accuracy:g,validity:p,duplicates:f.size,anomalies:w,recommendations:x}},analyzeVariance:function(e){const t=e.map(e=>e.value),n=a.variance(t)||0,r=t.filter(e=>e>0),o=t.filter(e=>e<0),i=r.length>0&&a.variance(r)||0,l=o.length>0&&a.variance(o)||0,s=a.mean(t)||0,c=e.map(e=>{const t=Math.pow(e.value-s,2),a=n>0?t/n*100:0;return{label:e.label,value:e.value,variance:t,contribution:a}}),u=[...c].sort((e,t)=>t.contribution-e.contribution),d=u.slice(0,Math.min(5,u.length)).map(e=>({label:e.label,impact:e.contribution>20?"high":e.contribution>10?"medium":"low",variance:e.variance}));return{totalVariance:n,positiveVariance:i,negativeVariance:l,varianceContributions:c,significantFactors:d}},analyzeTrend:function(e){if(e.length<2)throw new Error("At least 2 data points required for trend analysis");const t=e.map(e=>e.x),n=e.map(e=>e.y),r=a.mean(t)||0,o=a.mean(n)||0;let i=0,l=0;for(let a=0;a<e.length;a++){const e=t[a]-r;i+=e*(n[a]-o),l+=e*e}const s=0!==l?i/l:0,c=a.deviation(t)||0,u=a.deviation(n)||0,d=c*u!==0?i/(Math.sqrt(l)*u*Math.sqrt(e.length-1)):0,f=s>.01?"increasing":s<-.01?"decreasing":"stable",m=Math.abs(d)>.7?"strong":Math.abs(d)>.3?"moderate":"weak",h=100*Math.abs(d),p=Math.max(...t),g=Array.from({length:3},(t,i)=>{const l=p+(i+1),c=o+s*(l-r),u=Math.sqrt(a.variance(n)||0)/Math.sqrt(e.length);return{period:l,value:c,confidence:{lower:c-1.96*u,upper:c+1.96*u}}});return{slope:s,correlation:d,direction:f,strength:m,confidence:h,projectedValues:g}},createBisector:n,createSearch:function(e,t){const r=n(t),o=[...e].sort((e,n)=>a.ascending(t(e),t(n)));return e=>{const n=r.left(o,e);if(0===n)return o[0];if(n>=o.length)return o[o.length-1];const a=o[n-1],i=o[n];return Math.abs(t(a)-e)<=Math.abs(t(i)-e)?a:i}},calculateMovingAverage:function(e,t){if(t<=0||t>e.length)throw new Error("Invalid window size for moving average");const n=[];for(let r=0;r<=e.length-t;r++){const o=e.slice(r,r+t),i=a.mean(o)||0;n.push(i)}return n},calculateExponentialSmoothing:function(e,t){if(t<0||t>1)throw new Error("Alpha must be between 0 and 1");const n=[];let a=e[0];n.push(a);for(let r=1;r<e.length;r++)a=t*e[r]+(1-t)*a,n.push(a);return n},detectSeasonality:function(e,t){if(e.length<2*t)return!1;const n=a.mean(e)||0;let r=0,o=0;for(let a=0;a<e.length-t;a++)r+=(e[a]-n)*(e[a+t]-n);for(let t=0;t<e.length;t++)o+=Math.pow(e[t]-n,2);const i=0!==o?r/o:0;return Math.abs(i)>.3}}}function $(){let e=a.quadtree().x(e=>e.x).y(e=>e.y);return{quadTree:e,search:function(t,n,a=10){const r=[];return e.visit((e,o,i,l,s)=>{if(!e.length){const o=e;if(o.data){Math.sqrt(Math.pow(o.data.x-t,2)+Math.pow(o.data.y-n,2))<=a&&r.push(o.data)}}return o>t+a||i>n+a||l<t-a||s<n-a}),r},findNearest:function(t,n){return e.find(t,n)},add:function(t){e.add(t)},remove:function(t){e.remove(t)},clear:function(){e=a.quadtree().x(e=>e.x).y(e=>e.y)},size:function(){let t=0;return e.visit(()=>(t++,!1)),t}}}function z(e){let t={...e},n=0,a=0,r=60;function o(e){const n=Math.floor(e/t.itemHeight),a=Math.ceil((e+t.containerHeight)/t.itemHeight);return{start:Math.max(0,n-t.overscan),end:a+t.overscan}}return{getVisibleRange:o,getVirtualizedData:function(e,i){const l=performance.now();if(!(e.length>=t.threshold)){const n=performance.now();return{visibleData:e,offsetY:0,totalHeight:e.length*t.itemHeight,metrics:{renderTime:n-l,dataProcessingTime:n-l,memoryUsage:P(),frameRate:r,itemsRendered:e.length,totalItems:e.length,virtualizationActive:!1}}}const{start:s,end:c}=o(i),u=e.slice(s,Math.min(c,e.length)),d=s*t.itemHeight,f=e.length*t.itemHeight,m=performance.now();if(a++,a%60==0){const e=performance.now();n>0&&(r=6e4/(e-n)),n=e}return{visibleData:u,offsetY:d,totalHeight:f,metrics:{renderTime:m-l,dataProcessingTime:m-l,memoryUsage:P(),frameRate:r,itemsRendered:u.length,totalItems:e.length,virtualizationActive:!0}}},updateConfig:function(e){t={...t,...e}},destroy:function(){}}}function D(e){const t=document.createElement("canvas"),n=t.getContext("2d");return e.appendChild(t),{render:function(e,a){const{xScale:r,yScale:o}=a;n.clearRect(0,0,t.width,t.height),n.save(),e.forEach((e,t)=>{const a=r(e.label)||0,i=o(e.value)||0,l=r.bandwidth?r.bandwidth():20,s=Math.abs(o(0)-i);n.fillStyle=e.color||"#3498db",n.fillRect(a,Math.min(i,o(0)),l,s),n.strokeStyle="#ffffff",n.lineWidth=1,n.strokeRect(a,Math.min(i,o(0)),l,s)}),n.restore()},clear:function(){n.clearRect(0,0,t.width,t.height)},getCanvas:function(){return t},setDimensions:function(e,n){t.width=e,t.height=n,t.style.width=`${e}px`,t.style.height=`${n}px`},enableHighDPI:function(){const e=window.devicePixelRatio||1,a=t.getBoundingClientRect();t.width=a.width*e,t.height=a.height*e,t.style.width=`${a.width}px`,t.style.height=`${a.height}px`,n.scale(e,e)}}}function F(){const e=new Map,t=new Map;let n=0,r=performance.now();function o(){const e=t.get("render")||[],o=t.get("dataProcessing")||[];return{renderTime:e.length>0&&a.mean(e)||0,dataProcessingTime:o.length>0&&a.mean(o)||0,memoryUsage:P(),frameRate:n>0?1e3/((performance.now()-r)/n):0,itemsRendered:0,totalItems:0,virtualizationActive:!1}}return{startTiming:function(t){e.set(t,performance.now())},endTiming:function(n){const a=e.get(n);if(!a)return console.warn(`No start time found for timing label: ${n}`),0;const r=performance.now()-a;t.has(n)||t.set(n,[]),t.get(n).push(r);const o=t.get(n);return o.length>100&&o.shift(),e.delete(n),r},getMetrics:o,getMemoryUsage:P,trackFrameRate:function(){n++,1===n&&(r=performance.now())},generateReport:function(){const e=o();return`\nPerformance Report:\n- Average Render Time: ${e.renderTime.toFixed(2)}ms\n- Average Processing Time: ${e.dataProcessingTime.toFixed(2)}ms\n- Memory Usage: ${e.memoryUsage.toFixed(2)}MB\n- Frame Rate: ${e.frameRate.toFixed(1)}fps\n- Items Rendered: ${e.itemsRendered}/${e.totalItems}\n- Virtualization: ${e.virtualizationActive?"Active":"Inactive"}\n        `.trim()}}}function P(){if("memory"in performance){return performance.memory.usedJSHeapSize/1048576}return 0}function R(e,t=1e3){if(e.length<=t)return e;const n=Math.ceil(e.length/t),a=[];for(let t=0;t<e.length;t+=n)a.push(e[t]);return a}function O(e){switch(e){case"uniform":return(e,t)=>{if(t>=e.length)return e;const n=e.length/t,a=[];for(let r=0;r<t;r++){const t=Math.floor(r*n);a.push(e[t])}return a};case"random":return(e,t)=>{if(t>=e.length)return e;return[...e].sort(()=>.5-Math.random()).slice(0,t)};case"importance":return(e,t)=>{if(t>=e.length)return e;const n=[e[0]];if(t>2){const a=O("uniform")(e.slice(1,-1),t-2);n.push(...a)}return t>1&&n.push(e[e.length-1]),n};default:throw new Error(`Unknown sampling strategy: ${e}`)}}function I(){return{createSpatialIndex:$,createVirtualScrollManager:z,createCanvasRenderer:D,createPerformanceMonitor:F,optimizeDataForRendering:R,createDataSampler:O}}function L(){function e(e){if(!Array.isArray(e)||e.length<2)return[];e.map(e=>"number"==typeof e?e:void 0!==e.value?e.value:e.stacks&&Array.isArray(e.stacks)?e.stacks.reduce((e,t)=>e+(t.value||0),0):0);return a.pairs(e,(e,a)=>{const r=t(e),o=t(a)-r,i=0!==r?o/Math.abs(r)*100:0;let l;l=Math.abs(o)<.01?"neutral":o>0?"increase":"decrease";const s=Math.abs(i);let c;return c=s<5?"small":s<20?"medium":"large",{from:n(e),to:n(a),change:o,changePercent:i,changeDirection:l,magnitude:c}})}function t(e){return"number"==typeof e?e:void 0!==e.value?e.value:e.stacks&&Array.isArray(e.stacks)?e.stacks.reduce((e,t)=>e+(t.value||0),0):0}function n(e){return"string"==typeof e?e:void 0!==e.label?e.label:void 0!==e.name?e.name:"Unnamed"}function r(e,n){const a={...e[0]},r=e.reduce((e,n)=>e+t(n),0);return void 0!==a.value&&(a.value=r),void 0!==a[n]&&(a[n]=r),a.stacks&&(a.stacks=e.flatMap(e=>e.stacks||[])),a}function o(e,n){switch(n){case"first":default:return e[0];case"last":return e[e.length-1];case"max":return e.reduce((e,n)=>t(n)>t(e)?n:e);case"min":return e.reduce((e,n)=>t(n)<t(e)?n:e)}}function i(e,n){const r={...e[0]},o=a.mean(e,t)||0;return void 0!==r.value&&(r.value=o),void 0!==r[n]&&(r[n]=o),r}function l(e,n){const r={...e[0]},o=a.sum(e,t);return void 0!==r.value&&(r.value=o),void 0!==r[n]&&(r[n]=o),r}function s(e,a){const r=t(e),o=t(a),i=n(e),l=n(a);return(1-Math.abs(r-o)/(Math.abs(r)+Math.abs(o)+1)+(i===l?1:0))/2}return{analyzeSequence:e,optimizeDataOrder:function(e,r){if(!Array.isArray(e)||0===e.length)return e;const{field:o,direction:i,strategy:l,groupBy:s}=r;let c;switch(l){case"value":c=a.range(e.length).sort((n,r)=>{const o=t(e[n]),l=t(e[r]);return"ascending"===i?a.ascending(o,l):a.descending(o,l)});break;case"cumulative":const r=function(e){const n=e.map(t),a=[];let r=0;for(const e of n)r+=e,a.push(r);return a}(e);c=a.range(e.length).sort((e,t)=>"ascending"===i?a.ascending(r[e],r[t]):a.descending(r[e],r[t]));break;case"magnitude":c=a.range(e.length).sort((n,r)=>{const o=Math.abs(t(e[n])),l=Math.abs(t(e[r]));return"ascending"===i?a.ascending(o,l):a.descending(o,l)});break;case"alphabetical":c=a.range(e.length).sort((t,r)=>{const o=n(e[t]),l=n(e[r]);return"ascending"===i?a.ascending(o,l):a.descending(o,l)});break;default:return e}return a.permute(e,c)},mergeDatasets:function(e,t){if(!Array.isArray(e)||0===e.length)return[];const{mergeStrategy:s,conflictResolution:c,keyField:u,valueField:d}=t,f=a.merge(e),m=a.group(f,e=>e[u]||n(e)),h=[];for(const[e,t]of m){if(1===t.length){h.push(t[0]);continue}let e;switch(s){case"combine":e=r(t,d);break;case"override":e=o(t,c);break;case"average":e=i(t,d);break;case"sum":e=l(t,d);break;default:e=t[0]}h.push(e)}return h},generateCustomTicks:function(e,t){const{count:n=10,step:r,nice:o=!0,threshold:i=0,includeZero:l=!0}=t;let s,[c,u]=e;if(o){const e=a.scaleLinear().domain([c,u]).nice();[c,u]=e.domain()}return s=void 0!==r?a.ticks(c,u,Math.abs(u-c)/r):a.ticks(c,u,n),i>0&&(s=s.filter(e=>Math.abs(e)>=i)),l&&!s.includes(0)&&c<=0&&u>=0&&(s.push(0),s.sort(a.ascending)),s},createDataPairs:function(e,t){return t?a.pairs(e,(e,n)=>({a:t(e),b:t(n)})):a.pairs(e)},permuteByIndices:function(e,t){return a.permute(e,t)},mergeSimilarItems:function(e,t){const n=[],a=new Set;for(let r=0;r<e.length;r++){if(a.has(r))continue;const o=[e[r]];a.add(r);for(let n=r+1;n<e.length;n++){if(a.has(n))continue;s(e[r],e[n])>=t&&(o.push(e[n]),a.add(n))}n.push(o)}return n.map(e=>1===e.length?e[0]:function(e){return r(e,"value")}(e))},validateSequentialData:function(e){const a=[];if(!Array.isArray(e))return a.push("Data must be an array"),{isValid:!1,errors:a};e.length<2&&a.push("Data must have at least 2 items for sequence analysis");const r=e.filter((e,n)=>{const a=t(e);return isNaN(a)||!isFinite(a)});r.length>0&&a.push(`Found ${r.length} items with invalid values`);const o=e.map(n),i=new Set(o);return o.length!==i.size&&a.push("Duplicate labels detected - may cause confusion in sequence analysis"),{isValid:0===a.length,errors:a}},detectDataAnomalies:function(e){const n=e.map(t),r=a.mean(n)||0,o=2*(a.deviation(n)||0);return e.filter((e,t)=>{const a=n[t];return Math.abs(a-r)>o})},suggestDataOptimizations:function(n){const a=[],r=n.map(t),o=e(n);r.some(e=>0===e)&&a.push("Consider removing or combining zero-value items"),o.filter(e=>"small"===e.magnitude).length>.3*n.length&&a.push("Many small changes detected - consider grouping similar items");return function(e){if(e.length<3)return!1;let t=0;for(let n=1;n<e.length-1;n++){const a=e[n-1],r=e[n],o=e[n+1];(a>0&&r<0&&o>0||a<0&&r>0&&o<0)&&t++}return t>.3*e.length}(r)&&a.push("Alternating positive/negative pattern detected - consider reordering by magnitude"),n.length>20&&a.push("Large dataset - consider using hierarchical grouping or filtering"),a}}}function W(){function e(e){return"number"==typeof e?e:void 0!==e.value?e.value:e.stacks&&Array.isArray(e.stacks)?e.stacks.reduce((e,t)=>e+(t.value||0),0):0}function t(e){return"string"==typeof e?e:void 0!==e.label?e.label:void 0!==e.name?e.name:"Unnamed"}return{createTreemapLayout:function(e,t){const n=a.hierarchy(e).sum(e=>e.value||0).sort((e,t)=>(t.value||0)-(e.value||0));return a.treemap().size([t.width,t.height]).padding(t.padding).tile(t.tile).round(t.round)(n)},renderTreemap:function(e,t,n){const r=n.colorScale||a.scaleOrdinal(a.schemeCategory10),o=e.selectAll(".treemap-group").data([0]),i=o.enter().append("g").attr("class","treemap-group").merge(o),l=t.leaves(),s=i.selectAll(".treemap-cell").data(l,e=>e.data.name),c=s.enter().append("g").attr("class","treemap-cell");c.append("rect").attr("class","treemap-rect"),c.append("text").attr("class","treemap-label"),c.append("text").attr("class","treemap-value");const u=c.merge(s);u.select(".treemap-rect").transition().duration(750).attr("x",e=>e.x0).attr("y",e=>e.y0).attr("width",e=>e.x1-e.x0).attr("height",e=>e.y1-e.y0).attr("fill",e=>r(e.data.category||e.data.name)).attr("stroke","#fff").attr("stroke-width",1).attr("opacity",.8),u.select(".treemap-label").attr("x",e=>(e.x0+e.x1)/2).attr("y",e=>(e.y0+e.y1)/2-8).attr("text-anchor","middle").attr("font-size",e=>Math.min(12,(e.x1-e.x0)/8)).attr("fill","#333").text(e=>e.data.name),u.select(".treemap-value").attr("x",e=>(e.x0+e.x1)/2).attr("y",e=>(e.y0+e.y1)/2+8).attr("text-anchor","middle").attr("font-size",e=>Math.min(10,(e.x1-e.x0)/10)).attr("fill","#666").text(e=>{return t=e.value||0,Math.abs(t)>=1e6?`${(t/1e6).toFixed(1)}M`:Math.abs(t)>=1e3?`${(t/1e3).toFixed(1)}K`:t.toFixed(0);var t}),u.style("cursor","pointer").on("click",(e,t)=>{n.onNodeClick&&n.onNodeClick(t)}).on("mouseenter",(e,t)=>{a.select(e.currentTarget).select(".treemap-rect").attr("opacity",1).attr("stroke-width",2),n.onNodeHover&&n.onNodeHover(t)}).on("mouseleave",(e,t)=>{a.select(e.currentTarget).select(".treemap-rect").attr("opacity",.8).attr("stroke-width",1)}),s.exit().transition().duration(300).attr("opacity",0).remove()},createPartitionLayout:function(e,t){const n=a.hierarchy(e).sum(e=>e.value||0).sort((e,t)=>(t.value||0)-(e.value||0));return a.partition().size([2*Math.PI,Math.min(t.width,t.height)/2])(n)},renderPartition:function(e,t,n){const r=n.colorScale||a.scaleOrdinal(a.schemeCategory10),o=Math.min(n.width,n.height)/2,i=(n.innerRadius,e.selectAll(".partition-group").data([0])),l=i.enter().append("g").attr("class","partition-group").attr("transform",`translate(${n.width/2}, ${n.height/2})`).merge(i);"sunburst"===n.type?function(e,t,n,r,o,i){const l=a.arc().startAngle(e=>e.x0).endAngle(e=>e.x1).innerRadius(e=>Math.sqrt(e.y0)*r/Math.sqrt(t.y1)).outerRadius(e=>Math.sqrt(e.y1)*r/Math.sqrt(t.y1)),s=t.descendants().filter(e=>e.depth>0),c=e.selectAll(".partition-arc").data(s,e=>e.data.name),u=c.enter().append("path").attr("class","partition-arc").attr("fill",e=>n(e.data.category||e.data.name)).attr("stroke","#fff").attr("stroke-width",1).style("cursor","pointer");u.merge(c).transition().duration(750).attr("d",l),u.merge(c).on("click",(e,t)=>{i.onNodeClick&&i.onNodeClick(t)}),c.exit().transition().duration(300).attr("opacity",0).remove()}(l,t,r,o,0,n):function(e,t,n,a){const r=t.descendants(),o=e.selectAll(".partition-rect").data(r,e=>e.data.name),i=o.enter().append("rect").attr("class","partition-rect").attr("fill",e=>n(e.data.category||e.data.name)).attr("stroke","#fff").attr("stroke-width",1).style("cursor","pointer");i.merge(o).transition().duration(750).attr("x",e=>e.y0).attr("y",e=>e.x0).attr("width",e=>e.y1-e.y0).attr("height",e=>e.x1-e.x0),i.merge(o).on("click",(e,t)=>{a.onNodeClick&&a.onNodeClick(t)}),o.exit().transition().duration(300).attr("opacity",0).remove()}(l,t,r,n)},createClusterLayout:function(e,t){const n=a.hierarchy(e),r=a.cluster().size([t.width,t.height]).nodeSize(t.nodeSize);return t.separation&&r.separation(t.separation),r(n)},renderCluster:function(e,t,n){const r=e.selectAll(".cluster-group").data([0]),o=r.enter().append("g").attr("class","cluster-group").merge(r),i=t.descendants(),l=t.links(),s=o.selectAll(".cluster-link").data(l,e=>`${e.source.data.name}-${e.target.data.name}`);s.enter().append("path").attr("class","cluster-link").attr("fill","none").attr("stroke",n.linkColor||"#999").attr("stroke-width",1).merge(s).transition().duration(750).attr("d",a.linkHorizontal().x(e=>e.y||0).y(e=>e.x||0)),s.exit().remove();const c=o.selectAll(".cluster-node").data(i,e=>e.data.name),u=c.enter().append("g").attr("class","cluster-node");u.append("circle").attr("r",5).attr("fill",n.nodeColor||"#69b3a2"),u.append("text").attr("dy",3).attr("x",8).style("font-size","12px").text(e=>e.data.name),u.merge(c).transition().duration(750).attr("transform",e=>`translate(${e.y},${e.x})`),c.exit().transition().duration(300).attr("opacity",0).remove()},createPackLayout:function(e,t){const n=a.hierarchy(e).sum(t.sizeAccessor||(e=>e.value||0)).sort((e,t)=>(t.value||0)-(e.value||0));return a.pack().size([t.width,t.height]).padding(t.padding)(n)},renderPack:function(e,t,n){const r=n.colorScale||a.scaleOrdinal(a.schemeCategory10),o=e.selectAll(".pack-group").data([0]),i=o.enter().append("g").attr("class","pack-group").merge(o),l=t.descendants().filter(e=>e.depth>0),s=i.selectAll(".pack-node").data(l,e=>e.data.name),c=s.enter().append("g").attr("class","pack-node");c.append("circle").attr("class","pack-circle").style("cursor","pointer"),c.append("text").attr("class","pack-label").attr("text-anchor","middle").attr("dy","0.3em").style("font-size","10px").style("fill","#333").style("pointer-events","none");const u=c.merge(s);u.transition().duration(750).attr("transform",e=>`translate(${e.x},${e.y})`),u.select(".pack-circle").transition().duration(750).attr("r",e=>e.r).attr("fill",e=>r(e.data.category||e.data.name)).attr("stroke","#fff").attr("stroke-width",1).attr("opacity",.7),u.select(".pack-label").text(e=>e.r>15?e.data.name:"").attr("font-size",e=>Math.min(e.r/3,12)),u.on("click",(e,t)=>{n.onNodeClick&&n.onNodeClick(t)}).on("mouseenter",(e,t)=>{a.select(e.currentTarget).select(".pack-circle").attr("opacity",1).attr("stroke-width",2)}).on("mouseleave",(e,t)=>{a.select(e.currentTarget).select(".pack-circle").attr("opacity",.7).attr("stroke-width",1)}),s.exit().transition().duration(300).attr("opacity",0).remove()},transformWaterfallToHierarchy:function(n){const r=a.group(n,e=>e.category||"Default"),o=[];for(const[n,i]of r){const r={name:n,value:a.sum(i,t=>Math.abs(e(t))),category:n,children:i.map(a=>({name:t(a),value:Math.abs(e(a)),category:n,metadata:a}))};o.push(r)}return{name:"Root",children:o,value:a.sum(o,e=>e.value||0)}},createDrillDownNavigation:function(e){const t=[];return function e(n,a=[]){const r=[...a,n.name];t.push({path:r,name:n.name,value:n.value,level:r.length-1,hasChildren:!!(n.children&&n.children.length>0)}),n.children&&n.children.forEach(t=>e(t,r))}(e),t},calculateHierarchicalMetrics:function(e){return{depth:e.depth,height:e.height,value:e.value,leafCount:e.leaves().length,descendants:e.descendants().length,ancestors:e.ancestors().length,totalValue:e.descendants().reduce((e,t)=>e+(t.value||0),0),averageValue:e.value&&e.leaves().length?e.value/e.leaves().length:0}}}}"undefined"!=typeof window&&window.d3&&(window.d3.waterfallChart=k),e.analyzeWaterfallStatistics=function(e,t={}){const n=E(),a=e.map(e=>e.value),r=n.calculateSummary(a),o=n.analyzeVariance(e),i=n.assessDataQuality(a,{expectedRange:t.currency?[-1e6,1e6]:void 0}),l=[];if(o.significantFactors.length>0){const e=o.significantFactors[0];l.push(`${e.label} is the primary driver of variance (${e.impact} impact)`)}r.standardDeviation>Math.abs(r.mean)&&l.push("High volatility detected - consider risk management strategies");const s=a.filter(e=>e>0).length/a.filter(e=>e<0).length;return s>2?l.push("Predominantly positive contributors - strong growth pattern"):s<.5&&l.push("Predominantly negative contributors - potential cost management focus needed"),i.anomalies.summary.outlierPercentage>10&&l.push(`${i.anomalies.summary.totalOutliers} outliers detected - data validation recommended`),{summary:r,variance:o,quality:i,insights:l}},e.applyTheme=function(e,t="default"){const n=f[t]||f.default;return e.totalColor(n.totalColor),n},e.createAccessibilitySystem=l,e.createAdvancedDataProcessor=L,e.createAdvancedInteractionSystem=function(e,t,n){let r=null,o=!1,i=null,l=[],s=new Map;function c(t){t.enabled?(r=a.drag().on("start",(e,n)=>{a.select(e.sourceEvent.target).raise().attr("stroke","#ff6b6b").attr("stroke-width",2),t.onDragStart&&t.onDragStart(e,n),p("dragStart",{event:e,data:n})}).on("drag",(e,r)=>{const o=a.select(e.sourceEvent.target);let i=r.value||0;if("vertical"===t.axis||"both"===t.axis){const a=e.y;if(i=n.invert(a),t.constraints){const{minValue:e,maxValue:n,snapToGrid:a,gridSize:r}=t.constraints;void 0!==e&&(i=Math.max(e,i)),void 0!==n&&(i=Math.min(n,i)),a&&r&&(i=Math.round(i/r)*r)}const l=Math.abs(n(0)-n(i)),s=n(i>=0?i:0);o.attr("y",s).attr("height",l),r.value=i,r.stacks&&r.stacks.length>0&&(r.stacks[0].value=i)}if("horizontal"===t.axis||"both"===t.axis){const t=e.x,n=parseFloat(o.attr("width")||"0");o.attr("transform",`translate(${t-n/2}, 0)`)}t.onDrag&&t.onDrag(e,r),p("drag",{event:e,data:r,newValue:i})}).on("end",(e,n)=>{a.select(e.sourceEvent.target).attr("stroke",null).attr("stroke-width",null),t.onDragEnd&&t.onDragEnd(e,n),p("dragEnd",{event:e,data:n})}),e.selectAll(".bar").call(r),p("dragEnabled",t)):u()}function u(){r&&(e.selectAll(".bar").on(".drag",null),r=null,p("dragDisabled"))}function d(t){if(!t.enabled||0===l.length)return void f();o=!0;const a=e.selectAll(".enhanced-hover-group").data([0]),r=a.enter().append("g").attr("class","enhanced-hover-group").merge(a).selectAll(".hover-zone").data(l);r.enter().append("rect").attr("class","hover-zone").merge(r).attr("x",e=>g(e)-.75*b()).attr("y",e=>Math.min(y(e),n(0))-10).attr("width",e=>1.5*b()).attr("height",e=>Math.abs(n(0)-y(e))+20).style("fill","transparent").style("pointer-events","all").on("mouseenter",function(n,a){var r;r=a,e.selectAll(".bar").filter(e=>e===r).transition().duration(150).attr("opacity",.8).attr("stroke","#ff6b6b").attr("stroke-width",2),t.onCellEnter&&t.onCellEnter(n,a),p("enhancedHoverEnter",{event:n,data:a})}).on("mouseleave",function(n,a){var r;r=a,e.selectAll(".bar").filter(e=>e===r).transition().duration(150).attr("opacity",1).attr("stroke",null).attr("stroke-width",null),t.onCellLeave&&t.onCellLeave(n,a),p("enhancedHoverLeave",{event:n,data:a})}).on("click",function(e,n){t.onCellClick&&t.onCellClick(e,n),p("enhancedHoverClick",{event:e,data:n})}),r.exit().remove(),p("enhancedHoverEnabled",t)}function f(){e.selectAll(".enhanced-hover-group").remove(),o=!1,p("enhancedHoverDisabled")}function m(r){if(!r.enabled||0===l.length)return a.forceSimulation([]);if(h(),i=a.forceSimulation(l),r.forces.collision&&i.force("collision",a.forceCollide().radius(e=>b()/2+5).strength(r.strength.collision||.7)),r.forces.centering){const e=(t.range()[0]+t.range()[1])/2,o=(n.range()[0]+n.range()[1])/2;i.force("center",a.forceCenter(e,o).strength(r.strength.centering||.1))}if(r.forces.positioning&&(i.force("x",a.forceX(e=>g(e)).strength(r.strength.positioning||.5)),i.force("y",a.forceY(e=>y(e)).strength(r.strength.positioning||.5))),r.forces.links&&l.length>1){const e=l.slice(1).map((e,t)=>({source:l[t],target:e}));i.force("link",a.forceLink(e).distance(50).strength(r.strength.links||.3))}if(i.on("tick",()=>{!function(){if(!i)return;e.selectAll(".bar").data(l).attr("transform",e=>{const t=e.x||g(e),n=e.y||y(e);return`translate(${t-b()/2}, ${n})`})}(),r.onTick&&i&&r.onTick(i),p("forceTick",i)}),i.on("end",()=>{r.onEnd&&i&&r.onEnd(i),p("forceEnd",i)}),r.duration){const e=.001,t=1-Math.pow(e,1/r.duration);i.alphaDecay(t)}return p("forceSimulationStarted",r),i}function h(){i&&(i.stop(),i=null,p("forceSimulationStopped"))}function p(e,t){const n=s.get(e);n&&n(t)}function g(e){const n=t;return n.bandwidth?(n(e.label)||0)+n.bandwidth()/2:n(parseFloat(e.label)||0)}function y(e){const t=e.value||(e.stacks&&e.stacks[0]?e.stacks[0].value:0);return n(t/2)}function b(e){const n=t;return n.bandwidth?n.bandwidth():40}return{enableDrag:c,disableDrag:u,updateDragConstraints:function(e){p("dragConstraintsUpdated",e)},enableEnhancedHover:d,disableEnhancedHover:f,updateHoverExtent:function(e){if(o){d({enabled:!0,extent:e})}},startForceSimulation:m,stopForceSimulation:h,updateForces:function(e){i&&(e.collision||i.force("collision",null),e.centering||i.force("center",null),e.positioning||(i.force("x",null),i.force("y",null)),e.links||i.force("link",null),i.alpha(1).restart(),p("forcesUpdated",e))},setInteractionMode:function(e){u(),f(),h();const a=t.range()||[0,800],r=n.range()||[400,0];switch(e){case"drag":c({enabled:!0,axis:"vertical",constraints:{snapToGrid:!0,gridSize:10}});break;case"voronoi":d({enabled:!0,extent:[[0,0],[a[1],r[0]]]});break;case"force":m({enabled:!0,forces:{collision:!0,positioning:!0},strength:{collision:.7,positioning:.5},duration:1e3});break;case"combined":d({enabled:!0,extent:[[0,0],[a[1],r[0]]]}),c({enabled:!0,axis:"vertical"})}p("interactionModeChanged",e)},getActiveInteractions:function(){const e=[];return r&&e.push("drag"),o&&e.push("hover"),i&&e.push("force"),e},on:function(e,t){s.set(e,t)},off:function(e){s.delete(e)},trigger:p}},e.createAdvancedPerformanceSystem=I,e.createAnimationSystem=function(){const e={staggerDelay:100,defaultDuration:750,defaultEase:"easeOutQuad"},t={linear:e=>e,easeInQuad:e=>e*e,easeOutQuad:e=>e*(2-e),easeInOutQuad:e=>e<.5?2*e*e:(4-2*e)*e-1,easeInCubic:e=>e*e*e,easeOutCubic:e=>--e*e*e+1,easeInOutCubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,easeInSine:e=>1-Math.cos(e*Math.PI/2),easeOutSine:e=>Math.sin(e*Math.PI/2),easeInOutSine:e=>-(Math.cos(Math.PI*e)-1)/2,easeInElastic:e=>{const t=2*Math.PI/3;return 0===e?0:1===e?1:-Math.pow(2,10*e-10)*Math.sin((10*e-10.75)*t)},easeOutElastic:e=>{const t=2*Math.PI/3;return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin((10*e-.75)*t)+1},easeOutBounce:e=>{const t=7.5625,n=2.75;return e<1/n?t*e*e:e<2/n?t*(e-=1.5/n)*e+.75:e<2.5/n?t*(e-=2.25/n)*e+.9375:t*(e-=2.625/n)*e+.984375}};function n(e,n,a,r="easeOutQuad",o,i){const l=performance.now(),s=n-e,c=t[r]||t.easeOutQuad;requestAnimationFrame(function t(n){const r=n-l,u=Math.min(r/a,1),d=c(u);o&&o(e+s*d,u),u<1?requestAnimationFrame(t):i&&i()})}function a(e,t,a,r=500,o="easeOutQuad"){return new Promise(i=>{n(t,a,r,o,t=>{e&&e.style?e.style.opacity=t.toString():e&&e.attr&&e.attr("opacity",t)},()=>i())})}function r(e,t,a,r=500,o="easeOutQuad"){return new Promise(i=>{n(t,a,r,o,t=>{e&&e.style?e.style.transform=`translateX(${t}px)`:e&&e.attr&&e.attr("transform",`translate(${t}, 0)`)},()=>i())})}function o(e,t,a,r=500,o="easeOutQuad"){return new Promise(i=>{n(t,a,r,o,t=>{e&&e.style?e.style.transform=`scale(${t})`:e&&e.attr&&e.attr("transform",`scale(${t})`)},()=>i())})}function i(){const e=[];let t=!1;const n={add:function(t,a=0){return e.push({fn:t,delay:a}),n},parallel:function(...t){return e.push({fn:()=>Promise.all(t.map(e=>e())),delay:0}),n},play:async function(){if(t)throw new Error("Sequence is already running");t=!0;try{for(const t of e)t.delay>0&&await new Promise(e=>setTimeout(e,t.delay)),await t.fn()}finally{t=!1}},stop:function(){t=!1},get isRunning(){return t}};return n}const l={slideInLeft:(e,t=500)=>r(e,-100,0,t,"easeOutQuad"),slideInRight:(e,t=500)=>r(e,100,0,t,"easeOutQuad"),fadeIn:(e,t=500)=>a(e,0,1,t,"easeOutQuad"),fadeOut:(e,t=500)=>a(e,1,0,t,"easeOutQuad"),scaleIn:(e,t=500)=>o(e,0,1,t,"easeOutElastic"),scaleOut:(e,t=500)=>o(e,1,0,t,"easeInQuad"),pulse:(e,t=300)=>i().add(()=>o(e,1,1.1,t/2,"easeOutQuad")).add(()=>o(e,1.1,1,t/2,"easeInQuad")).play(),bounce:(e,t=600)=>o(e,0,1,t,"easeOutBounce")};return{easingFunctions:t,animateValue:n,staggeredAnimation:function(e,t,n=100,a=1e3){if(!Array.isArray(e))throw new Error("Items must be an array");e.forEach((e,r)=>{const o=r*n,i=a-o;setTimeout(()=>{i>0&&t(e,r,i)},o)})},morphShape:function(e,n,a=1e3,r="easeInOutQuad",o,i){if("string"!=typeof e||"string"!=typeof n)throw new Error("Path values must be strings");const l=performance.now(),s=t[r]||t.easeInOutQuad;requestAnimationFrame(function t(r){const c=r-l,u=Math.min(c/a,1),d=s(u);o&&o(u<.5?e:n,d),u<1?requestAnimationFrame(t):i&&i()})},fadeTransition:a,slideTransition:r,scaleTransition:o,createTransitionSequence:i,createSpringAnimation:function(e=300,t=20){return{animate:function(n,a,r,o){let i=n,l=0,s=performance.now();requestAnimationFrame(function n(c){const u=(c-s)/1e3;s=c;const d=i-a;l+=(-e*d+-t*l)*u,i+=l*u,r&&r(i),Math.abs(d)<.01&&Math.abs(l)<.01?o&&o():requestAnimationFrame(n)})}}},createStaggeredTransition:function(t,n,a={}){const{delay:r=e.staggerDelay,duration:o=e.defaultDuration,ease:i=e.defaultEase,reverse:l=!1}=a,s=Array.isArray(t)?t:Array.from(t),c=l?[...s].reverse():s;return Promise.all(c.map((e,t)=>new Promise(a=>{setTimeout(()=>{n(e,o,i).then(a)},t*r)})))},createCustomTween:function(e,t,n){return function(a){return"function"==typeof n?n(e,t,a):e+(t-e)*a}},createTransitionWithEvents:function(t,n){const{duration:a=e.defaultDuration,onStart:r,onEnd:o,onInterrupt:i}=n;let l=!1;return{start(){return r&&r(),this},interrupt(){return l=!0,i&&i(),this},then(e){return!l&&o&&setTimeout(()=>{o(),e&&e()},a),this}}},transitionConfig:e,presets:l}},e.createBrushSystem=function(){const e={createBrush:function(e={}){const{type:t="xy"}=e;switch(t){case"x":return a.brushX();case"y":return a.brushY();default:return a.brush()}},filterDataByBrush:function(e,t,n){if(!t||!n)return e;const[a,r]=t;return e.filter(e=>{const t=n(e.x||e.label||e.value);return t>=a&&t<=r})},getSelectedIndices:function(e,t,n){if(!t||!n)return[];const[a,r]=t,o=[];return e.forEach((e,t)=>{const i=n(e.x||e.label||e.value);i>=a&&i<=r&&o.push(t)}),o},selectionUtils:{createSelectionSummary(e){if(!e||0===e.length)return{count:0,sum:0,average:0,min:0,max:0};const t=e.map(e=>e.cumulativeTotal||e.value||e.y||0),n=t.reduce((e,t)=>e+t,0),a=Math.min(...t),r=Math.max(...t);return{count:e.length,sum:n,average:n/e.length,min:a,max:r,extent:[a,r]}}},onStart:t=>e,onMove:t=>e,onEnd:t=>e};return e},e.createComparisonWaterfall=function(e,t,n,r){const o=a.index(t,n);return e.map(e=>{const t=n(e),i=r(e),l=o.get(t),s=i-(l?r(l):0);return{label:t,stacks:[{value:s,color:s>=0?"#2ecc71":"#e74c3c",label:`Change: ${s>=0?"+":""}${a.format(".2f")(s)}`}]}})},e.createDataProcessor=S,e.createDivergingScale=h,e.createExportSystem=function(){let e={filename:"waterfall-chart",quality:1,scale:1,background:"#ffffff",padding:20,includeStyles:!0,includeData:!0};function t(t,n={}){const a={...e,...n};try{const e=t.select("svg");if(e.empty())throw new Error("No SVG element found in chart container");const n=e.node(),o=new XMLSerializer,i=n.cloneNode(!0);a.includeStyles&&function(e){try{const t=Array.from(document.styleSheets);let n="";if(t.forEach(e=>{try{Array.from(e.cssRules||e.rules).forEach(e=>{if(e.type===CSSRule.STYLE_RULE){const t=e;t.selectorText&&(t.selectorText.includes(".mintwaterfall")||t.selectorText.includes("svg")||t.selectorText.includes("chart"))&&(n+=t.cssText)}})}catch(e){console.warn("Could not access stylesheet:",e)}}),n){const t=document.createElementNS("http://www.w3.org/2000/svg","style");t.textContent=n,e.insertBefore(t,e.firstChild)}}catch(e){console.warn("Failed to add inline styles:",e)}}(i),a.background&&"transparent"!==a.background&&function(e,t){const n=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttribute("width","100%"),n.setAttribute("height","100%"),n.setAttribute("fill",t),e.insertBefore(n,e.firstChild)}(i,a.background);const l=o.serializeToString(i),s=new Blob([l],{type:"image/svg+xml;charset=utf-8"});return{blob:s,url:URL.createObjectURL(s),data:l,download:()=>r(s,`${a.filename}.svg`)}}catch(e){throw console.error("SVG export failed:",e),e}}function n(n,a={}){const o={...e,scale:2,quality:.95,...a};return new Promise((e,a)=>{try{const i=n.select("svg");if(i.empty())return void a(new Error("No SVG element found in chart container"));const l=i.node().getBBox(),s=(l.width+2*o.padding)*o.scale,c=(l.height+2*o.padding)*o.scale,u=document.createElement("canvas");u.width=s,u.height=c;const d=u.getContext("2d");if(!d)return void a(new Error("Failed to get canvas context"));d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",o.background&&"transparent"!==o.background&&(d.fillStyle=o.background,d.fillRect(0,0,s,c));const f=t(n,{...o,includeStyles:!0,background:"transparent"}),m=new Image;m.onload=()=>{try{d.drawImage(m,o.padding*o.scale,o.padding*o.scale),u.toBlob(t=>{t?(URL.revokeObjectURL(f.url),e({blob:t,url:URL.createObjectURL(t),data:f.data,download:()=>r(t,`${o.filename}.png`)})):a(new Error("Failed to create PNG blob"))},"image/png",o.quality)}catch(e){a(new Error(`PNG rendering failed: ${e}`))}},m.onerror=()=>{a(new Error("Failed to load SVG image for PNG conversion"))},m.src=`data:image/svg+xml;base64,${btoa(f.data)}`}catch(e){a(new Error(`PNG export failed: ${e}`))}})}function a(e,t=","){if(!e||0===e.length)return"";const n=Object.keys(e[0]);return[n.join(t),...e.map(e=>n.map(n=>{const a=e[n],r=null!=a?String(a):"";return r.includes(t)||r.includes('"')||r.includes("\n")?`"${r.replace(/"/g,'""')}"`:r}).join(t))].join("\n")}function r(e,t){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}const o={exportSVG:t,exportPNG:n,exportPDF:function(t,a={}){const o={...e,orientation:"landscape",pageFormat:"a4",...a};return new Promise((e,a)=>{if("undefined"!=typeof window&&window.jsPDF)try{n(t,{...o,scale:2,quality:.95}).then(t=>{const n=new(0,window.jsPDF)({orientation:o.orientation,unit:"mm",format:o.pageFormat}),i=n.internal.pageSize.getWidth(),l=n.internal.pageSize.getHeight(),s=new FileReader;s.onload=()=>{try{const a=s.result,c=new Image;c.onload=()=>{const s=c.width/c.height;let u=i-20,d=u/s;d>l-20&&(d=l-20,u=d*s);const f=(i-u)/2,m=(l-d)/2;n.addImage(a,"PNG",f,m,u,d);const h=n.output("blob");URL.revokeObjectURL(t.url),e({blob:h,url:URL.createObjectURL(h),data:h,download:()=>r(h,`${o.filename}.pdf`)})},c.src=a}catch(e){a(new Error(`PDF generation failed: ${e}`))}},s.onerror=()=>{a(new Error("Failed to read PNG data for PDF conversion"))},s.readAsDataURL(t.blob)}).catch(a)}catch(e){a(new Error(`PDF export failed: ${e}`))}else a(new Error('jsPDF library is required for PDF export. Please include it: <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>'))})},exportData:function(t,n={}){const o={...e,dataFormat:"json",includeMetadata:!0,delimiter:",",...n};try{let e,n,i;switch(o.dataFormat){case"json":const r=o.includeMetadata?{data:t,metadata:{exportDate:(new Date).toISOString(),count:t.length}}:t;e=JSON.stringify(r,null,2),n="application/json",i="json";break;case"csv":e=a(t,o.delimiter||","),n="text/csv",i="csv";break;case"tsv":e=a(t,"\t"),n="text/tab-separated-values",i="tsv";break;default:throw new Error(`Unsupported data export format: ${o.dataFormat}`)}const l=new Blob([e],{type:`${n};charset=utf-8`});return{blob:l,url:URL.createObjectURL(l),data:e,download:()=>r(l,`${o.filename}.${i}`)}}catch(e){throw console.error("Data export failed:",e),e}},configure:function(t){return e={...e,...t},o},downloadFile:function(e,t,n="text/plain"){r(e instanceof Blob?e:new Blob([e],{type:n}),t)}};return o},e.createHierarchicalLayout=function(){let e=[800,400],t=0,n=!1,r="treemap",o=0,i=0,l=0,s=0,c=0,u=0,d=1.618033988749895,f={orientation:"horizontal"},m={nodeSize:null,separation:null};function h(r){const d=a.treemap().size(e).round(n).padding(t);return void 0!==o&&d.paddingInner(o),void 0!==i&&d.paddingOuter(i),void 0!==l&&d.paddingTop(l),void 0!==s&&d.paddingRight(s),void 0!==c&&d.paddingBottom(c),void 0!==u&&d.paddingLeft(u),d(r)}const p=function(o){if(!o)throw console.error("MintWaterfall: No hierarchical data provided to layout"),new Error("No hierarchical data provided");const i=o;switch(r){case"treemap":return h(i);case"partition":return function(r){const o=a.partition().size(e).round(n).padding(t)(r);"vertical"===f.orientation&&o.each(e=>{if(void 0!==e.x0&&void 0!==e.y0&&void 0!==e.x1&&void 0!==e.y1){const t=e.x0;e.x0=e.y0,e.y0=t;const n=e.x1;e.x1=e.y1,e.y1=n}});return o}(i);case"pack":return function(n){return a.pack().size(e).padding(t)(n)}(i);case"cluster":return function(t){const n=a.cluster().size(e);m.nodeSize&&n.nodeSize(m.nodeSize);m.separation&&n.separation(m.separation);return n(t)}(i);case"tree":return function(t){const n=a.tree().size(e);m.nodeSize&&n.nodeSize(m.nodeSize);m.separation&&n.separation(m.separation);return n(t)}(i);default:return console.warn(`MintWaterfall: Unknown layout type '${r}', falling back to treemap`),h(i)}};return p.size=function(t){return arguments.length?(e=t,p):e},p.padding=function(e){return arguments.length?(t=e,p):t},p.paddingInner=function(e){return arguments.length?(o=e,p):o},p.paddingOuter=function(e){return arguments.length?(i=e,p):i},p.paddingTop=function(e){return arguments.length?(l=e,p):l},p.paddingRight=function(e){return arguments.length?(s=e,p):s},p.paddingBottom=function(e){return arguments.length?(c=e,p):c},p.paddingLeft=function(e){return arguments.length?(u=e,p):u},p.round=function(e){return arguments.length?(n=e,p):n},p.ratio=function(e){return arguments.length?(d=e,p):d},p.type=function(e){return arguments.length?(r=e,p):r},p.partitionOrientation=function(e){return arguments.length?(f.orientation=e,p):f.orientation},p.nodeSize=function(e){return arguments.length?(m.nodeSize=e,p):m.nodeSize},p.separation=function(e){return arguments.length?(m.separation=e,p):m.separation},p},e.createHierarchicalLayoutSystem=W,e.createPerformanceManager=d,e.createRevenueWaterfall=function(e,t,n="revenue"){return A.createMultiDimensionalWaterfall(e,t,n)},e.createScaleSystem=r,e.createSequentialScale=m,e.createShapeGenerators=y,e.createStatisticalSystem=E,e.createTemporalWaterfall=function(e,t,n,r="month"){const o={day:a.timeDay,week:a.timeWeek,month:a.timeMonth,quarter:a.timeMonth.every(3),year:a.timeYear};return A.aggregateByTime(e,{timeAccessor:e=>new Date(e[t]),valueAccessor:e=>e[n]||0,interval:o[r],aggregation:"sum"})},e.createTooltipSystem=c,e.createVarianceWaterfall=function(e,t,n="actual",r="budget"){return e.map(e=>{const o=(e[n]||0)-(e[r]||0);return{label:e[t],stacks:[{value:o,color:o>=0?"#2ecc71":"#e74c3c",label:`Variance: ${o>=0?"+":""}${a.format(".2f")(o)}`}]}})},e.createVirtualWaterfallRenderer=function(e,t){const n=I(),a=n.createVirtualScrollManager(t),r=n.createPerformanceMonitor();return{virtualScrollManager:a,performanceMonitor:r,render:function(e,t){r.startTiming("render"),a.getVirtualizedData(e,t),r.endTiming("render"),r.trackFrameRate()}}},e.createWaterfallBubbles=function(e,t,n,r){const o=W(),i=o.transformWaterfallToHierarchy(e),l={width:n,height:r,padding:3,colorScale:a.scaleOrdinal(a.schemePastel1),sizeAccessor:e=>Math.abs(e.value||0)},s=o.createPackLayout(i,l);o.renderPack(t,s,l)},e.createWaterfallColorScale=g,e.createWaterfallConfidenceBands=b,e.createWaterfallDragBehavior=function(e,t){return{enabled:!0,axis:"vertical",constraints:{minValue:t?.min,maxValue:t?.max,snapToGrid:!0,gridSize:100},onDrag:(t,n)=>{e&&e(n,n.value)}}},e.createWaterfallForceConfig=function(e=1e3){return{enabled:!0,forces:{collision:!0,positioning:!0,centering:!1,links:!1},strength:{collision:.8,positioning:.6},duration:e}},e.createWaterfallMilestones=v,e.createWaterfallSequenceAnalyzer=function(e){const t=L(),n=t.analyzeSequence(e),a=[];let r=0;e.forEach((e,t)=>{const n=function(e){if("number"==typeof e)return e;if(void 0!==e.value)return e.value;if(e.stacks&&Array.isArray(e.stacks))return e.stacks.reduce((e,t)=>e+(t.value||0),0);return 0}(e);r+=n,a.push({step:t,cumulative:r,change:n})});const o=n.filter(e=>"large"===e.magnitude).map(e=>`${e.from}  ${e.to}`),i=t.suggestDataOptimizations(e);return{flowAnalysis:n,cumulativeFlow:a,criticalPaths:o,optimizationSuggestions:i}},e.createWaterfallSpatialIndex=function(e,t,n){const a=$();return e.forEach((e,r)=>{const o=(t(e.label)||0)+(t.bandwidth?t.bandwidth()/2:0),i=n(e.value)||0;a.add({x:o,y:i,data:e,index:r})}),a},e.createWaterfallSunburst=function(e,t,n,r){const o=W(),i=o.transformWaterfallToHierarchy(e),l={width:n,height:r,innerRadius:40,type:"sunburst",colorScale:a.scaleOrdinal(a.schemeCategory10)},s=o.createPartitionLayout(i,l);o.renderPartition(t,s,l)},e.createWaterfallTickGenerator=function(e,t){const n=L().generateCustomTicks(e,{count:8,nice:!0,includeZero:!0,threshold:Math.abs(e[1]-e[0])/100}),a=n.map(e=>0===e?"0":Math.abs(e)>=1e6?`${(e/1e6).toFixed(1)}M`:Math.abs(e)>=1e3?`${(e/1e3).toFixed(1)}K`:e.toFixed(0)),r=n.filter(n=>t.some(t=>Math.abs(function(e){if("number"==typeof e)return e;if(void 0!==e.value)return e.value;if(e.stacks&&Array.isArray(e.stacks))return e.stacks.reduce((e,t)=>e+(t.value||0),0);return 0}(t)-n)<Math.abs(e[1]-e[0])/50));return{ticks:n,labels:a,keyMarkers:r}},e.createWaterfallTreemap=function(e,t,n,r){const o=W(),i=o.transformWaterfallToHierarchy(e),l={width:n,height:r,padding:2,tile:a.treemapBinary,round:!0,colorScale:a.scaleOrdinal(a.schemeSet3)},s=o.createTreemapLayout(i,l);o.renderTreemap(t,s,l)},e.createWaterfallVoronoiConfig=function(e,t,n){return{enabled:!0,extent:[[n.left,n.top],[e-n.right,t-n.bottom]],showCells:!1,cellOpacity:.1}},e.createZoomSystem=u,e.d3DataUtils=T,e.dataProcessor=A,e.default=k,e.financialReducers=C,e.getConditionalColor=p,e.getEnhancedColorPalette=function(e=10,t="default",n="sequential"){const r=f[t]||f.default,o="diverging"===n?r.divergingScale?.interpolator||a.interpolateRdYlBu:r.sequentialScale?.interpolator||a.interpolateBlues;return Array.from({length:e},(t,n)=>o(n/(e-1)))},e.groupWaterfallData=function(e,t,n,r){const o=A.flatRollupBy(e,e=>a.sum(e,n),...t),i=["#3498db","#2ecc71","#f39c12","#e74c3c","#9b59b6","#1abc9c","#34495e","#95a5a6"];return o.map((t,n)=>{const o=t.slice(0,-1),l=t[t.length-1];return{label:r&&e[0]?o.map((t,n)=>`${Object.keys(e[0])[n]}: ${t}`).join(" | "):o.join("  "),stacks:[{value:l,color:i[n%i.length],label:`${l>=0?"+":""}${a.format(".2f")(l)}`}]}})},e.interpolateThemeColor=function(e,t,n="default",r="sequential"){const o=f[n]||f.default;if("diverging"===r){const n=Math.max(Math.abs(t[0]),Math.abs(t[1]));return(o.divergingScale?.interpolator||a.interpolateRdYlBu)((e/n+1)/2)}{const n=o.sequentialScale?.interpolator||a.interpolateBlues,r=(e-t[0])/(t[1]-t[0]);return n(Math.max(0,Math.min(1,r)))}},e.themes=f,e.transformTransactionData=function(e,t,n,r="amount",o){if(n)return A.createBreakdownWaterfall(e,t,n,r);{const n=A.rollupBy(e,e=>a.sum(e,e=>e[r]||0),e=>e[t]),o=["#3498db","#2ecc71","#f39c12","#e74c3c","#9b59b6"];let i=0;return Array.from(n.entries()).map(([e,t])=>({label:String(e),stacks:[{value:t,color:o[i++%o.length],label:`${t>=0?"+":""}${a.format(".2f")(t)}`}]}))}},e.version="0.8.6",e.waterfallChart=k,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=mintwaterfall.min.js.map
