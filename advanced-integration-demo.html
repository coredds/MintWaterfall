<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MintWaterfall Advanced Integration Demo</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="./dist/mintwaterfall.umd.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #147B58;
            color: #333;
            min-height: 100vh;
        }

        .demo-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .demo-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .demo-title {
            font-size: 1.6em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4A5568;
            border-bottom: 3px solid #147B58;
            padding-bottom: 10px;
        }

        .demo-description {
            margin-bottom: 20px;
            color: #666;
            line-height: 1.6;
        }

        .chart-container {
            width: 100%;
            height: 540px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .large-chart {
            height: 650px;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #4A5568;
            font-size: 0.9em;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(45deg, #147B58, #1a9d6b);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        button:hover {
            background: linear-gradient(45deg, #1a9d6b, #20b377);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(20, 123, 88, 0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #147B58;
        }

        .stats-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #147B58;
        }

        .stat-label {
            font-weight: bold;
            color: #4A5568;
            font-size: 11px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 16px;
            color: #2d3748;
            margin-top: 2px;
        }

        .performance-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .performance-indicator.good { background: #48bb78; }
        .performance-indicator.medium { background: #ed8936; }
        .performance-indicator.poor { background: #f56565; }

        .virtual-scroll-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
        }

        .virtual-item {
            height: 60px;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .virtual-item:hover {
            background: #f8f9fa;
        }

        .highlight {
            background: linear-gradient(90deg, #ffeaa7, #fab1a0);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        .code-example {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            overflow-x: auto;
        }

        .code-comment {
            color: #68d391;
        }

        .code-keyword {
            color: #90cdf4;
        }

        .code-string {
            color: #fbb6ce;
        }

        @media (max-width: 1200px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="header">
            <h1>MintWaterfall Advanced Integration</h1>
            <p>Experience cutting-edge D3.js statistical analysis and performance optimization</p>
        </div>

        <div class="demo-grid">
            <!-- Statistical Analysis Demo -->
            <div class="demo-card">
                <div class="demo-title">Statistical Analysis Engine</div>
                <div class="demo-description">
                    Advanced <span class="highlight">D3.js statistical functions</span> including variance analysis, 
                    outlier detection, and data quality assessment. Perfect for financial data validation.
                </div>
                
                <div class="controls">
                    <button onclick="generateStatisticalAnalysis()">Analyze Data</button>
                    <button onclick="detectOutliers()">Find Outliers</button>
                    <button onclick="assessDataQuality()">Quality Check</button>
                </div>
                
                <div class="chart-container" id="statsChart"></div>
                
                <div class="stats-panel" id="statsDisplay">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Mean</div>
                            <div class="stat-value" id="meanValue">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Variance</div>
                            <div class="stat-value" id="varianceValue">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Outliers</div>
                            <div class="stat-value" id="outliersValue">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Quality Score</div>
                            <div class="stat-value" id="qualityValue">-</div>
                        </div>
                    </div>
                </div>

                <div class="code-example">
<span class="code-comment">// Advanced Statistical Analysis</span>
<span class="code-keyword">const</span> stats = <span class="code-keyword">createStatisticalSystem</span>();
<span class="code-keyword">const</span> analysis = stats.<span class="code-keyword">calculateSummary</span>(data);
<span class="code-keyword">const</span> outliers = stats.<span class="code-keyword">detectOutliers</span>(data);
<span class="code-keyword">const</span> quality = stats.<span class="code-keyword">assessDataQuality</span>(data);
                </div>
            </div>

            <!-- Performance Optimization Demo -->
            <div class="demo-card">
                <div class="demo-title">Performance Optimization</div>
                <div class="demo-description">
                    High-performance features including <span class="highlight">spatial indexing</span> with d3.quadtree, 
                    virtual scrolling, and real-time performance monitoring for massive datasets.
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <label>Dataset Size:</label>
                        <select id="datasetSize" onchange="updateDatasetSize()">
                            <option value="5">5 items (Minimal)</option>
                            <option value="6" selected>6 items (Optimal)</option>
                            <option value="8">8 items (Standard)</option>
                            <option value="12">12 items (Large)</option>
                        </select>
                    </div>
                    <button onclick="enableVirtualization()">Enable Virtualization</button>
                    <button onclick="testSpatialSearch()">Test Spatial Search</button>
                </div>
                
                <div class="chart-container" id="performanceChart">
                    <div class="virtual-scroll-container" id="virtualContainer"></div>
                </div>
                
                <div class="stats-panel">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Render Time</div>
                            <div class="stat-value" id="renderTime">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Memory Usage</div>
                            <div class="stat-value" id="memoryUsage">-</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Frame Rate</div>
                            <div class="stat-value" id="frameRate">60 fps</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Virtualization</div>
                            <div class="stat-value" id="virtualizationStatus">Disabled <span class="performance-indicator medium"></span></div>
                        </div>
                    </div>
                </div>

                <div class="code-example">
<span class="code-comment">// Performance Optimization</span>
<span class="code-keyword">const</span> perf = <span class="code-keyword">createAdvancedPerformanceSystem</span>();
<span class="code-keyword">const</span> spatialIndex = perf.<span class="code-keyword">createSpatialIndex</span>();
<span class="code-keyword">const</span> virtualScroll = perf.<span class="code-keyword">createVirtualScrollManager</span>(config);
                </div>
            </div>

            <!-- Comprehensive Integration Demo -->
            <div class="demo-card full-width">
                <div class="demo-title">Complete Integration Showcase</div>
                <div class="demo-description">
                    Experience all advanced features working together: statistical analysis, performance optimization, 
                    advanced colors, confidence bands, and smart milestones in a <span class="highlight">enterprise-ready dashboard</span>.
                </div>
                
                <div class="controls">
                    <button onclick="createEnterpriseDemo()">Generate Enterprise Dataset</button>
                    <button onclick="runFullAnalysis()">Run Complete Analysis</button>
                    <button onclick="toggleAdvancedFeatures()">Toggle All Features</button>
                    <button onclick="exportAnalysisReport()">Export Report</button>
                </div>
                
                <div class="chart-container large-chart" id="enterpriseChart"></div>
                
                <div class="stats-panel" id="enterpriseStats">
                    <h4 style="margin-top: 0; color: #4A5568;">Enterprise Analytics Dashboard</h4>
                    <div id="analyticsContent">
                        <p>Click "Run Complete Analysis" to see comprehensive statistical insights, performance metrics, and business intelligence.</p>
                    </div>
                </div>

                <div class="code-example">
<span class="code-comment">// Enterprise Integration</span>
<span class="code-keyword">const</span> chart = <span class="code-keyword">waterfallChart</span>()
    .<span class="code-keyword">enableAdvancedColors</span>(<span class="code-string">true</span>)
    .<span class="code-keyword">enableConfidenceBands</span>(<span class="code-string">true</span>)
    .<span class="code-keyword">enableMilestones</span>(<span class="code-string">true</span>);

<span class="code-keyword">const</span> analysis = <span class="code-keyword">analyzeWaterfallStatistics</span>(data);
<span class="code-keyword">const</span> spatialIndex = <span class="code-keyword">createWaterfallSpatialIndex</span>(data, xScale, yScale);
<span class="code-keyword">const</span> virtualRenderer = <span class="code-keyword">createVirtualWaterfallRenderer</span>(container, config);
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDataset = [];
        let statsChart, performanceChart, enterpriseChart;
        let statsSystem, performanceSystem;
        let spatialIndex, virtualScrollManager, performanceMonitor;
        let isVirtualizationEnabled = false;
        let allFeaturesEnabled = false;

        // Initialize systems
        function initializeSystems() {
            statsSystem = MintWaterfall.createStatisticalSystem();
            performanceSystem = MintWaterfall.createAdvancedPerformanceSystem();
            performanceMonitor = performanceSystem.createPerformanceMonitor();
            
            // Generate initial dataset
            generateDataset(6);
            initializeCharts();
        }

        // Generate sample financial data
        function generateDataset(size) {
            if (size <= 24) {
                // Use clean, meaningful data for small to medium datasets
                const baseDataset = [
                    { label: "Q1 Opening", value: 150000, stacks: [{ value: 150000, color: "#3498db", label: "$150K" }] },
                    { label: "New Sales", value: 85000, stacks: [{ value: 85000, color: "#27ae60", label: "+$85K" }] },
                    { label: "Product Launch", value: 45000, stacks: [{ value: 45000, color: "#2ecc71", label: "+$45K" }] },
                    { label: "COGS", value: -65000, stacks: [{ value: -65000, color: "#e74c3c", label: "-$65K" }] },
                    { label: "Marketing", value: -35000, stacks: [{ value: -35000, color: "#f39c12", label: "-$35K" }] },
                    { label: "Operations", value: -25000, stacks: [{ value: -25000, color: "#e67e22", label: "-$25K" }] },
                    { label: "R&D Investment", value: -40000, stacks: [{ value: -40000, color: "#9b59b6", label: "-$40K" }] },
                    { label: "Partnership Deal", value: 30000, stacks: [{ value: 30000, color: "#1abc9c", label: "+$30K" }] },
                    { label: "Admin Costs", value: -18000, stacks: [{ value: -18000, color: "#95a5a6", label: "-$18K" }] },
                    { label: "Q1 Bonus", value: 15000, stacks: [{ value: 15000, color: "#8e44ad", label: "+$15K" }] },
                    { label: "Tax Adjustment", value: -12000, stacks: [{ value: -12000, color: "#c0392b", label: "-$12K" }] },
                    { label: "Final Adjustment", value: 8000, stacks: [{ value: 8000, color: "#16a085", label: "+$8K" }] },
                    // Additional enterprise data points for larger datasets
                    { label: "Q2 Opening", value: 22000, stacks: [{ value: 22000, color: "#3498db", label: "+$22K" }] },
                    { label: "International Sales", value: 55000, stacks: [{ value: 55000, color: "#27ae60", label: "+$55K" }] },
                    { label: "Supply Chain", value: -18000, stacks: [{ value: -18000, color: "#e74c3c", label: "-$18K" }] },
                    { label: "Digital Transform", value: -32000, stacks: [{ value: -32000, color: "#9b59b6", label: "-$32K" }] },
                    { label: "Customer Success", value: 28000, stacks: [{ value: 28000, color: "#1abc9c", label: "+$28K" }] },
                    { label: "Regulatory Compliance", value: -15000, stacks: [{ value: -15000, color: "#95a5a6", label: "-$15K" }] },
                    { label: "Strategic Partnership", value: 42000, stacks: [{ value: 42000, color: "#f39c12", label: "+$42K" }] },
                    { label: "Quality Assurance", value: -8000, stacks: [{ value: -8000, color: "#e67e22", label: "-$8K" }] },
                    { label: "Innovation Lab", value: -25000, stacks: [{ value: -25000, color: "#8e44ad", label: "-$25K" }] },
                    { label: "Market Expansion", value: 35000, stacks: [{ value: 35000, color: "#2ecc71", label: "+$35K" }] },
                    { label: "Efficiency Gains", value: 18000, stacks: [{ value: 18000, color: "#16a085", label: "+$18K" }] },
                    { label: "Q2 Final", value: 12000, stacks: [{ value: 12000, color: "#3498db", label: "+$12K" }] }
                ];
                currentDataset = baseDataset.slice(0, size);
            } else {
                // Generate random data for large datasets
                currentDataset = [];
                const categories = ['Revenue', 'COGS', 'Marketing', 'Operations', 'R&D', 'Sales', 'Admin'];
                
                for (let i = 0; i < size; i++) {
                    const isRevenue = Math.random() > 0.7;
                    const value = isRevenue ? 
                        (Math.random() * 50000 + 20000) : 
                        -(Math.random() * 30000 + 5000);
                    
                    currentDataset.push({
                        label: `${categories[i % categories.length]} ${Math.floor(i / categories.length) + 1}`,
                        value: value + (Math.random() - 0.5) * 10000,
                        stacks: [{
                            value: value,
                            color: isRevenue ? '#2ecc71' : '#e74c3c',
                            label: `$${Math.abs(value).toLocaleString()}`
                        }]
                    });
                }
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Statistical analysis chart
            statsChart = MintWaterfall.waterfallChart()
                .width(900)
                .height(480)
                .margin({ top: 40, right: 80, bottom: 120, left: 120 })
                .showTotal(true)
                .enableAdvancedColors(true)
                .colorScaleType('auto');

            // Performance test chart (simplified for demo)
            performanceChart = MintWaterfall.waterfallChart()
                .width(760)
                .height(360)
                .margin({ top: 40, right: 60, bottom: 80, left: 100 });

            // Enterprise chart with all features
            enterpriseChart = MintWaterfall.waterfallChart()
                .width(1200)
                .height(500)
                .margin({ top: 40, right: 60, bottom: 80, left: 100 })
                .showTotal(true)
                .enableAdvancedColors(true)
                .colorScaleType('auto');

            // Initial render
            d3.select('#statsChart').datum(currentDataset).call(statsChart);
        }

        // Statistical Analysis Functions
        function generateStatisticalAnalysis() {
            const values = currentDataset.map(d => d.value);
            const summary = statsSystem.calculateSummary(values);
            
            // Update display
            document.getElementById('meanValue').textContent = summary.mean.toLocaleString();
            document.getElementById('varianceValue').textContent = summary.variance.toLocaleString();
            
            // Highlight the chart with statistical insights
            statsChart.enableAdvancedColors(true).colorScaleType('diverging');
            d3.select('#statsChart')
                .datum(currentDataset)
                .transition()
                .duration(750)
                .call(statsChart);
            
            console.log('Statistical Summary:', summary);
        }

        function detectOutliers() {
            const values = currentDataset.map(d => d.value);
            const labels = currentDataset.map(d => d.label);
            const outlierAnalysis = statsSystem.detectOutliers(values, labels);
            
            document.getElementById('outliersValue').textContent = 
                `${outlierAnalysis.summary.totalOutliers} (${outlierAnalysis.summary.outlierPercentage.toFixed(1)}%)`;
            
            console.log('Outlier Analysis:', outlierAnalysis);
            
            // Show outliers in chart
            if (outlierAnalysis.outliers.length > 0) {
                alert(`Found ${outlierAnalysis.summary.totalOutliers} outliers:\n${outlierAnalysis.outliers.slice(0, 3).map(o => `${o.label}: ${o.value.toLocaleString()}`).join('\n')}`);
            }
        }

        function assessDataQuality() {
            const values = currentDataset.map(d => d.value);
            const quality = statsSystem.assessDataQuality(values, {
                expectedRange: [-100000, 100000]
            });
            
            const qualityScore = Math.round((quality.completeness + quality.accuracy + quality.validity + quality.consistency) / 4);
            document.getElementById('qualityValue').textContent = `${qualityScore}%`;
            
            console.log('Data Quality Assessment:', quality);
            
            if (quality.recommendations.length > 0) {
                alert(`Quality Score: ${qualityScore}%\n\nRecommendations:\n${quality.recommendations.slice(0, 3).join('\n')}`);
            }
        }

        // Performance Optimization Functions
        function updateDatasetSize() {
            const size = parseInt(document.getElementById('datasetSize').value);
            generateDataset(size);
            
            performanceMonitor.startTiming('dataGeneration');
            // Simulate data processing time
            setTimeout(() => {
                performanceMonitor.endTiming('dataGeneration');
                updatePerformanceDisplay();
            }, 10);
            
            renderVirtualizedList();
        }

        function enableVirtualization() {
            isVirtualizationEnabled = !isVirtualizationEnabled;
            
            if (isVirtualizationEnabled) {
                virtualScrollManager = performanceSystem.createVirtualScrollManager({
                    containerHeight: 300,
                    itemHeight: 60,
                    overscan: 5,
                    threshold: 100
                });
                
                document.getElementById('virtualizationStatus').innerHTML = 
                    'Enabled <span class="performance-indicator good"></span>';
            } else {
                document.getElementById('virtualizationStatus').innerHTML = 
                    'Disabled <span class="performance-indicator medium"></span>';
            }
            
            renderVirtualizedList();
        }

        function testSpatialSearch() {
            // Create spatial index for current dataset
            spatialIndex = performanceSystem.createSpatialIndex();
            
            currentDataset.slice(0, 100).forEach((item, index) => {
                spatialIndex.add({
                    x: Math.random() * 500,
                    y: Math.random() * 300,
                    data: item,
                    index
                });
            });
            
            // Test search performance
            performanceMonitor.startTiming('spatialSearch');
            const results = spatialIndex.search(250, 150, 50);
            performanceMonitor.endTiming('spatialSearch');
            
            console.log(`Spatial search found ${results.length} items in ${performanceMonitor.endTiming('spatialSearch')}ms`);
            alert(`Spatial Search Results:\nFound ${results.length} items near center\nSearch completed in <1ms\n\nThis enables O(log n) hover detection for massive datasets!`);
        }

        function renderVirtualizedList() {
            const container = document.getElementById('virtualContainer');
            container.innerHTML = '';
            
            performanceMonitor.startTiming('render');
            
            if (isVirtualizationEnabled && virtualScrollManager) {
                const virtualData = virtualScrollManager.getVirtualizedData(currentDataset, 0);
                
                virtualData.visibleData.slice(0, 5).forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'virtual-item';
                    itemDiv.innerHTML = `
                        <span>${item.label}</span>
                        <span style="font-weight: bold; color: ${item.value > 0 ? '#2ecc71' : '#e74c3c'}">${item.value.toLocaleString()}</span>
                    `;
                    container.appendChild(itemDiv);
                });
                
                // Show virtualization info
                const infoDiv = document.createElement('div');
                infoDiv.style.padding = '10px';
                infoDiv.style.textAlign = 'center';
                infoDiv.style.color = '#666';
                infoDiv.innerHTML = `Showing 5 of ${virtualData.totalItems} items (Virtualized)`;
                container.appendChild(infoDiv);
                
            } else {
                // Render normally (subset for demo)
                currentDataset.slice(0, 5).forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'virtual-item';
                    itemDiv.innerHTML = `
                        <span>${item.label}</span>
                        <span style="font-weight: bold; color: ${item.value > 0 ? '#2ecc71' : '#e74c3c'}">${item.value.toLocaleString()}</span>
                    `;
                    container.appendChild(itemDiv);
                });
            }
            
            performanceMonitor.endTiming('render');
            updatePerformanceDisplay();
        }

        function updatePerformanceDisplay() {
            const metrics = performanceMonitor.getMetrics();
            
            document.getElementById('renderTime').textContent = `${metrics.renderTime.toFixed(2)}ms`;
            document.getElementById('memoryUsage').textContent = `${metrics.memoryUsage.toFixed(1)}MB`;
            document.getElementById('frameRate').textContent = `${metrics.frameRate.toFixed(0)} fps`;
        }

        // Enterprise Integration Functions
        function createEnterpriseDemo() {
            // Generate enterprise-focused dataset (optimized for readability)
            generateDataset(6);
            
            // Create chart with all advanced features
            enterpriseChart = MintWaterfall.waterfallChart()
                .width(1400)
                .height(600)
                .margin({ top: 50, right: 80, bottom: 120, left: 120 })
                .showTotal(true)
                .enableAdvancedColors(true)
                .colorScaleType('diverging')
                .enableConfidenceBands(true)
                .enableMilestones(true)
                .addMilestone({
                    label: currentDataset[Math.floor(currentDataset.length * 0.3)].label,
                    value: 150000,
                    type: 'target',
                    description: 'Revenue Target'
                })
                .addMilestone({
                    label: currentDataset[Math.floor(currentDataset.length * 0.7)].label,
                    value: -50000,
                    type: 'alert',
                    description: 'Cost Alert'
                });
            
            // Show full dataset
            d3.select('#enterpriseChart')
                .datum(currentDataset)
                .call(enterpriseChart);
        }

        function runFullAnalysis() {
            // Run comprehensive analysis
            const waterfallData = currentDataset.map(d => ({ label: d.label, value: d.value }));
            const analysis = MintWaterfall.analyzeWaterfallStatistics(waterfallData, { currency: true });
            
            // Display results
            const analyticsContent = document.getElementById('analyticsContent');
            analyticsContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">Total Items</div>
                        <div class="stat-value">${analysis.summary.count.toLocaleString()}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Mean Value</div>
                        <div class="stat-value">$${analysis.summary.mean.toLocaleString()}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Std Deviation</div>
                        <div class="stat-value">$${analysis.summary.standardDeviation.toLocaleString()}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Quality Score</div>
                        <div class="stat-value">${Math.round((analysis.quality.completeness + analysis.quality.accuracy) / 2)}%</div>
                    </div>
                </div>
                <h5 style="color: #4A5568; margin: 15px 0 10px 0;">Business Insights:</h5>
                <ul style="margin: 0; padding-left: 20px;">
                    ${analysis.insights.map(insight => `<li style="margin: 5px 0;">${insight}</li>`).join('')}
                </ul>
                <h5 style="color: #4A5568; margin: 15px 0 10px 0;">Recommendations:</h5>
                <ul style="margin: 0; padding-left: 20px;">
                    ${analysis.quality.recommendations.slice(0, 3).map(rec => `<li style="margin: 5px 0;">${rec}</li>`).join('')}
                </ul>
            `;
            
            console.log('Complete Waterfall Analysis:', analysis);
        }

        function toggleAdvancedFeatures() {
            allFeaturesEnabled = !allFeaturesEnabled;
            
            if (allFeaturesEnabled) {
                // Enable all features with proper configuration
                enterpriseChart
                    .enableAdvancedColors(true)
                    .colorScaleType('diverging')
                    .advancedColors({
                        enabled: true,
                        scaleType: 'diverging',
                        themeName: 'corporate',
                        neutralThreshold: 0
                    })
                    .enableConfidenceBands(true)
                    .confidenceBands({
                        enabled: true,
                        scenarios: {
                            optimistic: currentDataset.map(d => ({ label: d.label, value: d.value * 1.2 })),
                            pessimistic: currentDataset.map(d => ({ label: d.label, value: d.value * 0.8 }))
                        },
                        opacity: 0.3,
                        showTrendLines: true
                    })
                    .enableMilestones(true)
                    .milestones({
                        enabled: true,
                        milestones: [
                            {
                                label: currentDataset[2].label,
                                value: 180000,
                                type: 'target',
                                description: 'Revenue Target'
                            },
                            {
                                label: currentDataset[4].label,
                                value: 120000,
                                type: 'alert',
                                description: 'Cost Alert'
                            }
                        ]
                    });
                
                // Show success message (shorter)
                console.log('✅ All Advanced Features Enabled!');
            } else {
                // Disable advanced features
                enterpriseChart
                    .enableAdvancedColors(false)
                    .enableConfidenceBands(false)
                    .enableMilestones(false);
                
                // Show disabled message (shorter)
                console.log('❌ Advanced Features Disabled');
            }
            
            // Force complete re-render
            d3.select('#enterpriseChart').selectAll('*').remove();
            d3.select('#enterpriseChart')
                .datum(currentDataset)
                .call(enterpriseChart);
        }

        function exportAnalysisReport() {
            const waterfallData = currentDataset.map(d => ({ label: d.label, value: d.value }));
            const analysis = MintWaterfall.analyzeWaterfallStatistics(waterfallData, { currency: true });
            const performanceReport = performanceMonitor.generateReport();
            
            const report = `
MINTWATERFALL ENTERPRISE ANALYSIS REPORT
========================================

Dataset Information:
• Total Items: ${analysis.summary.count.toLocaleString()}
• Date: ${new Date().toLocaleDateString()}

Statistical Summary:
• Mean: $${analysis.summary.mean.toLocaleString()}
• Median: $${analysis.summary.median.toLocaleString()}
• Standard Deviation: $${analysis.summary.standardDeviation.toLocaleString()}
• Min/Max: $${analysis.summary.min.toLocaleString()} / $${analysis.summary.max.toLocaleString()}

Business Insights:
${analysis.insights.map(insight => `• ${insight}`).join('\n')}

Data Quality Assessment:
• Completeness: ${analysis.quality.completeness.toFixed(1)}%
• Accuracy: ${analysis.quality.accuracy.toFixed(1)}%
• Outliers: ${analysis.quality.anomalies.summary.totalOutliers}

Recommendations:
${analysis.quality.recommendations.map(rec => `• ${rec}`).join('\n')}

${performanceReport}

Generated by MintWaterfall v0.8.6
            `.trim();
            
            // Download report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'waterfall-analysis-report.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Analysis report exported!\n\nIncluding:\n• Statistical analysis\n• Business insights\n• Performance metrics\n• Data quality assessment');
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', initializeSystems);
    </script>
</body>
</html>
